<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>框架之资源加载 | 持续学习者————Just Do It！</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本篇我们实现unity里的加载模块，他的主要功能是，业务传入资源名字和资源类型，加载模块加载到对应的资源后返回给业务，业务不需要关心该资源是从本地加载还是从AssetBundle里加载。 加载模块分两部分1.各资源的加载器，例如ab包加载器、Asset加载器、网络下载。2.各加载器的管理类，提供给业务的接口都在这里 需要支持的能力 1.能切换不同加载模式 开发阶段编辑器运行直接加载资源无需打ab包">
<meta property="og:type" content="article">
<meta property="og:title" content="框架之资源加载">
<meta property="og:url" content="http://droidman.net/2025/07/05/2025-07-05/index.html">
<meta property="og:site_name" content="持续学习者————Just Do It！">
<meta property="og:description" content="本篇我们实现unity里的加载模块，他的主要功能是，业务传入资源名字和资源类型，加载模块加载到对应的资源后返回给业务，业务不需要关心该资源是从本地加载还是从AssetBundle里加载。 加载模块分两部分1.各资源的加载器，例如ab包加载器、Asset加载器、网络下载。2.各加载器的管理类，提供给业务的接口都在这里 需要支持的能力 1.能切换不同加载模式 开发阶段编辑器运行直接加载资源无需打ab包">
<meta property="og:locale" content="en,ZH">
<meta property="article:published_time" content="2025-07-05T00:27:04.000Z">
<meta property="article:modified_time" content="2025-07-14T00:55:49.998Z">
<meta property="article:author" content="OuyangWenyuan">
<meta property="article:tag" content="unity">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="持续学习者————Just Do It！" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">持续学习者————Just Do It！</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">学无止境————不怕你不会，就怕你不学！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://droidman.net"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2025-07-05" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/05/2025-07-05/" class="article-date">
  <time datetime="2025-07-05T00:27:04.000Z" itemprop="datePublished">2025-07-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      框架之资源加载
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本篇我们实现unity里的加载模块，他的主要功能是，业务传入资源名字和资源类型，加载模块加载到对应的资源后返回给业务，业务不需要关心该资源是从本地加载还是从AssetBundle里加载。</p>
<p>加载模块分两部分1.各资源的加载器，例如ab包加载器、Asset加载器、网络下载。2.各加载器的管理类，提供给业务的接口都在这里</p>
<p>需要支持的能力</p>
<p>1.能切换不同加载模式 开发阶段编辑器运行直接加载资源无需打ab包,测试或正式发布阶段通过ab包加载资源</p>
<p>2.缓存机制 能定时清理长时间未使用的资源内存</p>
<p>3.既有同步加载 也有异步加载</p>
<p>复杂点：</p>
<p>1.根据业务传入的资源名字，获取到editor路径、ab包名字。需要事先根据资源名字保存资源的路径、ab包路径配置。</p>
<p>2.ab包的引用计数维护：加载时ReferencedCount+1，卸载时ReferencedCount-1。</p>
<p>两种引用：AB包之间的相互依赖，ab包加载时，依赖包引用计数加1，ab包卸载时，依赖包引用减1。2.资源引用，例如使用AssetBundle.LoadAsset加载资源时，该ab包引用计数加一，引用对象被删除时，引用计数减1.</p>
<p>问题是如何确保被删除的引用对象引用计数能正确减少。</p>
<p>有两种方式：</p>
<p>　　1.纯引用计数。ab包依赖和asset引用都使用引用计数。asset引用类型大概以下几种</p>
<p>　　1-1.预制体，额外封装一层，所有预制体的生成和销毁都由一个管理类统一管理。</p>
<p>例如封装一个ResourceItem类，所有预制体的生成和销毁都必须走这个类的的Create和Dispose类，在ctor方法里加载ab包、实例化预制体，在Dispose方法里Distory对象、卸载ab包（这里的加、卸载只是引用计数加1、减1）。需要业务手动的释放调用Dispose释放对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">-- 资源</span><br><span class="line">-- 所有非UI的预制加载</span><br><span class="line">local ResourceItem &#x3D; class(&quot;ResourceItem&quot;, ObjectBase)</span><br><span class="line"></span><br><span class="line">-- 静态创建ResourceItem接口</span><br><span class="line">-- path Data目录以下，预制的路径</span><br><span class="line">function ResourceItem.Create(target, filepath, parent, onLoaded, async)</span><br><span class="line">    local abpath &#x3D; PubFunc.GetAbNameOfPath(filepath)</span><br><span class="line">    local name &#x3D;  PubFunc.GetNameFromPath(filepath)</span><br><span class="line">    local item &#x3D; ResourceItem.new(filepath, abpath, name, parent, onLoaded, async)</span><br><span class="line">    target:AddSubItem(item)</span><br><span class="line">    return item</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function ResourceItem.CreateUIItem(target, abpath, name, parent, onLoaded, async)</span><br><span class="line">    local filepath &#x3D; abpath</span><br><span class="line">    if string.find(abpath, name)&#x3D;&#x3D;nil then</span><br><span class="line">        filepath &#x3D; abpath..name</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local item &#x3D; ResourceItem.new(filepath, abpath, name, parent, onLoaded, async)</span><br><span class="line">    target:AddSubItem(item)</span><br><span class="line">    return item</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function ResourceItem:ctor(filepath, abpath, name, parent, onLoaded, async)</span><br><span class="line">    ResourceItem.super.ctor(self)async &#x3D; async and true or false</span><br><span class="line"></span><br><span class="line">    self._filepath  &#x3D; filepath</span><br><span class="line">    self._path         &#x3D; abpath         -- 文件路径</span><br><span class="line">    self._name         &#x3D; name</span><br><span class="line">    self._parent    &#x3D; parent</span><br><span class="line">    self._onLoaded     &#x3D; onLoaded     -- 加载完回调</span><br><span class="line"></span><br><span class="line">    self.gameObject         &#x3D; nil         --外部可直接获取</span><br><span class="line">    self.transform             &#x3D; nil</span><br><span class="line"></span><br><span class="line">    self._loadKey &#x3D; me.modules.resource:CreateAsyn(abpath, name, handler(self, self.OnLoadComplete), async)</span><br><span class="line">end-- 清理</span><br><span class="line">function ResourceItem:Dispose()</span><br><span class="line">    if self.gameObject then</span><br><span class="line">        -- 销毁</span><br><span class="line">        me.modules.resource:Delete(self.gameObject)</span><br><span class="line">        self.gameObject &#x3D; nil</span><br><span class="line">        self.transform &#x3D; nil</span><br><span class="line">    elseif self._loadKey then</span><br><span class="line">        -- 取消加载</span><br><span class="line">        me.modules.resource:CancelLoad(self._loadKey)</span><br><span class="line">        self._loadKey &#x3D; nil</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    ResourceItem.super.Dispose(self)</span><br><span class="line">end-- 是否已加载</span><br><span class="line">function ResourceItem:IsLoaded()</span><br><span class="line">    return self.gameObject ~&#x3D; nil</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 加载完成回调</span><br><span class="line">function ResourceItem:OnLoadComplete(go)</span><br><span class="line">    self._loadKey    &#x3D; nil</span><br><span class="line">    local trans &#x3D; nil</span><br><span class="line"></span><br><span class="line">    if go then</span><br><span class="line">        trans &#x3D; go.transform</span><br><span class="line">        if self._parent then</span><br><span class="line">            go:SetParent(self._parent)</span><br><span class="line">        end</span><br><span class="line">        trans:SetLocalPositionZero()</span><br><span class="line">        trans:SetLocalScaleOne()</span><br><span class="line">    else</span><br><span class="line">        printError(&quot;加载RedourceItem失败，path:&quot;, self._path)</span><br><span class="line">    end</span><br><span class="line">    self.gameObject &#x3D; go</span><br><span class="line">    self.transform &#x3D; trans</span><br><span class="line"></span><br><span class="line">    -- 回调给外部</span><br><span class="line">    if self._onLoaded then</span><br><span class="line">        self._onLoaded(self)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">return ResourceItem</span><br></pre></td></tr></table></figure>
<p>你也可以在每个实例化的GameObject上挂在一个脚本，并在该脚本的Destory方法里卸载ab包的引用　　</p>
<p>1-2.场景类，这个比较简单，场景管理类肯定会记录当前的场景信息，在加载新场景时，先卸载当前的ab包就可以了。</p>
<p>1-3.sprite类，sprite是给image使用的，那么我们可以扩展一下Image的类。例如业务传入图片的名字，ImageEx类根据名字到LoadModule加载对应的ab及sprite并记录当前的sprite名字，当业务下次设置图片或Image对象被Destory时，根据保存的sprite名字卸载ab包。　　</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.UI;</span><br><span class="line">using Debugger &#x3D; LuaInterface.Debugger;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; image扩展，提供通过图片名字加载图片、从ab包、url、高清资源下载、emoji加载图片接口</span><br><span class="line">&#x2F;&#x2F;&#x2F; TP形Image. </span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class ImageEx : Image</span><br><span class="line">&#123;</span><br><span class="line">    private string m_SpriteName &#x3D; &quot;&quot;;</span><br><span class="line">    public string SpriteName</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_SpriteName;</span><br><span class="line">        &#125;</span><br><span class="line">        set</span><br><span class="line">        &#123;</span><br><span class="line">            m_SpriteName &#x3D; value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;protected override void OnDestroy()</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 销毁的时候要卸载一下ab</span><br><span class="line">        UnloadSprite();</span><br><span class="line">        StopCurrLoadingUrl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void UnloadSprite()</span><br><span class="line">    &#123;</span><br><span class="line">        if (!string.IsNullOrEmpty(SpriteName) &amp;&amp; sprite !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            SpriteModule.Instance.UnloadSpriteByName(SpriteName);</span><br><span class="line">            SpriteName &#x3D; null;</span><br><span class="line">            this.sprite &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;public void SetSpriteName(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        if (sprite !&#x3D; null &amp;&amp; SpriteName &#x3D;&#x3D; name)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UnloadSprite();</span><br><span class="line">        </span><br><span class="line">        if(string.IsNullOrEmpty(name))</span><br><span class="line">        &#123;</span><br><span class="line">            this.sprite &#x3D; null;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SpriteName &#x3D; name;</span><br><span class="line">        SpriteModule.Instance.LoadSpriteByName(name, onLoadedSprite);</span><br><span class="line">    &#125;private void onLoadedSprite(object obj)</span><br><span class="line">    &#123;</span><br><span class="line">        Sprite sp &#x3D; obj as Sprite;</span><br><span class="line">        this.sprite &#x3D; sp;</span><br><span class="line">        if (sp &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debugger.LogError(&quot;Load sprite null, name:&#123;0&#125;&quot;, m_SpriteUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if(!string.IsNullOrEmpty(m_strHdResName))</span><br><span class="line">            &#123;</span><br><span class="line">                sprite.name &#x3D; m_strHdResName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　1-4.shader类：全局就一个ab包，常驻内存就好了</p>
<p>　　1-5.音乐类：PlayMusic加载、StopMusic卸载就好了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 背景音乐</span><br><span class="line">    &#x2F;&#x2F; fromResources 是否从Resources文件夹下加载 </span><br><span class="line">    public void PlayMusic(string name, bool fromResources &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        if (string.IsNullOrEmpty(name)) return;</span><br><span class="line"></span><br><span class="line">        if (fromResources)</span><br><span class="line">        &#123;</span><br><span class="line">            if(MusicMute)</span><br><span class="line">            &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            AudioClip clip &#x3D; Resources.Load&lt;AudioClip&gt;(name);</span><br><span class="line">            if(clip !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                m_musicSource.enabled &#x3D; true;</span><br><span class="line">                m_musicSource.clip &#x3D; clip;</span><br><span class="line">                m_musicSource.loop &#x3D; true;</span><br><span class="line">                m_musicSource.Play();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            string strBundleName &#x3D; &quot;sound&#x2F;music&#x2F;&quot; +name;</span><br><span class="line">            LoadModule.Instance.LoadAssetFromBundle(strBundleName, name, typeof(AudioClip), (data) &#x3D;&gt; &#123;</span><br><span class="line">                m_musicSource.enabled &#x3D; true;</span><br><span class="line">                m_musicSource.clip &#x3D; data as AudioClip;</span><br><span class="line">                m_musicSource.loop &#x3D; true;</span><br><span class="line">                m_musicSource.Play();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 停止音乐并清理</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public void StopMusic()</span><br><span class="line">    &#123;</span><br><span class="line">        AudioClip m_musicClip &#x3D; m_musicSource.clip;</span><br><span class="line">        if (m_musicClip)</span><br><span class="line">        &#123;</span><br><span class="line">            m_musicSource.Stop();</span><br><span class="line">            m_musicSource.clip &#x3D; null;</span><br><span class="line"></span><br><span class="line">            string currentMusicName &#x3D; m_musicClip.name;</span><br><span class="line">            AssetBundleCache assetBundleCache &#x3D; ABCachePool.Instance.GetABCacheByName(string.Format(&quot;sound_music_&#123;0&#125;.unity3d&quot;, currentMusicName));</span><br><span class="line">            if (assetBundleCache !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                assetBundleCache.ReferencedCount &#x3D; 1;</span><br><span class="line">                LoadModule.Instance.UnloadAssetBundle(string.Format(&quot;sound&#x2F;music&#x2F;&#123;0&#125;&quot;, currentMusicName), true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　2.引用计数+弱引用。ab包依赖使用引用计数，asset引用使用弱引用，业务在加载asset时需要传入引用的对象（实例化就不用了，可以把实例化出来的GameObject当作引用对象），通过判断对象是否为空来判断引用关系。</p>
<p>　　强引用：我们实例化一个对象，直接引用了这个对象就是强引用。在这个对象被强引用的时，GC无法回收这个对象。只有当该对象所有的强引用都失去的时候，GC才会回收该对象。</p>
<p>　　弱引用：弱引用可以保持对对象的引用，同时允许GC在必要时释放对象，回收内存。这边一定要用弱引用，不然会影响对象的回收。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;System.WeakReference&gt; mReferenceOwnerList;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 为AB添加指定owner的引用</span><br><span class="line">&#x2F;&#x2F;&#x2F; 所有owner都销毁则ab引用计数归零可回收</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;owner&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">protected void retainOwner(UnityEngine.Object owner)</span><br><span class="line">&#123;</span><br><span class="line">   if (owner &#x3D;&#x3D; null)</span><br><span class="line">   &#123;</span><br><span class="line">       ResourceLogger.logErr(string.Format(&quot;引用对象不能为空!无法为资源:&#123;0&#125;添加引用!&quot;, AssetBundleName));</span><br><span class="line">       return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    foreach (var referenceowner in mReferenceOwnerList)</span><br><span class="line">    &#123;</span><br><span class="line">        if (owner.Equals(referenceowner))</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.WeakReference wr &#x3D; new System.WeakReference(owner);</span><br><span class="line">    mReferenceOwnerList.Add(wr);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 获取AB有效的引用对象计数</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">protected int updateOwnerReference()</span><br><span class="line">&#123;</span><br><span class="line">   for (int i &#x3D; 0; i &lt; mReferenceOwnerList.Count; i++)</span><br><span class="line">   &#123;</span><br><span class="line">        UnityEngine.Object o &#x3D; (UnityEngine.Object)mReferenceOwnerList[i].Target;</span><br><span class="line">        if (!o)</span><br><span class="line">        &#123;</span><br><span class="line">            mReferenceOwnerList.RemoveAt(i);</span><br><span class="line">            i--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return mReferenceOwnerList.Count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>第一种方式需要业务手动Dispose无用的对象，当然这是个好习惯，需要框架严格注意引用对象的管理。第二种需要业务在引用时传入引用的对象，需要额外的参数。</p>
<p>一个加载模块大致结构如下：</p>
<p>加载模块结构如上图，load为加载器，ResManager为提供给业务调用的接口，LoadModule为不使用ab包的加载接口，ABLoadModule为使用ab包的加载接口，这两个module对用户封闭。</p>
<p>AssetLoader：在editor模式下加载资源。AssetBundleLoader ：ab包加载器，负责从内存加载AssetBundle。BundleAssetLoader ：负责从指定的ab包加载资源。AssetBundleCache:缓存的ab包。</p>
<p>一、加载器实现</p>
<p>上篇我们有说到，unity有四种加载方式</p>
<p>1.AssetDatabase:在编辑器内加载卸载资源，并不能在游戏发布时使用，它只能在编辑器内使用。但是，它加载速度快，使用简单。</p>
<p>2.Resources：因为使用Resources文件夹无法热更，本片篇就不实现此途径了。</p>
<p>3.AssetBundle：支持热更，但是每次资源变化都得重新打ab包（奇慢），所以适合发布模式，但开发模式千万别用。</p>
<p>4.UnityWebRequest：从网络端下载</p>
<p>1.所有的加载器都继承自一个接口：Loader，该类定义了当前的加载类型、初始化、回收的重置方法、加载方法、加载进度回调等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">public class Loader</span><br><span class="line">&#123;</span><br><span class="line">    #region Define</span><br><span class="line">    public enum LoaderType</span><br><span class="line">    &#123;</span><br><span class="line">        STREAM,            &#x2F;&#x2F; 流(原则上可以是任何文件,包括远程服务器上的)</span><br><span class="line">        ASSET,            &#x2F;&#x2F; Asset目录下的资源</span><br><span class="line">        BUNDLE,            &#x2F;&#x2F; AssetBundle</span><br><span class="line">        BUNDLEASSET,    &#x2F;&#x2F; AssetBundle中的资源</span><br><span class="line">        SCENE,          &#x2F;&#x2F; 场景</span><br><span class="line">        Texture,        &#x2F;&#x2F; 图片</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum LoaderState</span><br><span class="line">    &#123;</span><br><span class="line">        NONE,            &#x2F;&#x2F; </span><br><span class="line">        LOADING,        &#x2F;&#x2F; 加载中</span><br><span class="line">        FINISHED,        &#x2F;&#x2F; 完成</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public delegate void ProgressHandle(Loader loader, float rate);</span><br><span class="line">    public delegate void LoadedHandle(Loader loader, object data);</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    protected Loader(LoaderType type)</span><br><span class="line">    &#123;</span><br><span class="line">        m_type &#x3D; type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected LoaderType m_type;            &#x2F;&#x2F; 加载器类型</span><br><span class="line">    protected LoaderState m_state;            &#x2F;&#x2F; 加载状态</span><br><span class="line">    protected string m_path;                &#x2F;&#x2F; 路径</span><br><span class="line">    protected bool m_async;                    &#x2F;&#x2F; 是否异步</span><br><span class="line"></span><br><span class="line">    protected ProgressHandle m_onProgress;    &#x2F;&#x2F; 加载进度</span><br><span class="line">    protected LoadedCallback m_onloaded;    &#x2F;&#x2F; 加载完成回调通知</span><br><span class="line"></span><br><span class="line">    protected System.Diagnostics.Stopwatch m_watch &#x3D; new System.Diagnostics.Stopwatch ();&#x2F;&#x2F;加载时间统计</span><br><span class="line"></span><br><span class="line">    public LoaderType Type &#123; get &#123; return m_type; &#125; &#125;</span><br><span class="line">    public string Path &#123; get &#123; return m_path; &#125; &#125;</span><br><span class="line">    public bool IsFinish &#123; get &#123; return m_state &#x3D;&#x3D; LoaderState.FINISHED; &#125; &#125;</span><br><span class="line">    public bool IsAsync &#123; get &#123; return m_async; &#125; &#125;</span><br><span class="line"></span><br><span class="line">　　&#x2F;&#x2F;主要用于ab包的判断，因为ab包需要等待依赖包的加载</span><br><span class="line">    public virtual bool IsPrepareToLoad()</span><br><span class="line">    &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化参数</span><br><span class="line">    public virtual void Init(string path, LoadedCallback onloaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        m_state &#x3D; LoaderState.NONE;</span><br><span class="line">        m_path &#x3D; path;</span><br><span class="line">        m_async &#x3D; async;</span><br><span class="line">        m_onloaded &#x3D; onloaded;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public virtual void Reset()</span><br><span class="line">    &#123;</span><br><span class="line">        m_path &#x3D; &quot;&quot;;</span><br><span class="line">        m_async &#x3D; true;</span><br><span class="line">        m_onloaded &#x3D; null;</span><br><span class="line">        m_state &#x3D; LoaderState.NONE;</span><br><span class="line">        m_onProgress &#x3D; null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Load()</span><br><span class="line">    &#123;</span><br><span class="line">        m_watch.Reset ();</span><br><span class="line">        m_watch.Start ();</span><br><span class="line">        m_state &#x3D; LoaderState.LOADING;</span><br><span class="line">        OnLoadProgress(0f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Stop()</span><br><span class="line">    &#123;</span><br><span class="line">        Reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected virtual void OnLoadProgress(float rate)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_onProgress !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_onProgress(this, rate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected virtual void OnLoadCompleted(object data)</span><br><span class="line">    &#123;</span><br><span class="line">        m_state &#x3D; LoaderState.FINISHED;</span><br><span class="line"></span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_onloaded!&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                m_onloaded (data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch(System.Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            LuaInterface.Debugger.LogError(e.Message);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        OnLoadProgress(1f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.editor模式下的加载，直接使用AssetDatabase加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public class AssetLoader : Loader</span><br><span class="line">&#123;</span><br><span class="line">    Object m_data &#x3D; null;</span><br><span class="line">    System.Type m_assetType &#x3D; null;        &#x2F;&#x2F;资源类型</span><br><span class="line"></span><br><span class="line">    public AssetLoader()</span><br><span class="line">        : base(Loader.LoaderType.ASSET)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Init (string path, System.Type type, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        base.Init (path, onLoaded, async);</span><br><span class="line">        m_assetType &#x3D; type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Load()</span><br><span class="line">    &#123;</span><br><span class="line">        base.Load();</span><br><span class="line"></span><br><span class="line">#if UNITY_EDITOR</span><br><span class="line">        if (m_assetType &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_assetType &#x3D; typeof(Object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_data &#x3D; UnityEditor.AssetDatabase.LoadAssetAtPath(m_path, m_assetType);</span><br><span class="line">        if (!m_async)</span><br><span class="line">        &#123;</span><br><span class="line">            OnLoadCompleted(m_data);</span><br><span class="line">        &#125;</span><br><span class="line">#else</span><br><span class="line">        if(!m_async)</span><br><span class="line">        &#123;</span><br><span class="line">            OnLoadCompleted(null);</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_state &#x3D;&#x3D; LoaderState.LOADING)</span><br><span class="line">        &#123;</span><br><span class="line">            OnLoadCompleted(m_data);</span><br><span class="line">            m_data &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.ab包的缓存可以参考我之前的文章：ab包的缓存</p>
<p>ab加载如下：当且仅当IsPrepareToLoad判断通过（即所有依赖包都加载完成）才能调用load方法，开始ab包的加载。InitDependencies方法用于初始化当前ab包的依赖项</p>
<p>load加载分两种，第一种是从扩展包加载，第二种是从本地加载。</p>
<p>ab包的加载无非就是同步和异步加载的区别，ab包的卸载也只需要调用Unload方法就好了。唯一需要注意的是，记载asset前必须保证ab的依赖包都加载完成了。</p>
<p>AssetBundleCache:缓存类，用于缓存ab包，提供从ab包加载asset的方法并缓存a包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line">public class AssetBundleCache</span><br><span class="line">&#123;</span><br><span class="line">    private string m_name;          &#x2F;&#x2F; AssetBundle name</span><br><span class="line">    private int m_referencedCount;  &#x2F;&#x2F; 引用计数</span><br><span class="line">    private float m_unloadTime;     &#x2F;&#x2F; 释放时间</span><br><span class="line"></span><br><span class="line">    private HashSet&lt;string&gt; m_setAllAssetNames &#x3D; null;&#x2F;&#x2F;ab包包含的所有asset的名字，用于判断指定asset是否存在于ab中</span><br><span class="line">    private Dictionary&lt;string, AssetBundleRequest&gt; m_dicAsync &#x3D; new Dictionary&lt;string, AssetBundleRequest&gt;();&#x2F;&#x2F;正在异步加载的asset</span><br><span class="line">    private Dictionary&lt;string, Object&gt; m_dicAssetCache &#x3D; null;&#x2F;&#x2F;已经加载完的asset</span><br><span class="line"></span><br><span class="line">    public AssetBundleCache(string name, AssetBundle ab, int refCount)</span><br><span class="line">    &#123;</span><br><span class="line">        m_name &#x3D; name;</span><br><span class="line">        Bundle &#x3D; ab;</span><br><span class="line">        ReferencedCount &#x3D; refCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; AssetBundle</span><br><span class="line">    public AssetBundle Bundle</span><br><span class="line">    &#123;</span><br><span class="line">        get;</span><br><span class="line">        private set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否常驻，通用资源的ab包不卸载</span><br><span class="line">    public bool Persistent</span><br><span class="line">    &#123;</span><br><span class="line">        get;</span><br><span class="line">        set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public string BundleName</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 引用计数</span><br><span class="line">    public int ReferencedCount</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_referencedCount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set</span><br><span class="line">        &#123;</span><br><span class="line">            m_referencedCount &#x3D; value;</span><br><span class="line">            if (m_referencedCount &lt;&#x3D; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                m_unloadTime &#x3D; Time.realtimeSinceStartup;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_unloadTime &#x3D; 0;</span><br><span class="line">            &#125;</span><br><span class="line">            if (m_referencedCount &lt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogWarningFormat(&quot;AssetBundleCache reference count &lt; 0, name:&#123;0&#125;, referencecount:&#123;1&#125;&quot;, m_name, m_referencedCount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否可以删除</span><br><span class="line">    public bool IsCanRemove</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; 常驻资源</span><br><span class="line">            if (Persistent) return false;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 非常驻，并且引用计数为0</span><br><span class="line">            if (!Persistent &amp;&amp; ReferencedCount &lt;&#x3D; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 缓存时间到</span><br><span class="line">    public bool IsTimeOut</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return Time.realtimeSinceStartup - m_unloadTime &gt;&#x3D; Config.Instance.AssetCacheTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 资源是否正在异步加载中</span><br><span class="line">    public bool IsAssetLoading(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        return m_dicAsync.ContainsKey(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;判断AB是否包含某个资源</span><br><span class="line">    public bool IsExistAsset(string strAssetName)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_setAllAssetNames !&#x3D; null &amp;&amp; m_setAllAssetNames.Contains(strAssetName))</span><br><span class="line">        &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 获取缓存中的资源</span><br><span class="line">    public Object GetCacheAsset(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_dicAssetCache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Object rst &#x3D; null;</span><br><span class="line">            if (m_dicAssetCache.TryGetValue(name, out rst))</span><br><span class="line">            &#123;</span><br><span class="line">                return rst;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 资源加载完 要缓存一下</span><br><span class="line">    public void OnLoadedAsset(string name, Object asset)</span><br><span class="line">    &#123;</span><br><span class="line">        m_unloadTime &#x3D; Time.realtimeSinceStartup;</span><br><span class="line"></span><br><span class="line">        if (m_dicAsync.ContainsKey(name))</span><br><span class="line">        &#123;</span><br><span class="line">            m_dicAsync.Remove(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 常驻ab加载进来的资源 用真实引用 不用弱引用</span><br><span class="line">        if (m_dicAssetCache &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_dicAssetCache &#x3D; new Dictionary&lt;string, Object&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        if (m_dicAssetCache.ContainsKey(name))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;警报! 缓存已经存在了还重新加载:&#123;0&#125;&quot;, name);</span><br><span class="line">        &#125;</span><br><span class="line">        m_dicAssetCache[name] &#x3D; asset;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;异步加载资源，需要添加到m_dicAsync里，防止重复加载</span><br><span class="line">    public AssetBundleRequest LoadAssetAsync(string name, System.Type type)</span><br><span class="line">    &#123;</span><br><span class="line">        if (Bundle &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;AssetBundle:&#123;0&#125; is null, load asset async:&#123;1&#125;,type:&#123;2&#125;, fail!!&quot;, m_name, name, type.ToString());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        AssetBundleRequest opt;</span><br><span class="line">        m_dicAsync.TryGetValue(name, out opt);</span><br><span class="line">        if (opt &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            opt &#x3D; Bundle.LoadAssetAsync(name, type);</span><br><span class="line">            m_dicAsync.Add(name, opt);</span><br><span class="line">        &#125;</span><br><span class="line">        return opt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;加载资源</span><br><span class="line">    public Object LoadAsset(string name, System.Type type)</span><br><span class="line">    &#123;</span><br><span class="line">        if (Bundle &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;AssetBundle:&#123;0&#125; is null, load asset:&#123;1&#125;,type:&#123;2&#125;, fail!!&quot;, m_name, name, type.ToString());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object asset &#x3D; Bundle.LoadAsset(name, type);</span><br><span class="line">        if (asset &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;AssetBuncleCache.LoadAsset, asset not exist:&#123;0&#125;, &#123;1&#125;&quot;, m_name, name);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            OnLoadedAsset(name, asset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return asset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;加载所有资源</span><br><span class="line">    public UnityEngine.Object[] LoadAllAssets(bool bCache &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        UnityEngine.Object[] allObjs &#x3D; Bundle.LoadAllAssets();</span><br><span class="line">        if (bCache)</span><br><span class="line">        &#123;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; allObjs.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Object obj &#x3D; allObjs[i];</span><br><span class="line">                OnLoadedAsset(obj.name, obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return allObjs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;异步加载所有资源 只用作预加载使用</span><br><span class="line">    public AssetBundleRequest LoadAllAssetsAsync()</span><br><span class="line">    &#123;</span><br><span class="line">        if (Bundle &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return Bundle.LoadAllAssetsAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool LoadAllAssetNames()</span><br><span class="line">    &#123;</span><br><span class="line">        if (Bundle &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        string[] arrNames &#x3D; Bundle.GetAllAssetNames();</span><br><span class="line">        if (arrNames.Length &#x3D;&#x3D; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        if (m_setAllAssetNames &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_setAllAssetNames &#x3D; new HashSet&lt;string&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (int i &#x3D; 0; i &lt; arrNames.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            string strName &#x3D; System.IO.Path.GetFileNameWithoutExtension(arrNames[i]);</span><br><span class="line">            m_setAllAssetNames.Add(strName);</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;卸载ab包</span><br><span class="line">    public void Unload()</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_dicAsync.Count &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;[仅提醒]该Bundle还有资源在加载中，暂时不卸载:&#123;0&#125;&quot;, m_name);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (Bundle !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            Bundle.Unload(false);</span><br><span class="line">            Bundle &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (m_setAllAssetNames !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_setAllAssetNames.Clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (m_dicAssetCache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_dicAssetCache.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ABCachePool：负责管理ab包的引用计数、缓存、获取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">public class ABCachePool</span><br><span class="line">&#123;</span><br><span class="line">    #region Instance</span><br><span class="line">    private static ABCachePool m_Instance;</span><br><span class="line">    public static ABCachePool Instance</span><br><span class="line">    &#123;</span><br><span class="line">        get &#123; return m_Instance ?? (m_Instance &#x3D; new ABCachePool()); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">    Dictionary&lt;string, AssetBundleCache&gt; m_AssetBundleCaches &#x3D; new Dictionary&lt;string, AssetBundleCache&gt;();  &#x2F;&#x2F; 缓存队列</span><br><span class="line">    HashSet&lt;string&gt; m_persistentABs &#x3D; new HashSet&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    public Dictionary&lt;string, AssetBundleCache&gt; AssetBundleCaches</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_AssetBundleCaches;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void ClearAllCache()</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (KeyValuePair&lt;string, AssetBundleCache&gt; keyval in m_AssetBundleCaches)</span><br><span class="line">        &#123;</span><br><span class="line">            keyval.Value.Unload();</span><br><span class="line">        &#125;</span><br><span class="line">        m_AssetBundleCaches.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsExistCache(string abName)</span><br><span class="line">    &#123;</span><br><span class="line">        return m_AssetBundleCaches.ContainsKey(abName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 引用这个bundle</span><br><span class="line">    public AssetBundleCache ReferenceCacheByName(string abName)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; null;</span><br><span class="line">        m_AssetBundleCaches.TryGetValue(abName, out cache);</span><br><span class="line">        if (cache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            ++cache.ReferencedCount;</span><br><span class="line">        &#125;</span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 获取ABCache 不增加引用</span><br><span class="line">    public AssetBundleCache GetABCacheByName(string abName)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; null;</span><br><span class="line">        m_AssetBundleCaches.TryGetValue(abName, out cache);</span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AssetBundleCache AddCache(string abName, AssetBundle bundle, int refCount)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_AssetBundleCaches.ContainsKey(abName))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;AssetBundleCache already contains key:&#123;0&#125;, it will be cover by new value.&quot;, abName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AssetBundleCache cache &#x3D; new AssetBundleCache(abName, bundle, refCount);</span><br><span class="line">        m_AssetBundleCaches[abName] &#x3D; cache;</span><br><span class="line"></span><br><span class="line">        if (m_persistentABs.Contains(abName))</span><br><span class="line">        &#123;</span><br><span class="line">            cache.Persistent &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; immediate 只有场景是立刻卸载</span><br><span class="line">    public AssetBundleCache UnReferenceCache(string abName, bool immediate &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; null;</span><br><span class="line">        if (!m_AssetBundleCaches.TryGetValue(abName, out cache))</span><br><span class="line">        &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (cache.Persistent)</span><br><span class="line">        &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        --cache.ReferencedCount;</span><br><span class="line"></span><br><span class="line">        if (immediate &amp;&amp; cache.IsCanRemove)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveCache(abName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void RemoveCache(string abName)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; m_AssetBundleCaches[abName];</span><br><span class="line">        cache.Unload();</span><br><span class="line">        m_AssetBundleCaches.Remove(abName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private List&lt;string&gt; m_lstRm &#x3D; new List&lt;string&gt;();</span><br><span class="line">    &#x2F;&#x2F; 清除无引用的AssetBundle缓存</span><br><span class="line">    public void ClearNoneRefCache(bool mustTimeout)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (KeyValuePair&lt;string, AssetBundleCache&gt; keyval in m_AssetBundleCaches)</span><br><span class="line">        &#123;</span><br><span class="line">            AssetBundleCache item &#x3D; keyval.Value;</span><br><span class="line">            &#x2F;&#x2F; 只清除引用计数为0的</span><br><span class="line">            if (item.IsCanRemove &amp;&amp; (!mustTimeout || item.IsTimeOut))</span><br><span class="line">            &#123;</span><br><span class="line">                m_lstRm.Add(keyval.Key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_lstRm.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveCache(m_lstRm[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        m_lstRm.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 常驻ab包设置</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;arrAB&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    public void SetPersistentABs(string[] arrAB)</span><br><span class="line">    &#123;</span><br><span class="line">        m_persistentABs.Clear();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; arrAB.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            string strAB &#x3D; arrAB[i];&#x2F;&#x2F;FileHelper.GenBundlePath(arrAB[i]);</span><br><span class="line">            m_persistentABs.Add(strAB);</span><br><span class="line"></span><br><span class="line">            AssetBundleCache abCache;</span><br><span class="line">            m_AssetBundleCaches.TryGetValue(strAB, out abCache);</span><br><span class="line">            if (abCache !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                abCache.Persistent &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BundleLoader：用于加载AssetBundle</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">public class BundleLoader : Loader</span><br><span class="line">&#123;</span><br><span class="line">    AssetBundleCreateRequest m_abRequest &#x3D; null;</span><br><span class="line"></span><br><span class="line">    private int m_iRefCount;                &#x2F;&#x2F; 当前等待此加载的引用计数</span><br><span class="line">    private List&lt;string&gt; m_lstDepAbNames &#x3D; new List&lt;string&gt;();  &#x2F;&#x2F;依赖的未加载Bundle名字列表</span><br><span class="line"></span><br><span class="line">    private LoadedCallback m_onABLoaded;</span><br><span class="line"></span><br><span class="line">    private string m_strBundleName;         &#x2F;&#x2F; 相对路径</span><br><span class="line">    public string BundleName &#123; get &#123; return m_strBundleName; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    System.Diagnostics.Stopwatch m_saveAbWatcher &#x3D; new System.Diagnostics.Stopwatch();</span><br><span class="line">    public BundleLoader()</span><br><span class="line">        : base(Loader.LoaderType.BUNDLE)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void AddLoadedCallback(LoadedCallback onloaded)</span><br><span class="line">    &#123;</span><br><span class="line">        m_onABLoaded +&#x3D; onloaded;</span><br><span class="line">        m_iRefCount +&#x3D; 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void AddReferenced()</span><br><span class="line">    &#123;</span><br><span class="line">        m_iRefCount +&#x3D; 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Reset()</span><br><span class="line">    &#123;</span><br><span class="line">        base.Reset();</span><br><span class="line"></span><br><span class="line">        m_iRefCount &#x3D; 0;</span><br><span class="line">        m_lstDepAbNames.Clear();</span><br><span class="line">        m_strBundleName &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        m_abRequest &#x3D; null;</span><br><span class="line">        m_onABLoaded &#x3D; null;</span><br><span class="line">        m_lstDepAbNames.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 判断是否所有依赖都已经加载</span><br><span class="line">    public override bool IsPrepareToLoad()</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; m_lstDepAbNames.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            string strABName &#x3D; m_lstDepAbNames[i];</span><br><span class="line">            if (ABCachePool.Instance.IsExistCache(strABName))</span><br><span class="line">            &#123;</span><br><span class="line">                m_lstDepAbNames.RemoveAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return m_lstDepAbNames.Count &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Init(string path, string strName, string[] dependencies, LoadedCallback onloaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; Bundle 比较特殊 不使用父类的回调</span><br><span class="line">        base.Init(path, null, async);</span><br><span class="line"></span><br><span class="line">        m_iRefCount &#x3D; 1;</span><br><span class="line">        m_strBundleName &#x3D; strName;</span><br><span class="line">        m_onABLoaded &#x3D; onloaded;</span><br><span class="line">        InitDependencies(dependencies);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void InitDependencies(string[] dependencies)</span><br><span class="line">    &#123;</span><br><span class="line">        if (dependencies &#x3D;&#x3D; null || dependencies.Length &#x3D;&#x3D; 0)</span><br><span class="line">            return;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; dependencies.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            string strName &#x3D; dependencies[i];</span><br><span class="line">            if (!ABCachePool.Instance.IsExistCache(strName))</span><br><span class="line">            &#123;</span><br><span class="line">                m_lstDepAbNames.Add(strName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Load()</span><br><span class="line">    &#123;</span><br><span class="line">        base.Load();</span><br><span class="line"></span><br><span class="line">        if (m_async)</span><br><span class="line">        &#123;</span><br><span class="line">            string path &#x3D; FileHelper.GetAPKPath(m_path);&#x2F;&#x2F;根据ab包的名字索引ab包的存储路劲</span><br><span class="line">            m_abRequest &#x3D; AssetBundle.LoadFromFileAsync(path);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            AssetBundle ab &#x3D; null;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F; 同步使用AssetBundle.LoadFromFile加载,速度最快</span><br><span class="line">                if (ab &#x3D;&#x3D; null)</span><br><span class="line">                &#123;</span><br><span class="line">                    string path &#x3D; FileHelper.GetAPKPath(m_path);&#x2F;&#x2F;根据ab包的名字索引ab包的存储路劲</span><br><span class="line">                    ab &#x3D; AssetBundle.LoadFromFile(path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (System.Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(e.Message);</span><br><span class="line">            &#125;</span><br><span class="line">            finally</span><br><span class="line">            &#123;</span><br><span class="line">                OnLoaded(ab);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_state &#x3D;&#x3D; LoaderState.LOADING)</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_abRequest !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                if (m_abRequest.isDone)</span><br><span class="line">                &#123;</span><br><span class="line">                    OnLoaded(m_abRequest.assetBundle);</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    DoProgress(m_abRequest.progress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void DoProgress(float rate)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void OnLoaded(AssetBundle ab)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; ABCachePool.Instance.AddCache(m_strBundleName, ab, m_iRefCount);</span><br><span class="line">        OnLoadCompleted(ab);</span><br><span class="line"></span><br><span class="line">        if (m_onABLoaded !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_onABLoaded(cache);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>二、缓存池,缓存加载器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public class LoaderPool</span><br><span class="line">&#123;</span><br><span class="line">    #region Instance</span><br><span class="line">    private static LoaderPool m_Instance;</span><br><span class="line">    public static LoaderPool Instance</span><br><span class="line">    &#123;</span><br><span class="line">        get &#123; return m_Instance ?? (m_Instance &#x3D; new LoaderPool()); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    List&lt;Loader&gt; m_bundleLoaderPool &#x3D; new List&lt;Loader&gt;();       &#x2F;&#x2F; BundleLoader的缓存</span><br><span class="line">    List&lt;Loader&gt; m_assetLoaderPool &#x3D; new List&lt;Loader&gt;();        &#x2F;&#x2F; BundleAssetLoader的缓存</span><br><span class="line"></span><br><span class="line">    public T GetLoader&lt;T&gt;() where T : Loader, new()</span><br><span class="line">    &#123;</span><br><span class="line">        System.Type type &#x3D; typeof(T);</span><br><span class="line">        T loader &#x3D; null;</span><br><span class="line">        if (type &#x3D;&#x3D; typeof(BundleLoader))</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_bundleLoaderPool.Count &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                loader &#x3D; (T)m_bundleLoaderPool[0];</span><br><span class="line">                m_bundleLoaderPool.RemoveAt(0);</span><br><span class="line">                return loader;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(BundleAssetLoader))</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_assetLoaderPool.Count &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                loader &#x3D; (T)m_assetLoaderPool[0];</span><br><span class="line">                m_assetLoaderPool.RemoveAt(0);</span><br><span class="line">                return loader;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loader &#x3D; new T();</span><br><span class="line"></span><br><span class="line">        return loader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void RecycleLoader(Loader loader)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        if (loader.GetType() &#x3D;&#x3D; typeof(BundleLoader))</span><br><span class="line">        &#123;</span><br><span class="line">            loader.Reset();</span><br><span class="line">            m_bundleLoaderPool.Add(loader);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (loader.GetType() &#x3D;&#x3D; typeof(BundleAssetLoader))</span><br><span class="line">        &#123;</span><br><span class="line">            loader.Reset();</span><br><span class="line">            m_assetLoaderPool.Add(loader);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            loader.Reset();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三、加载管理器LoadModule</p>
<p>1.ResManager ：提供给业务的接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public class ResManager</span><br><span class="line">&#123;</span><br><span class="line">    #region Instance</span><br><span class="line">    private static ResManager m_Instance;</span><br><span class="line">    public static ResManager Instance</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_Instance ?? (m_Instance &#x3D; new ResManager());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">    public int SyncCount &#x3D; 6;                               &#x2F;&#x2F; 同步加载并发数</span><br><span class="line"></span><br><span class="line">    private bool m_isUseAssetBundle;</span><br><span class="line">    private ILoadModule m_loadModule;</span><br><span class="line"></span><br><span class="line">    public void Init(bool isUseAssetBundle)</span><br><span class="line">    &#123;</span><br><span class="line">        m_isUseAssetBundle &#x3D; isUseAssetBundle;</span><br><span class="line">        if (isUseAssetBundle)</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadModule &#x3D; new ABLoadModule();</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadModule &#x3D; new LoadModule();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_loadModule.Init(SyncCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void UnInit()</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.UnInit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.Update(dt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        ABCachePool.Instance.ClearNoneRefCache(false);</span><br><span class="line"></span><br><span class="line">        Resources.UnloadUnusedAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadPrefab(string strPath, string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.LoadPrefab(strPath, name, onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadMusic(string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.LoadMusic(name, onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadFont(string name, LoadedCallback onLoaded, bool async &#x3D; true, bool inBundle &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.LoadFont(name, onLoaded, async, inBundle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.LoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.两种加载器的接口类ILoadModule</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public interface ILoadModule</span><br><span class="line">&#123;</span><br><span class="line">    void Init(int syncCout);</span><br><span class="line"></span><br><span class="line">    void UnInit();</span><br><span class="line"></span><br><span class="line">    void Update(float dt);</span><br><span class="line"></span><br><span class="line">    void LoadPrefab(string strPath, string name, LoadedCallback onLoaded, bool async &#x3D; true);</span><br><span class="line"></span><br><span class="line">    void LoadMusic(string name, LoadedCallback onLoaded, bool async &#x3D; true);</span><br><span class="line"></span><br><span class="line">    void LoadFont(string name, LoadedCallback onLoaded, bool async &#x3D; true, bool inBundle &#x3D; false);</span><br><span class="line"></span><br><span class="line">    void LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.editor模式下的加载器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 不使用ab加载资源（Editor模式下）</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class LoadModule : ILoadModule</span><br><span class="line">&#123;</span><br><span class="line">    public int SyncCount;                               &#x2F;&#x2F; 同步加载并发数</span><br><span class="line">    public HashSet&lt;string&gt; m_loadedBundleNames &#x3D; new HashSet&lt;string&gt;();</span><br><span class="line">    &#x2F;&#x2F; 加载队列</span><br><span class="line">    List&lt;Loader&gt; m_loadings &#x3D; new List&lt;Loader&gt;();&#x2F;&#x2F;正在加载</span><br><span class="line">    List&lt;Loader&gt; m_loaderQueue &#x3D; new List&lt;Loader&gt;();&#x2F;&#x2F;等待加载</span><br><span class="line"></span><br><span class="line">    float m_lastClear &#x3D; 0;  &#x2F;&#x2F; 上一次清除时间</span><br><span class="line"></span><br><span class="line">    public void Init(int syncCout)</span><br><span class="line">    &#123;</span><br><span class="line">        SyncCount &#x3D; syncCout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void UnInit()</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_loadings.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadings[i].Stop();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_loadings.Clear();</span><br><span class="line">        m_loaderQueue.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private List&lt;int&gt; m_lstRmTemp &#x3D; new List&lt;int&gt;();</span><br><span class="line">    public void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; m_loadings.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            Loader loader &#x3D; m_loadings[i];</span><br><span class="line">            loader.Update(dt);</span><br><span class="line">            if (loader.IsFinish)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loadings.RemoveAt(i);</span><br><span class="line">                LoaderPool.Instance.RecycleLoader(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int remain &#x3D; Mathf.Min(SyncCount - m_loadings.Count, m_loaderQueue.Count);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_loaderQueue.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Loader loader &#x3D; m_loaderQueue[i];</span><br><span class="line">            m_loadings.Add(loader);</span><br><span class="line">            loader.Load();</span><br><span class="line">            loader.Update(dt);</span><br><span class="line">            m_lstRmTemp.Add(i);</span><br><span class="line">            if (m_lstRmTemp.Count &gt;&#x3D; remain)</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (m_lstRmTemp.Count &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            for (int i &#x3D; m_lstRmTemp.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.RemoveAt(m_lstRmTemp[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            m_lstRmTemp.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        Resources.UnloadUnusedAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadPrefab(string strPath, string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        LoadAssetByPath(strPath, name, typeof(GameObject), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadMusic(string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        string path &#x3D; string.Format(&quot;music&#x2F;&#123;0&#125;&quot;, name);</span><br><span class="line">        LoadAssetByPath(path, name, typeof(AudioClip), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadFont(string name, LoadedCallback onLoaded, bool async &#x3D; true, bool inBundle &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        string path &#x3D; string.Format(&quot;ui&#x2F;font&#x2F;&#123;0&#125;&quot;, name);</span><br><span class="line">        LoadAssetByPath(path, name, typeof(Font), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #region LoadScene</span><br><span class="line">    public void LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded)</span><br><span class="line">    &#123;</span><br><span class="line">        var activeSceneName &#x3D; SceneManager.GetActiveScene().name;</span><br><span class="line">        &#x2F;&#x2F; 如果当前场景是要加载的场景 直接返回</span><br><span class="line">        if (activeSceneName &#x3D;&#x3D; name)</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(null);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (isAdditive)</span><br><span class="line">        &#123;</span><br><span class="line">            __LoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#x2F;&#x2F;大场景先加载idle过渡</span><br><span class="line">        &#123;</span><br><span class="line">            __LoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void __LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        SceneLoader sLoader &#x3D; LoaderPool.Instance.GetLoader&lt;SceneLoader&gt;();</span><br><span class="line">        sLoader.Init(name, scenePath, isAdditive, onLoaded, async);</span><br><span class="line">        StartLoad(sLoader, true);</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;从Bundle中加载资源</span><br><span class="line">    public void LoadAssetByPath(string path, string name, System.Type type, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        path &#x3D; &quot;Assets&#x2F;Data&#x2F;&quot; + path;</span><br><span class="line">        if (Directory.Exists(path))</span><br><span class="line">        &#123;</span><br><span class="line">            path +&#x3D; &quot;&#x2F;&quot; + name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string suffix &#x3D; GetSuffixOfAsset(type);</span><br><span class="line">        string fullPath &#x3D; string.Format(&quot;&#123;0&#125;.&#123;1&#125;&quot;, path, suffix);</span><br><span class="line">        LoadAsset(fullPath, onLoaded, type, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 加载资源(Assets目录下,带后缀)</span><br><span class="line">    public void LoadAsset(string path, LoadedCallback onLoaded, System.Type type &#x3D; null, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!File.Exists(path))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogErrorFormat(&quot;Load Asset, Path:[&#123;0&#125;] not exist!  &quot;, path);</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(null);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AssetLoader aLoader &#x3D; LoaderPool.Instance.GetLoader&lt;AssetLoader&gt;();</span><br><span class="line">        aLoader.Init(path, type, onLoaded, async);</span><br><span class="line">        StartLoad(aLoader, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void StartLoad(Loader loader, bool async, bool toHead &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 异步加载或者加载还未准备好，则当做异步处理，外部控制是否加入队列开头</span><br><span class="line">        &#x2F;&#x2F; 同步加载，并且已经具备加载条件，则直接调用Load进行加载</span><br><span class="line">        if (async || !loader.IsPrepareToLoad())</span><br><span class="line">        &#123;</span><br><span class="line">            if (toHead)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.Insert(0, loader);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.Add(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadings.Add(loader);</span><br><span class="line">            loader.Load();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载关卡场景</span><br><span class="line">    public void UnloadLevelScene(string sceneName, bool immediate)</span><br><span class="line">    &#123;</span><br><span class="line">        SceneManager.UnloadSceneAsync(sceneName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void CallFunc_LoadedBack(LoadedCallback callback, object data)</span><br><span class="line">    &#123;</span><br><span class="line">        if (callback !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            callback(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private string GetSuffixOfAsset(System.Type type)</span><br><span class="line">    &#123;</span><br><span class="line">        if (type &#x3D;&#x3D; typeof(Font))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;ttf&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(AudioClip))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;ogg&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(GameObject))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;prefab&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(TextAsset))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;bytes&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(Texture2D) || type &#x3D;&#x3D; typeof(Sprite))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;png&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.ab包加载模块：和LoadModule 相比，1.ABLoadModule 需要在初始化前加载manifest文件。2.需要在加载资源前加载ab包以及a包的依赖包。3.需要提供卸载ab包的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 使用ab加载资源（Editor模式下、线上平台）</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class ABLoadModule : ILoadModule</span><br><span class="line">&#123;</span><br><span class="line">    public int SyncCount;                               &#x2F;&#x2F; 同步加载并发数</span><br><span class="line">    private AssetBundleManifest m_manifest &#x3D; null;</span><br><span class="line">    private HashSet&lt;string&gt; m_bundleNames &#x3D; new HashSet&lt;string&gt;();</span><br><span class="line">    &#x2F;&#x2F; 加载队列</span><br><span class="line">    List&lt;Loader&gt; m_loadings &#x3D; new List&lt;Loader&gt;();&#x2F;&#x2F;正在加载</span><br><span class="line">    List&lt;Loader&gt; m_loaderQueue &#x3D; new List&lt;Loader&gt;();&#x2F;&#x2F;等待加载</span><br><span class="line">    Dictionary&lt;string, AssetBundleLoader&gt; m_dicAllLoader &#x3D; new Dictionary&lt;string, AssetBundleLoader&gt;();</span><br><span class="line"></span><br><span class="line">    float m_lastClear &#x3D; 0;  &#x2F;&#x2F; 上一次清除时间</span><br><span class="line"></span><br><span class="line">    public void Init(int syncCout)</span><br><span class="line">    &#123;</span><br><span class="line">        SyncCount &#x3D; syncCout;</span><br><span class="line">        LoadManifest();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void UnInit()</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_loadings.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadings[i].Stop();</span><br><span class="line">        &#125;</span><br><span class="line">        m_loadings.Clear();</span><br><span class="line"></span><br><span class="line">        m_loaderQueue.Clear();</span><br><span class="line">        ABCachePool.Instance.ClearAllCache();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private List&lt;int&gt; m_lstRmTemp &#x3D; new List&lt;int&gt;();</span><br><span class="line">    public void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; m_loadings.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            Loader loader &#x3D; m_loadings[i];</span><br><span class="line">            loader.Update(dt);</span><br><span class="line">            if (loader.IsFinish)</span><br><span class="line">            &#123;</span><br><span class="line">                if (loader.Type &#x3D;&#x3D; Loader.LoaderType.BUNDLE)</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetBundleLoader bLoader &#x3D; loader as AssetBundleLoader;</span><br><span class="line">                    if (m_dicAllLoader.ContainsKey(bLoader.BundleName))</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_dicAllLoader.Remove(bLoader.BundleName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                m_loadings.RemoveAt(i);</span><br><span class="line">                LoaderPool.Instance.RecycleLoader(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int remain &#x3D; Mathf.Min(SyncCount - m_loadings.Count, m_loaderQueue.Count) ;</span><br><span class="line"></span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_loaderQueue.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Loader loader &#x3D; m_loaderQueue[i];</span><br><span class="line">            if (loader.Type &#x3D;&#x3D; Loader.LoaderType.BUNDLE)</span><br><span class="line">            &#123;</span><br><span class="line">                AssetBundleLoader bLoader &#x3D; loader as AssetBundleLoader;</span><br><span class="line">                if (!bLoader.IsPrepareToLoad())</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;   &#x2F;&#x2F;如果有依赖未加载完直接跳过</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (loader.Type &#x3D;&#x3D; Loader.LoaderType.BUNDLEASSET)</span><br><span class="line">            &#123;</span><br><span class="line">                BundleAssetLoader bLoader &#x3D; loader as BundleAssetLoader;</span><br><span class="line">                if (!bLoader.IsPrepareToLoad())</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;   &#x2F;&#x2F;Asset是否准备好加载</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            m_loadings.Add(loader);</span><br><span class="line">            loader.Load();</span><br><span class="line">            loader.Update(dt);</span><br><span class="line">            m_lstRmTemp.Add(i);</span><br><span class="line">            if (m_lstRmTemp.Count &gt;&#x3D; remain)</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (m_lstRmTemp.Count &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            for (int i &#x3D; m_lstRmTemp.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.RemoveAt(m_lstRmTemp[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            m_lstRmTemp.Clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UpdateAssetBundleCache();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 更新AssetBundle缓存(主要执行定时清理)</span><br><span class="line">    public void UpdateAssetBundleCache()</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 每5秒回收一次</span><br><span class="line">        if (Time.realtimeSinceStartup - m_lastClear &lt; 5)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_lastClear &#x3D; Time.realtimeSinceStartup;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;&#x2F; 检查无引用的AB节点</span><br><span class="line">        ABCachePool.Instance.ClearNoneRefCache(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        ABCachePool.Instance.ClearNoneRefCache(false);</span><br><span class="line"></span><br><span class="line">        Resources.UnloadUnusedAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #region LoadManifest</span><br><span class="line">    &#x2F;&#x2F; 加载资源清单</span><br><span class="line">    public void LoadManifest()</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_manifest !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Object.DestroyImmediate(m_manifest, true);</span><br><span class="line">            m_manifest &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_bundleNames.Clear();</span><br><span class="line"></span><br><span class="line">        string manifestName &#x3D; FileHelper.MANIFEST_NAME;&#x2F;&#x2F;manifest文件名</span><br><span class="line">        string strFullPath &#x3D; FileHelper.SearchFilePath(manifestName);&#x2F;&#x2F;获取manifest路径</span><br><span class="line"></span><br><span class="line">        AssetBundleLoader bLoader &#x3D; LoaderPool.Instance.GetLoader&lt;AssetBundleLoader&gt;();</span><br><span class="line">        bLoader.Init(strFullPath, manifestName, null, delegate (object data) &#123;</span><br><span class="line">            AssetBundleCache ab &#x3D; data as AssetBundleCache;</span><br><span class="line">            if (ab !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                m_manifest &#x3D; (AssetBundleManifest)ab.LoadAsset(&quot;AssetBundleManifest&quot;, typeof(AssetBundleManifest));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ABCachePool.Instance.UnReferenceCache(manifestName, true);  &#x2F;&#x2F; 不走统一接口是因为manifest文件没有后缀</span><br><span class="line"></span><br><span class="line">            if (m_manifest !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                string[] bundles &#x3D; m_manifest.GetAllAssetBundles();</span><br><span class="line"></span><br><span class="line">                for (int i &#x3D; 0; i &lt; bundles.Length; ++i)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_bundleNames.Add(bundles[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, false);</span><br><span class="line">        bLoader.Load();</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    public void LoadPrefab(string strPath, string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        LoadAssetFromBundle(strPath, name, typeof(GameObject), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadMusic(string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        string path &#x3D; string.Format(&quot;music&#x2F;&#123;0&#125;&quot;, name);</span><br><span class="line">        LoadAssetFromBundle(path, name, typeof(AudioClip), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadFont(string name, LoadedCallback onLoaded, bool async &#x3D; true, bool inBundle &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        string path &#x3D; string.Format(&quot;ui&#x2F;font&#x2F;&#123;0&#125;&quot;, name);</span><br><span class="line">        LoadAssetFromBundle(path, name, typeof(Font), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #region LoadScene</span><br><span class="line">    public void LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded)</span><br><span class="line">    &#123;</span><br><span class="line">        var activeSceneName &#x3D; SceneManager.GetActiveScene().name;</span><br><span class="line">        &#x2F;&#x2F; 如果当前场景是要加载的场景 直接返回</span><br><span class="line">        if (activeSceneName &#x3D;&#x3D; name)</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(null);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (isAdditive)</span><br><span class="line">        &#123;</span><br><span class="line">            RealLoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#x2F;&#x2F;大场景先加载idle过渡</span><br><span class="line">        &#123;</span><br><span class="line">            RealLoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void RealLoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded)</span><br><span class="line">    &#123;</span><br><span class="line">        string abPath &#x3D; &quot;scenes&#x2F;&quot; + name;</span><br><span class="line">        LoadAssetBundle(abPath, delegate (object data) &#123;</span><br><span class="line">            if (data &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                CallFunc_LoadedBack(onLoaded, null);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            __LoadScene(name, scenePath, isAdditive, onLoaded);  &#x2F;&#x2F;场景的bundle在SceneLoader中自动卸载</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void __LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        SceneLoader sLoader &#x3D; LoaderPool.Instance.GetLoader&lt;SceneLoader&gt;();</span><br><span class="line">        sLoader.Init(name, scenePath, isAdditive, onLoaded, async);</span><br><span class="line">        StartLoad(sLoader, true);</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;从Bundle中加载资源</span><br><span class="line">    public void LoadAssetFromBundle(string path, string name, System.Type type, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        LoadAssetBundle(path, (data) &#x3D;&gt; &#123;</span><br><span class="line">            AssetBundleCache abCache &#x3D; data as AssetBundleCache;</span><br><span class="line">            if (abCache &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogWarningFormat(&quot;LoadAssetFromBundle, load ab fail:&#123;0&#125;&quot;, path);</span><br><span class="line">                CallFunc_LoadedBack(onLoaded, null);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 开启任务去做加载</span><br><span class="line">            BundleAssetLoader assetLoader &#x3D; LoaderPool.Instance.GetLoader&lt;BundleAssetLoader&gt;();</span><br><span class="line">            assetLoader.Init(abCache, name, type, onLoaded, async);</span><br><span class="line">            StartLoad(assetLoader, async);</span><br><span class="line">        &#125;, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 加载AssetBundle(先从persistentData读,没有找到则从streamingAssets读,带后缀)</span><br><span class="line">    public void LoadAssetBundle(string path, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        string name &#x3D; FileHelper.GenBundlePath(path);</span><br><span class="line">        if (!HasAssetBundle(name))</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(null);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 加载依赖</span><br><span class="line">        LoadDependencies(name, async);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 检查是否有缓存 有缓存说明依赖资源也是加载过了的</span><br><span class="line">        AssetBundleCache abCache &#x3D; ABCachePool.Instance.ReferenceCacheByName(name);</span><br><span class="line">        if (abCache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(abCache);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string fullpath &#x3D; FileHelper.SearchFilePath(name);</span><br><span class="line">        AssetBundleLoader bLoader &#x3D; null;</span><br><span class="line">        m_dicAllLoader.TryGetValue(name, out bLoader);</span><br><span class="line">        if (bLoader &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            string[] dependencies &#x3D; m_manifest.GetDirectDependencies(name);</span><br><span class="line"></span><br><span class="line">            bLoader &#x3D; LoaderPool.Instance.GetLoader&lt;AssetBundleLoader&gt;();</span><br><span class="line">            bLoader.Init(fullpath, name, dependencies, onLoaded, async);</span><br><span class="line">            m_dicAllLoader.Add(name, bLoader);</span><br><span class="line">            StartLoad(bLoader, async);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                bLoader.AddLoadedCallback(onLoaded);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                bLoader.AddReferenced();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 依赖</span><br><span class="line">    &#x2F;&#x2F; 加载依赖</span><br><span class="line">    &#x2F;&#x2F;asyncInFact 实际加载方式，如果依赖bundle是异步加载并且正在加载中，那么整个bundle的加载方式变成异步加载</span><br><span class="line">    void LoadDependencies(string name, bool async)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_manifest &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] dependencies &#x3D; m_manifest.GetDirectDependencies(name);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; dependencies.Length; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            LoadAssetBundle(dependencies[i], null, async);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void StartLoad(Loader loader, bool async, bool toHead &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 异步加载或者加载还未准备好，则当做异步处理，外部控制是否加入队列开头</span><br><span class="line">        &#x2F;&#x2F; 同步加载，并且已经具备加载条件，则直接调用Load进行加载</span><br><span class="line">        if (async || !loader.IsPrepareToLoad())</span><br><span class="line">        &#123;</span><br><span class="line">            if (toHead)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.Insert(0, loader);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.Add(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadings.Add(loader);</span><br><span class="line">            loader.Load();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool HasAssetBundle(string path)</span><br><span class="line">    &#123;</span><br><span class="line">        path &#x3D; path.Replace(&quot;&#x2F;&quot;, &quot;_&quot;).ToLower();</span><br><span class="line">        return m_bundleNames.Count &#x3D;&#x3D; 0 || m_bundleNames.Contains(path) || string.Equals(path, FileHelper.MANIFEST_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载关卡场景</span><br><span class="line">    public void UnloadLevelScene(string sceneName, bool immediate)</span><br><span class="line">    &#123;</span><br><span class="line">        SceneManager.UnloadSceneAsync(sceneName);</span><br><span class="line">        UnloadSceneAssetBundle(sceneName, immediate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载场景的AssetBundle</span><br><span class="line">    public void UnloadSceneAssetBundle(string sceneName, bool immediate)</span><br><span class="line">    &#123;</span><br><span class="line">        if (Config.Instance.UseAssetBundle)</span><br><span class="line">        &#123;</span><br><span class="line">            string strABPath &#x3D; &quot;scenes&#x2F;&quot; + sceneName;</span><br><span class="line">            UnloadAssetBundle(strABPath, immediate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载AssetBundle</span><br><span class="line">    public void UnloadAssetBundle(string path, bool immediate &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        string name &#x3D; FileHelper.GenBundlePath(path);</span><br><span class="line">        AssetBundleCache cache &#x3D; ABCachePool.Instance.UnReferenceCache(name, immediate);</span><br><span class="line">        if (cache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            UnloadDependencies(name, immediate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载依赖</span><br><span class="line">    void UnloadDependencies(string name, bool immediate)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_manifest &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] dependencies &#x3D; m_manifest.GetDirectDependencies(name);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; dependencies.Length; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            UnloadAssetBundle(dependencies[i], immediate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void CallFunc_LoadedBack(LoadedCallback callback, object data)</span><br><span class="line">    &#123;</span><br><span class="line">        if (callback !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            callback(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/05/2025-07-05/" data-id="cmcvdrdx0000iccz89xcs7zb2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity/" rel="tag">unity</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/07/06/2025-07-06/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          框架之UI管理模块
        
      </div>
    </a>
  
  
    <a href="/2025/07/04/2025-07-04/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">框架之资源管理</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/" rel="tag">AOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Assetbundle/" rel="tag">Assetbundle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IOC/" rel="tag">IOC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Particle-System/" rel="tag">Particle System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shader/" rel="tag">Shader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Slot-%E8%80%81%E8%99%8E%E6%9C%BA%EF%BC%8C%E6%B8%B8%E6%88%8F%E7%A0%94%E7%A9%B6/" rel="tag">Slot, 老虎机，游戏研究</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UGUI/" rel="tag">UGUI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/" rel="tag">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity-C/" rel="tag">Unity, C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity-UI%E6%A1%86%E6%9E%B6-UGUI/" rel="tag">Unity, UI框架, UGUI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity%EF%BC%8CAssetBundle/" rel="tag">Unity，AssetBundle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/game/" rel="tag">game</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gameframework/" rel="tag">gameframework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http-server/" rel="tag">http.server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/keyboard/" rel="tag">keyboard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/slot-%E8%80%81%E8%99%8E%E6%9C%BA-slot-game/" rel="tag">slot, 老虎机, slot game</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unity/" rel="tag">unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unity-python/" rel="tag">unity python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xlua-lua-framework/" rel="tag">xlua, lua, framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%B1%E5%BF%97/" rel="tag">励志</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%89%A9%E7%90%86%E5%BC%95%E6%93%8E/" rel="tag">物理引擎</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/" rel="tag">程序员</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/Assetbundle/" style="font-size: 10px;">Assetbundle</a> <a href="/tags/C/" style="font-size: 15.71px;">C#</a> <a href="/tags/IOC/" style="font-size: 10px;">IOC</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 14.29px;">Java</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Particle-System/" style="font-size: 10px;">Particle System</a> <a href="/tags/Shader/" style="font-size: 10px;">Shader</a> <a href="/tags/Slot-%E8%80%81%E8%99%8E%E6%9C%BA%EF%BC%8C%E6%B8%B8%E6%88%8F%E7%A0%94%E7%A9%B6/" style="font-size: 10px;">Slot, 老虎机，游戏研究</a> <a href="/tags/Spring/" style="font-size: 10px;">Spring</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/UGUI/" style="font-size: 11.43px;">UGUI</a> <a href="/tags/Unity/" style="font-size: 18.57px;">Unity</a> <a href="/tags/Unity-C/" style="font-size: 10px;">Unity, C#</a> <a href="/tags/Unity-UI%E6%A1%86%E6%9E%B6-UGUI/" style="font-size: 10px;">Unity, UI框架, UGUI</a> <a href="/tags/Unity%EF%BC%8CAssetBundle/" style="font-size: 10px;">Unity，AssetBundle</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/flask/" style="font-size: 10px;">flask</a> <a href="/tags/game/" style="font-size: 10px;">game</a> <a href="/tags/gameframework/" style="font-size: 10px;">gameframework</a> <a href="/tags/http-server/" style="font-size: 10px;">http.server</a> <a href="/tags/keyboard/" style="font-size: 10px;">keyboard</a> <a href="/tags/mysql/" style="font-size: 12.86px;">mysql</a> <a href="/tags/python/" style="font-size: 12.86px;">python</a> <a href="/tags/slot-%E8%80%81%E8%99%8E%E6%9C%BA-slot-game/" style="font-size: 10px;">slot, 老虎机, slot game</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/unity/" style="font-size: 17.14px;">unity</a> <a href="/tags/unity-python/" style="font-size: 10px;">unity python</a> <a href="/tags/xlua-lua-framework/" style="font-size: 11.43px;">xlua, lua, framework</a> <a href="/tags/%E5%8A%B1%E5%BF%97/" style="font-size: 10px;">励志</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">性能优化</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正则表达式</a> <a href="/tags/%E7%89%A9%E7%90%86%E5%BC%95%E6%93%8E/" style="font-size: 10px;">物理引擎</a> <a href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/" style="font-size: 10px;">程序员</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 11.43px;">算法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 20px;">设计模式</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 11.43px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">July 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/07/13/2025-07-13/">简单的服务器搭建</a>
          </li>
        
          <li>
            <a href="/2025/07/11/2025-07-11/">框架之日志管理系统</a>
          </li>
        
          <li>
            <a href="/2025/07/10/2025-07-12/">unity 一键打包</a>
          </li>
        
          <li>
            <a href="/2025/07/10/2025-07-10/">Unity UI框架总结</a>
          </li>
        
          <li>
            <a href="/2025/07/09/2025-07-09/">Unity 打android 包报错总结</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2025 OuyangWenyuan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>