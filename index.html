<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>持续学习者————Just Do It！</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="看，听，学，记，练；读，思，写，说，教。读书百遍，其义自现，熟能生巧，巧能升精，精能升华，华能出奇，出奇方能制胜。">
<meta property="og:type" content="website">
<meta property="og:title" content="持续学习者————Just Do It！">
<meta property="og:url" content="http://droidman.net/index.html">
<meta property="og:site_name" content="持续学习者————Just Do It！">
<meta property="og:description" content="看，听，学，记，练；读，思，写，说，教。读书百遍，其义自现，熟能生巧，巧能升精，精能升华，华能出奇，出奇方能制胜。">
<meta property="og:locale" content="en,ZH">
<meta property="article:author" content="OuyangWenyuan">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="C">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="Objective-c">
<meta property="article:tag" content="Swift">
<meta property="article:tag" content="Unity">
<meta property="article:tag" content="Unity3d">
<meta property="article:tag" content="Shader">
<meta property="article:tag" content="Http">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Blog">
<meta property="article:tag" content="Program">
<meta property="article:tag" content="Mac OS">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Unix">
<meta property="article:tag" content="Window">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Lua">
<meta property="article:tag" content="Javascript">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="xcode">
<meta property="article:tag" content="IDEA">
<meta property="article:tag" content="eclicpse">
<meta property="article:tag" content="blender">
<meta property="article:tag" content="MVC">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="持续学习者————Just Do It！" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">持续学习者————Just Do It！</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">学无止境————不怕你不会，就怕你不学！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://droidman.net"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2025-07-13" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/13/2025-07-13/" class="article-date">
  <time datetime="2025-07-13T00:27:04.000Z" itemprop="datePublished">2025-07-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/13/2025-07-13/">简单的服务器搭建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1、资源服务器<br>可以用python的http.server模块快速搭建一个简单的服务器<br>方法1、在需要的目录下执行下面命令就可以下载该目录下的资源了。<br>python3 -m http.server 8000<br>方法2、创建python脚本，运行脚本，然后在浏览器中输入<a href="http://localhost:8000/就可以访问了。" target="_blank" rel="noopener">http://localhost:8000/就可以访问了。</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"></span><br><span class="line">PORT = <span class="number">8000</span></span><br><span class="line"></span><br><span class="line">Handler = http.server.SimpleHTTPRequestHandler</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> socketserver.TCPServer((<span class="string">""</span>, PORT), Handler) <span class="keyword">as</span> httpd:</span><br><span class="line">    print(<span class="string">"serving at port"</span>, PORT)</span><br><span class="line">    httpd.serve_forever()</span><br></pre></td></tr></table></figure>

<p>2、短连接服务器，一般是web/http 服务器，可以用python 的flask 模块快速搭建一个简单的服务器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">CORS(app)  <span class="comment"># 允许跨域</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化数据库</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></span><br><span class="line">    conn = sqlite3.connect(<span class="string">'game.db'</span>)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    c.execute(<span class="string">'''CREATE TABLE IF NOT EXISTS players</span></span><br><span class="line"><span class="string">                 (id TEXT PRIMARY KEY, </span></span><br><span class="line"><span class="string">                  device_id TEXT UNIQUE,</span></span><br><span class="line"><span class="string">                  progress INTEGER DEFAULT 0)'''</span>)</span><br><span class="line">    conn.commit()</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匿名注册</span></span><br><span class="line"><span class="meta">@app.route('/register', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    device_id = str(uuid.uuid4())  <span class="comment"># 生成设备唯一ID</span></span><br><span class="line">    conn = sqlite3.connect(<span class="string">'game.db'</span>)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    c.execute(<span class="string">"INSERT INTO players (id, device_id) VALUES (?, ?)"</span>, </span><br><span class="line">              (str(uuid.uuid4()), device_id))</span><br><span class="line">    conn.commit()</span><br><span class="line">    conn.close()</span><br><span class="line">    print(<span class="string">"[Server] Simulating push notification..."</span> + device_id)</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"device_id"</span>: device_id&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录/获取进度</span></span><br><span class="line"><span class="meta">@app.route('/login', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    device_id = request.json.get(<span class="string">'device_id'</span>)</span><br><span class="line">    conn = sqlite3.connect(<span class="string">'game.db'</span>)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    c.execute(<span class="string">"SELECT progress FROM players WHERE device_id=?"</span>, (device_id,))</span><br><span class="line">    result = c.fetchone()</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"progress"</span>: result[<span class="number">0</span>]&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"error"</span>: <span class="string">"User not found"</span>&#125;), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步进度</span></span><br><span class="line"><span class="meta">@app.route('/sync', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sync</span><span class="params">()</span>:</span></span><br><span class="line">    device_id = request.json.get(<span class="string">'device_id'</span>)</span><br><span class="line">    progress = request.json.get(<span class="string">'progress'</span>)</span><br><span class="line">    conn = sqlite3.connect(<span class="string">'game.db'</span>)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    c.execute(<span class="string">"UPDATE players SET progress=? WHERE device_id=?"</span>, </span><br><span class="line">              (progress, device_id))</span><br><span class="line">    conn.commit()</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟服务器推送</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push_notification</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        time.sleep(<span class="number">10</span>)  <span class="comment"># 每10秒推送一次</span></span><br><span class="line">        print(<span class="string">"[Server] Simulating push notification..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    init_db()</span><br><span class="line">    <span class="comment"># 启动推送线程</span></span><br><span class="line">    threading.Thread(target=push_notification, daemon=<span class="literal">True</span>).start()</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>3、长连接服务器，一般是socket 服务器，可以用python 的socket 模块快速搭建一个简单的服务器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 线程安全的客户端连接管理</span></span><br><span class="line">clients = &#123;&#125;</span><br><span class="line">clients_lock = Lock()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化数据库</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></span><br><span class="line">    conn_db = sqlite3.connect(<span class="string">'game.db'</span>)</span><br><span class="line">    c = conn_db.cursor()</span><br><span class="line">    c.execute(<span class="string">'''CREATE TABLE IF NOT EXISTS players</span></span><br><span class="line"><span class="string">                 (id TEXT PRIMARY KEY, </span></span><br><span class="line"><span class="string">                  device_id TEXT UNIQUE,</span></span><br><span class="line"><span class="string">                  progress INTEGER DEFAULT 0)'''</span>)</span><br><span class="line">    conn_db.commit()</span><br><span class="line">    conn_db.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理客户端连接</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_client</span><span class="params">(conn, addr)</span>:</span></span><br><span class="line">    device_id = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 接收消息长度头 (4字节)</span></span><br><span class="line">            header = conn.recv(<span class="number">4</span>)</span><br><span class="line">            print(<span class="string">f"收到header: <span class="subst">&#123;header&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> header: <span class="keyword">break</span></span><br><span class="line">            msg_len = int.from_bytes(header, byteorder=<span class="string">'big'</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 接收实际数据</span></span><br><span class="line">            data = conn.recv(msg_len)</span><br><span class="line">            print(<span class="string">f"收到data: <span class="subst">&#123;data&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data: <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 解析JSON</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                req = json.loads(data.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">                cmd = req.get(<span class="string">"cmd"</span>)</span><br><span class="line">                print(<span class="string">f"收到cmd: <span class="subst">&#123;cmd&#125;</span>"</span>)</span><br><span class="line">                <span class="comment"># 注册/登录</span></span><br><span class="line">                <span class="keyword">if</span> cmd == <span class="string">"register_or_login"</span>:</span><br><span class="line">                    device_id = req.get(<span class="string">"device_id"</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> device_id:</span><br><span class="line">                        device_id = str(uuid.uuid4())</span><br><span class="line">                        conn_db = sqlite3.connect(<span class="string">'game.db'</span>)</span><br><span class="line">                        c = conn_db.cursor()</span><br><span class="line">                        c.execute(<span class="string">"INSERT INTO players (id, device_id) VALUES (?, ?)"</span>, </span><br><span class="line">                                  (str(uuid.uuid4()), device_id))</span><br><span class="line">                        conn_db.commit()</span><br><span class="line">                        conn_db.close()</span><br><span class="line">                    </span><br><span class="line">                    clients[device_id] = conn</span><br><span class="line">                    <span class="comment"># 查询进度</span></span><br><span class="line">                    conn_db = sqlite3.connect(<span class="string">'game.db'</span>)</span><br><span class="line">                    c = conn_db.cursor()</span><br><span class="line">                    c.execute(<span class="string">"SELECT progress FROM players WHERE device_id=?"</span>, (device_id,))</span><br><span class="line">                    progress = c.fetchone()[<span class="number">0</span>]</span><br><span class="line">                    conn_db.close()</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 返回响应</span></span><br><span class="line">                    resp = &#123;</span><br><span class="line">                        <span class="string">"cmd"</span>: <span class="string">"login_response"</span>,</span><br><span class="line">                        <span class="string">"device_id"</span>: device_id,</span><br><span class="line">                        <span class="string">"progress"</span>: progress</span><br><span class="line">                    &#125;</span><br><span class="line">                    send_response(conn, resp)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 同步进度</span></span><br><span class="line">                <span class="keyword">elif</span> cmd == <span class="string">"sync_progress"</span>:</span><br><span class="line">                    progress = req.get(<span class="string">"progress"</span>)</span><br><span class="line">                    conn_db = sqlite3.connect(<span class="string">'game.db'</span>)</span><br><span class="line">                    c = conn_db.cursor()</span><br><span class="line">                    c.execute(<span class="string">"UPDATE players SET progress=? WHERE device_id=?"</span>, </span><br><span class="line">                              (progress, device_id))</span><br><span class="line">                    conn_db.commit()</span><br><span class="line">                    conn_db.close()</span><br><span class="line">                    </span><br><span class="line">                    send_response(conn,  &#123;</span><br><span class="line">                        <span class="string">"cmd"</span>: <span class="string">"sync_ok"</span>,</span><br><span class="line">                        <span class="string">"device_id"</span>: device_id,</span><br><span class="line">                        <span class="string">"progress"</span>: progress</span><br><span class="line">                    &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">                print(<span class="string">f"非法JSON数据: <span class="subst">&#123;data&#125;</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">        print(<span class="string">f"客户端断开: <span class="subst">&#123;addr&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">with</span> clients_lock:</span><br><span class="line">            <span class="keyword">if</span> device_id <span class="keyword">in</span> clients:</span><br><span class="line">                <span class="keyword">del</span> clients[device_id]</span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送响应（添加长度头）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_response</span><span class="params">(conn, data)</span>:</span></span><br><span class="line">    json_str = json.dumps(data)</span><br><span class="line">    encoded = json_str.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    header = len(encoded).to_bytes(<span class="number">4</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    conn.send(header + encoded)</span><br><span class="line">    print(<span class="string">f"回应cmd: <span class="subst">&#123;data.get(<span class="string">'cmd'</span>)&#125;</span>，data=<span class="subst">&#123;data&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟服务器推送</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push_notification</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        time.sleep(<span class="number">10</span>)  <span class="comment"># 每10秒推送一次</span></span><br><span class="line">        message = &#123;</span><br><span class="line">            <span class="string">"cmd"</span>: <span class="string">"server_push"</span>,</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"新活动已上线！"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">with</span> clients_lock:</span><br><span class="line">            <span class="keyword">for</span> device_id, conn <span class="keyword">in</span> list(clients.items()):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    send_response(conn, message)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">del</span> clients[device_id]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    init_db()</span><br><span class="line">    host, port = <span class="string">"0.0.0.0"</span>, <span class="number">8766</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动Socket服务器</span></span><br><span class="line">    <span class="keyword">with</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) <span class="keyword">as</span> s:</span><br><span class="line">        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        s.bind((host, port))</span><br><span class="line">        s.listen()</span><br><span class="line">        print(<span class="string">f"Socket服务器启动: <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        threading.Thread(target=push_notification, daemon=<span class="literal">True</span>).start()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            conn, addr = s.accept()</span><br><span class="line">            threading.Thread(target=handle_client, args=(conn, addr)).start()</span><br><span class="line">            <span class="comment"># 启动推送线程</span></span><br></pre></td></tr></table></figure>

<p>或者用云风大大的 skynet</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line">main.lua</span><br><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"></span><br><span class="line">skynet.start(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">	skynet.<span class="built_in">error</span>(<span class="string">"Server start"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> skynet.<span class="built_in">getenv</span> <span class="string">"daemon"</span> <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">local</span> console = skynet.newservice(<span class="string">"console"</span>)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	skynet.newservice(<span class="string">"debug_console"</span>,<span class="number">8000</span>)</span><br><span class="line">	<span class="keyword">local</span> proto = skynet.uniqueservice <span class="string">"protoloader"</span></span><br><span class="line">	skynet.call(proto, <span class="string">"lua"</span>, <span class="string">"load"</span>, &#123;</span><br><span class="line">		<span class="string">"proto.c2s"</span>,</span><br><span class="line">		<span class="string">"proto.s2c"</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">local</span> hub = skynet.uniqueservice <span class="string">"hub"</span></span><br><span class="line">	skynet.call(hub, <span class="string">"lua"</span>, <span class="string">"open"</span>, <span class="string">"0.0.0.0"</span>, <span class="number">5678</span>)</span><br><span class="line">	skynet.<span class="built_in">exit</span>()</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line">hub.lua</span><br><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"><span class="keyword">local</span> socket = <span class="built_in">require</span> <span class="string">"socket"</span></span><br><span class="line"><span class="keyword">local</span> proxy = <span class="built_in">require</span> <span class="string">"socket_proxy"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">"log"</span></span><br><span class="line"><span class="keyword">local</span> service = <span class="built_in">require</span> <span class="string">"service"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> hub = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> data = &#123; socket = &#123;&#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">auth_socket</span><span class="params">(fd)</span></span></span><br><span class="line">	<span class="keyword">return</span> (skynet.call(service.auth, <span class="string">"lua"</span>, <span class="string">"shakehand"</span> , fd))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">assign_agent</span><span class="params">(fd, userid)</span></span></span><br><span class="line">	skynet.call(service.manager, <span class="string">"lua"</span>, <span class="string">"assign"</span>, fd, userid)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new_socket</span><span class="params">(fd, addr)</span></span></span><br><span class="line">	data.socket[fd] = <span class="string">"[AUTH]"</span></span><br><span class="line">	proxy.subscribe(fd)</span><br><span class="line">	<span class="keyword">local</span> ok , userid =  <span class="built_in">pcall</span>(auth_socket, fd)</span><br><span class="line">	<span class="keyword">if</span> ok <span class="keyword">then</span></span><br><span class="line">		data.socket[fd] = userid</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">pcall</span>(assign_agent, fd, userid) <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span>	<span class="comment">-- succ</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">log</span>(<span class="string">"Assign failed %s to %s"</span>, addr, userid)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">log</span>(<span class="string">"Auth faild %s"</span>, addr)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	proxy.<span class="built_in">close</span>(fd)</span><br><span class="line">	data.socket[fd] = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hub.open</span><span class="params">(ip, port)</span></span></span><br><span class="line">	<span class="built_in">log</span>(<span class="string">"Listen %s:%d"</span>, ip, port)</span><br><span class="line">	<span class="built_in">assert</span>(data.fd == <span class="literal">nil</span>, <span class="string">"Already open"</span>)</span><br><span class="line">	data.fd = socket.listen(ip, port)</span><br><span class="line">	data.ip = ip</span><br><span class="line">	data.port = port</span><br><span class="line">	socket.start(data.fd, new_socket)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hub.close</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">assert</span>(data.fd)</span><br><span class="line">	<span class="built_in">log</span>(<span class="string">"Close %s:%d"</span>, data.ip, data.port)</span><br><span class="line">	socket.<span class="built_in">close</span>(data.fd)</span><br><span class="line">	data.ip = <span class="literal">nil</span></span><br><span class="line">	data.port = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">service.init &#123;</span><br><span class="line">	command = hub,</span><br><span class="line">	info = data,</span><br><span class="line">	<span class="built_in">require</span> = &#123;</span><br><span class="line">		<span class="string">"auth"</span>,</span><br><span class="line">		<span class="string">"manager"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">auth.lua</span><br><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"><span class="keyword">local</span> service = <span class="built_in">require</span> <span class="string">"service"</span></span><br><span class="line"><span class="keyword">local</span> client = <span class="built_in">require</span> <span class="string">"client"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> auth = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> users = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> cli = client.handler()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> SUCC = &#123; ok = <span class="literal">true</span> &#125;</span><br><span class="line"><span class="keyword">local</span> FAIL = &#123; ok = <span class="literal">false</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cli:signup</span><span class="params">(args)</span></span></span><br><span class="line">	<span class="built_in">log</span>(<span class="string">"signup userid = %s"</span>, args.userid)</span><br><span class="line">	<span class="keyword">if</span> users[args.userid] <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">return</span> FAIL</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		users[args.userid] = <span class="literal">true</span></span><br><span class="line">		<span class="keyword">return</span> SUCC</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cli:signin</span><span class="params">(args)</span></span></span><br><span class="line">	<span class="built_in">log</span>(<span class="string">"signin userid = %s"</span>, args.userid)</span><br><span class="line">	<span class="keyword">if</span> users[args.userid] <span class="keyword">then</span></span><br><span class="line">		self.userid = args.userid</span><br><span class="line">		self.<span class="built_in">exit</span> = <span class="literal">true</span></span><br><span class="line">		<span class="keyword">return</span> SUCC</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> FAIL</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cli:ping</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">log</span>(<span class="string">"ping"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth.shakehand</span><span class="params">(fd)</span></span></span><br><span class="line">	<span class="keyword">local</span> c = client.dispatch &#123; fd = fd &#125;</span><br><span class="line">	<span class="keyword">return</span> c.userid</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">service.init &#123;</span><br><span class="line">	command = auth,</span><br><span class="line">	info = users,</span><br><span class="line">	init = client.init <span class="string">"proto"</span>,</span><br><span class="line">&#125;</span><br><span class="line">manager.lua</span><br><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"><span class="keyword">local</span> service = <span class="built_in">require</span> <span class="string">"service"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> manager = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> users = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">new_agent</span><span class="params">()</span></span></span><br><span class="line">	<span class="comment">-- todo: use a pool</span></span><br><span class="line">	<span class="keyword">return</span> skynet.newservice <span class="string">"agent"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">free_agent</span><span class="params">(agent)</span></span></span><br><span class="line">	<span class="comment">-- kill agent, todo: put it into a pool maybe better</span></span><br><span class="line">	skynet.kill(agent)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">manager.assign</span><span class="params">(fd, userid)</span></span></span><br><span class="line">	<span class="keyword">local</span> agent</span><br><span class="line">	<span class="keyword">repeat</span></span><br><span class="line">		agent = users[userid]</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> agent <span class="keyword">then</span></span><br><span class="line">			agent = new_agent()</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">not</span> users[userid] <span class="keyword">then</span></span><br><span class="line">				<span class="comment">-- double check</span></span><br><span class="line">				users[userid] = agent</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				free_agent(agent)</span><br><span class="line">				agent = users[userid]</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">until</span> skynet.call(agent, <span class="string">"lua"</span>, <span class="string">"assign"</span>, fd, userid)</span><br><span class="line">	<span class="built_in">log</span>(<span class="string">"Assign %d to %s [%s]"</span>, fd, userid, agent)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">manager.exit</span><span class="params">(userid)</span></span></span><br><span class="line">	users[userid] = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">service.init &#123;</span><br><span class="line">	command = manager,</span><br><span class="line">	info = users,</span><br><span class="line">&#125;</span><br><span class="line">agent.lua</span><br><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"><span class="keyword">local</span> service = <span class="built_in">require</span> <span class="string">"service"</span></span><br><span class="line"><span class="keyword">local</span> client = <span class="built_in">require</span> <span class="string">"client"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> agent = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> data = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> cli = client.handler()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cli:ping</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">assert</span>(self.login)</span><br><span class="line">	<span class="built_in">log</span> <span class="string">"ping"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cli:login</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">assert</span>(<span class="keyword">not</span> self.login)</span><br><span class="line">	<span class="keyword">if</span> data.fd <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">log</span>(<span class="string">"login fail %s fd=%d"</span>, data.userid, self.fd)</span><br><span class="line">		<span class="keyword">return</span> &#123; ok = <span class="literal">false</span> &#125;</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	data.fd = self.fd</span><br><span class="line">	self.login = <span class="literal">true</span></span><br><span class="line">	<span class="built_in">log</span>(<span class="string">"login succ %s fd=%d"</span>, data.userid, self.fd)</span><br><span class="line">	client.push(self, <span class="string">"push"</span>, &#123; text = <span class="string">"welcome"</span> &#125;)	<span class="comment">-- push message to client</span></span><br><span class="line">	<span class="keyword">return</span> &#123; ok = <span class="literal">true</span> &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">new_user</span><span class="params">(fd)</span></span></span><br><span class="line">	<span class="keyword">local</span> ok, <span class="built_in">error</span> = <span class="built_in">pcall</span>(client.dispatch , &#123; fd = fd &#125;)</span><br><span class="line">	<span class="built_in">log</span>(<span class="string">"fd=%d is gone. error = %s"</span>, fd, <span class="built_in">error</span>)</span><br><span class="line">	client.<span class="built_in">close</span>(fd)</span><br><span class="line">	<span class="keyword">if</span> data.fd == fd <span class="keyword">then</span></span><br><span class="line">		data.fd = <span class="literal">nil</span></span><br><span class="line">		skynet.sleep(<span class="number">1000</span>)	<span class="comment">-- exit after 10s</span></span><br><span class="line">		<span class="keyword">if</span> data.fd == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">			<span class="comment">-- double check</span></span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">not</span> data.<span class="built_in">exit</span> <span class="keyword">then</span></span><br><span class="line">				data.<span class="built_in">exit</span> = <span class="literal">true</span>	<span class="comment">-- mark exit</span></span><br><span class="line">				skynet.call(service.manager, <span class="string">"lua"</span>, <span class="string">"exit"</span>, data.userid)	<span class="comment">-- report exit</span></span><br><span class="line">				<span class="built_in">log</span>(<span class="string">"user %s afk"</span>, data.userid)</span><br><span class="line">				skynet.<span class="built_in">exit</span>()</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">agent.assign</span><span class="params">(fd, userid)</span></span></span><br><span class="line">	<span class="keyword">if</span> data.<span class="built_in">exit</span> <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">if</span> data.userid == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">		data.userid = userid</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="built_in">assert</span>(data.userid == userid)</span><br><span class="line">	skynet.fork(new_user, fd)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">service.init &#123;</span><br><span class="line">	command = agent,</span><br><span class="line">	info = data,</span><br><span class="line">	<span class="built_in">require</span> = &#123;</span><br><span class="line">		<span class="string">"manager"</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">	init = client.init <span class="string">"proto"</span>,</span><br><span class="line">&#125;</span><br><span class="line">protoloader.lua</span><br><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"><span class="keyword">local</span> sprotoparser = <span class="built_in">require</span> <span class="string">"sprotoparser"</span></span><br><span class="line"><span class="keyword">local</span> sprotoloader = <span class="built_in">require</span> <span class="string">"sprotoloader"</span></span><br><span class="line"><span class="keyword">local</span> service = <span class="built_in">require</span> <span class="string">"service"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> loader = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> data = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">(name)</span></span></span><br><span class="line">	<span class="keyword">local</span> filename = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"proto/%s.sproto"</span>, name)</span><br><span class="line">	<span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename), <span class="string">"Can't open "</span> .. name)</span><br><span class="line">	<span class="keyword">local</span> t = f:<span class="built_in">read</span> <span class="string">"a"</span></span><br><span class="line">	f:<span class="built_in">close</span>()</span><br><span class="line">	<span class="keyword">return</span> sprotoparser.parse(t)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader.load</span><span class="params">(list)</span></span></span><br><span class="line">	<span class="keyword">for</span> i, name <span class="keyword">in</span> <span class="built_in">ipairs</span>(list) <span class="keyword">do</span></span><br><span class="line">		<span class="keyword">local</span> p = <span class="built_in">load</span>(name)</span><br><span class="line">		<span class="built_in">log</span>(<span class="string">"load proto [%s] in slot %d"</span>, name, i)</span><br><span class="line">		data[name] = i</span><br><span class="line">		sprotoloader.save(p, i)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader.index</span><span class="params">(name)</span></span></span><br><span class="line">	<span class="keyword">return</span> data[name]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">service.init &#123;</span><br><span class="line">	command = loader,</span><br><span class="line">	info = data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/13/2025-07-13/" data-id="cmd12rpt50003clz8eiqcbgd8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/http-server/" rel="tag">http.server</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/socket/" rel="tag">socket</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-11" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/11/2025-07-11/" class="article-date">
  <time datetime="2025-07-11T00:27:04.000Z" itemprop="datePublished">2025-07-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/11/2025-07-11/">框架之日志管理系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>日志系统功能包括：</p>
<p>1.日志开关。只有开发版本开启日志,因为日志还是比较耗性能的。。。</p>
<p>2.堆栈日志界面：ERROR时弹出界面，该界面显示错误的堆栈日志。大半部分错误日志是不会导致崩溃，如果不弹窗qa可能会漏掉一些重要的log信息。</p>
<p>3.接入SRDebugger，方便在qa测试时，在测试机查看详细的日志信息，方便定位错误出现的原因。</p>
<p>4.FPS帧率的显示</p>
<p>5.游戏正式上线以后，我们很难拿到用户的错误日志，这时候我们需要把错误的日志上传到我们的服务器</p>
<p>6.当游戏崩溃时我们是拿不到unity打印的日志的，这时候就需要接入FireBase了，它可以帮我们把崩溃的详细日志上传到网页上，方便我们查看</p>
<p>日志系统目标用户：</p>
<p>1.qa、运营等测试人员（可以拿到测试机），需要在手机上实现可视化的日志堆栈，方便查阅日志（当然你也可以把手机连到Android Studio和Xcode查看日志，就是比较麻烦而已），对定位bug有很大帮助。</p>
<p>2.用户（获取不到测试机），需要把日志上传到服务器，崩溃日志需要接入FireBase，这样就可以在FB后台看到崩溃的堆栈信息。</p>
<p>一、手机上显示log信息：SRDebugger插件</p>
<p>SRDebugger文档：<a href="https://www.stompyrobot.uk/tools/srdebugger/documentation/" target="_blank" rel="noopener">https://www.stompyrobot.uk/tools/srdebugger/documentation/</a></p>
<p>SRDebugger下载：<a href="https://assetstore.unity.com/packages/tools/gui/srdebugger-console-tools-on-device-27688，" target="_blank" rel="noopener">https://assetstore.unity.com/packages/tools/gui/srdebugger-console-tools-on-device-27688，</a><br>嗯，这个需要30美刀～</p>
<p>SRDebugger界面示例：SRDebugger可以获取当前运行系统的信息，包括操作系统、处理器、显卡等硬件信息。</p>
<p>SRDebugger可以查看所有的程序运行日志，包括使用Debug.Log系列打印的日志，或是其他的未捕获异常。</p>
<p>SRDebugger可以监控整个项目的内存使用信息，手动卸载资源，手动进行GC垃圾回收。</p>
<p>二、日志开关及堆栈信息获取</p>
<p>日志开关无非就是框架封装一层日志接口，所有业务的日志打印都走这个接口，在根据条件判断是否调用Debug.Log方法。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void Log(string log)</span><br><span class="line">    &#123;</span><br><span class="line">        if (Config.LogEnable)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(log);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>日志堆栈信息获取：Application.logMessageReceived接口。每次接收到日志消息，都会触发的事件。注意在logMessageReceived回调里打印任何日志都不会生效（避免死循环）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using System.Collections;</span><br><span class="line"></span><br><span class="line">public class ExampleClass : MonoBehaviour</span><br><span class="line">&#123;</span><br><span class="line">    public string output &#x3D; &quot;&quot;;</span><br><span class="line">    public string stack &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    void OnEnable()</span><br><span class="line">    &#123;</span><br><span class="line">        Application.logMessageReceived +&#x3D; HandleLog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void OnDisable()</span><br><span class="line">    &#123;</span><br><span class="line">        Application.logMessageReceived -&#x3D; HandleLog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void HandleLog(string logString, string stackTrace, LogType type)</span><br><span class="line">    &#123;</span><br><span class="line">        output &#x3D; logString;</span><br><span class="line">        stack &#x3D; stackTrace;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; 摘要:</span><br><span class="line">    &#x2F;&#x2F;     The type of the log message in Debug.logger.Log or delegate registered with Application.RegisterLogCallback.</span><br><span class="line">    public enum LogType</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 摘要:</span><br><span class="line">        &#x2F;&#x2F;     LogType used for Errors.</span><br><span class="line">        Error &#x3D; 0,</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 摘要:</span><br><span class="line">        &#x2F;&#x2F;     LogType used for Asserts. (These could also indicate an error inside Unity itself.)</span><br><span class="line">        Assert &#x3D; 1,</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 摘要:</span><br><span class="line">        &#x2F;&#x2F;     LogType used for Warnings.</span><br><span class="line">        Warning &#x3D; 2,</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 摘要:</span><br><span class="line">        &#x2F;&#x2F;     LogType used for regular log messages.</span><br><span class="line">        Log &#x3D; 3,</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 摘要:</span><br><span class="line">        &#x2F;&#x2F;     LogType used for Exceptions.</span><br><span class="line">        Exception &#x3D; 4</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>logString:日志信息。stackTrace:日志的详细堆栈信息。</p>
<p>那么错误弹窗就是将错误信息以及错误的堆栈信息赋值给Text并显示在界面上。</p>
<p>例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void DevelopLog(string logString, string stackTrace, LogType type)</span><br><span class="line">    &#123;</span><br><span class="line">        if (type &#x3D;&#x3D; LogType.Error || type &#x3D;&#x3D; LogType.Exception)</span><br><span class="line">        &#123;</span><br><span class="line">            string result &#x3D; &quot;LogString:&quot; + logString;</span><br><span class="line">            result +&#x3D; &quot;\nStackTrace:&quot; + stackTrace;</span><br><span class="line">            m_content.text &#x3D; log;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>保存服务端的话就是将上面的result值传给服务端，由服务端保存。当然你也可以额外添加一些参数，例如版本、时间、机型等。例如</p>
<p>string result = string.Format(“Version:{0}\nTime:{0}\nLogString:{1}\nStackTrace:{2}”, Config.Version, Time.time, logString, stackTrace);<br>三、崩溃信息上传FireBase</p>
<p>Android API文档：<a href="https://firebase.google.com/docs/android/setup?hl=zh-cn" target="_blank" rel="noopener">https://firebase.google.com/docs/android/setup?hl=zh-cn</a></p>
<p>Ios API文档：<a href="https://firebase.google.com/docs/ios/setup?hl=zh-cn" target="_blank" rel="noopener">https://firebase.google.com/docs/ios/setup?hl=zh-cn</a></p>
<p>这个两个文档有详细的FireBase后台配置的步骤，以及GoogleService-Info.plist 、google-services.json文件的生成（这两个文件需要放在你的工程目录里）</p>
<p>如果你的sdk或者运营大哥帮你配置好了并给了你GoogleService-Info.plist 、google-services.json文件的话，只需要参考以下步骤就好了。</p>
<p>android：只需要两步，记得把你的google-services.json文件拷贝到项目里</p>
<p>参考：<a href="https://firebase.google.com/docs/crashlytics/get-started?platform=android#android" target="_blank" rel="noopener">https://firebase.google.com/docs/crashlytics/get-started?platform=android#android</a></p>
<p>1.在项目级 build.gradle 中，将您的 google-services 更新为 3.1.2 或更高版本，然后添加 Crashlytics 代码库和依赖项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        &#x2F;&#x2F; Add the following repositories:</span><br><span class="line">        google()  &#x2F;&#x2F; Google&#39;s Maven repository</span><br><span class="line"></span><br><span class="line">        maven &#123;</span><br><span class="line">           url &#39;https:&#x2F;&#x2F;maven.fabric.io&#x2F;public&#39;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Check for v3.1.2 or higher</span><br><span class="line">        classpath &#39;com.google.gms:google-services:4.2.0&#39;  &#x2F;&#x2F; Google Services plugin</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Add dependency</span><br><span class="line">        classpath &#39;io.fabric.tools:gradle:1.29.0&#39;  &#x2F;&#x2F; Crashlytics plugin</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">       &#x2F;&#x2F; Check that you have the following line (if not, add it):</span><br><span class="line">       google()  &#x2F;&#x2F; Google&#39;s Maven repository</span><br><span class="line">       &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.在应用级 build.gradle 中，将 firebase-core 更新为 v11.4.2 或更高版本，然后添加 Crashlytics 依赖项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#39;com.android.application&#39;</span><br><span class="line">apply plugin: &#39;io.fabric&#39;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check for v11.4.2 or higher</span><br><span class="line">    implementation &#39;com.google.firebase:firebase-core:17.0.0&#39;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Add dependency</span><br><span class="line">    implementation &#39;com.crashlytics.sdk.android:crashlytics:2.10.1&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ios参考:<a href="https://firebase.google.com/docs/crashlytics/get-started?platform=ios#android" target="_blank" rel="noopener">https://firebase.google.com/docs/crashlytics/get-started?platform=ios#android</a></p>
<p>1.拉取代码，打开 Podfile，然后添加以下行：</p>
<p>pod ‘Fabric’, ‘<del>&gt; 1.10.2’<br>pod ‘Crashlytics’, ‘</del>&gt; 3.13.3’<br>2.初始化</p>
<p> 如果你的ios端提示dsym未上传，可以用命令行上传（比较耗时间，建议只在正式包上传），命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;path&#x2F;to&#x2F;pods&#x2F;directory&#x2F;Fabric&#x2F;upload-symbols -gsp &#x2F;path&#x2F;to&#x2F;GoogleService-Info.plist -p ios &#x2F;path&#x2F;to&#x2F;dSYMs</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;这边的self.OutProjectPath是你的xcode项目目录</span><br><span class="line">cmddSYM &#x3D; &quot;%sPods&#x2F;Fabric&#x2F;upload-symbols -gsp %sGoogleService-Info.plist -p ios %sarchive&#x2F;SF.xcarchive&#x2F;dSYMs&quot; % (self.OutProjectPath, self.OutProjectPath, self.OutProjectPath)</span><br></pre></td></tr></table></figure>
<p>DSYM丢失参考api：<a href="https://firebase.google.com/docs/crashlytics/get-deobfuscated-reports?authuser=0" target="_blank" rel="noopener">https://firebase.google.com/docs/crashlytics/get-deobfuscated-reports?authuser=0</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/11/2025-07-11/" data-id="cmd12rpsr0001clz863p68tpg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity/" rel="tag">unity</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-12" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/10/2025-07-12/" class="article-date">
  <time datetime="2025-07-10T00:27:05.000Z" itemprop="datePublished">2025-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/10/2025-07-12/">unity 一键打包</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>注意事项：</p>
<p>1.python如何解析命令行参数</p>
<p>2.python如何调用unity命令进行打包</p>
<p>3.unity如何解析命令行参数，例如命令行传过来的：</p>
<p>‘“%s” -batchmode -projectPath %s -executeMethod ExportProject.Build name:”%s” output:”%s” id:”%s” symbols:”%s” development:%s release:%s language:%s checkupdate:%s expansion:%s version:”%s” compatibility:%s -quit -logFile ./log/%s’</p>
<p>其中name是bundleid，识别平台、是否是测试包等，release是否是正式包等等参数。</p>
<p>4.如何更新git</p>
<p>5.unity一键导出图集、ab包名字，生个成功md5文件</p>
<p>6.配制参数导出到两端平台</p>
<p>ios：修改info.plist文件</p>
<p>android：将配置保存成java可以解析的本地文件，例如json.properties文件，在导出结束后拷贝到android工程目录下。</p>
<p>详细步骤：</p>
<p>1.python调用unity命令，通知unity打包AssetBundle.</p>
<p>1-1.更新git</p>
<p>1-2.一键设置图集</p>
<p>1-3.一键设置ab包</p>
<p>1-4.生成ab包</p>
<p>1-5.压缩ab包（可选）</p>
<p>1-6.生成md5文件</p>
<p>2.python调用unity命令，导出工程。（正常打包）</p>
<p>2-1.导出工程</p>
<p>2-2.导出配置文件，如app id,app key。</p>
<p>3.python调用两端命令进行打包。（正常打包）</p>
<p>3-1.python拷贝文件，组合unity导出项目和两端备份工程。</p>
<p>3-2.android端调用：./gradlew assembleNormal</p>
<p>3-3.ios端先调用pod repo update（可选，看sdk是否从远端拉取），在调用cmdBuild = ‘xcodebuild archive  -workspace Unity-iPhone.xcworkspace  -scheme Unity-iPhone -archivePath %s || exit ‘%(archivePath)生成archive 包，最后调用cmdIpa = ‘xcodebuild -exportArchive -archivePath %s -exportPath %s -exportOptionsPlist &quot;%s/config/ad-hoc.plist&quot;‘ % (archivePath, ipaDir, self.CurrPath)生成ipa。</p>
<p>4.python将变更的ab包以及md5文件上传网站（热更）</p>
<p>下面对一些关键步骤进行详细分析</p>
<p>一、python如何解析命令行参数</p>
<p>api使用：<a href="https://docs.python.org/zh-cn/3/howto/argparse.html" target="_blank" rel="noopener">https://docs.python.org/zh-cn/3/howto/argparse.html</a></p>
<p>API：<a href="https://docs.python.org/zh-cn/3/library/argparse.html#action。" target="_blank" rel="noopener">https://docs.python.org/zh-cn/3/library/argparse.html#action。</a></p>
<p>看完这两篇，解析参数其实很简单～</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import argparse</span><br><span class="line">import configparser</span><br><span class="line"></span><br><span class="line">def Run(self):</span><br><span class="line">        parser &#x3D; argparse.ArgumentParser()</span><br><span class="line">        </span><br><span class="line">        group &#x3D; parser.add_mutually_exclusive_group()</span><br><span class="line">        group.add_argument(&quot;-f&quot;, action&#x3D;&quot;store_true&quot;, help&#x3D;&quot;打完整包&quot;)</span><br><span class="line">　　　　</span><br><span class="line">        args &#x3D; parser.parse_args()</span><br></pre></td></tr></table></figure>
<p>如上所示，使用python的库即可解析命令行的参数</p>
<p>1.创建一个解析器：parser = argparse.ArgumentParser()</p>
<p>2.添加解析器要解析的参数add_argument</p>
<p>ArgumentParser.add_argument(name or flags…[, action][, nargs][, const][, default][, type][, choices][, required][, help][, metavar][, dest])<br>name or flags:参数的flag（名字），例如：foo 或 -f, —foo。注意不带-的参数是必须输入的，带-的是可选参数，可以不再命令行输入。</p>
<p>action:获取的参数该采取何种提取方式。例如action=”store_true”，那么命令行有输入参数时，该参数为true，否则为false。action=”store_const”，那么参数等于const的值</p>
<p>const: 被一些 action 和 nargs 选择所需求的常数</p>
<p>default: 当参数未在命令行中出现时使用的值。</p>
<p>type: 命令行参数应当被转换成的类型。默认是string型</p>
<p>choice: 参数允许的值。例如choice = [0,1,2]那么参数值只能是这三个中的一个</p>
<p>help: 对该参数的简要说明。</p>
<p>3.ArgumentParser 通过 parse_args() 方法解析参数。它将检查命令行，把每个参数转换为适当的类型然后调用相应的操作。</p>
<p>二、python如何调用unity打包</p>
<p>这边应该是命令行如何调用。</p>
<p>API说明：<a href="https://docs.unity3d.com/Manual/CommandLineArguments.html" target="_blank" rel="noopener">https://docs.unity3d.com/Manual/CommandLineArguments.html</a></p>
<p>fumExport = “&quot;%s&quot; -batchmode -projectPath %s -executeMethod ExportAssetBundle.Build symbols:&quot;%s&quot; checkupdate:%s -quit -logFile ./log/%s”<br>cmdExport = fumExport%(self.UnityPath, self.ProjectPath,self.BaseSymbols, checkupdate, logFileName)<br>主要关注以下几个参数，参数间以空格隔开</p>
<p>1.-batchmode：打开unity，但不会弹出unity界面。需要确保要打开的项目没有被unity打开，不然会报错，一次只能运行一个Unity项目实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Run Unity in batch mode. You should always use this in conjunction with the other command line arguments, because it ensures no pop-up windows appear and eliminates the need for any human intervention. </span><br><span class="line">When an exception occurs during execution of the script code, the Asset server updates fail, or other operations fail, Unity immediately exits with return code 1. </span><br><span class="line">Note that in batch mode, Unity sends a minimal version of its log output to the console. However, the Log Files still contain the full log information. </span><br><span class="line">You cannot open a project in batch mode while the Editor has the same project open; only a single instance of Unity can run at a time.</span><br><span class="line">Tip: To check whether you are running the Editor or Standalone Player in batch mode, use the Application.isBatchMode operator.</span><br><span class="line"></span><br><span class="line">If the project has not yet been imported when using -batchmode, the target platform is the default one. To force a different platform when using -batchmode, use the -buildTarget option.</span><br></pre></td></tr></table></figure>
<p>2.-projectPath：要打开的unity工程路径</p>
<p>3.-executeMethod：要触发的unity方法，该方法必须是静态方法且放在Editor目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Execute the static method as soon as Unity opens the project, and after the optional Asset server update is complete.</span><br><span class="line">You can use this to do tasks such as continous integration, performing Unit Tests, making builds or preparing data. </span><br><span class="line">To return an error from the command line process, either throw an exception which causes Unity to exit with return code 1, or call EditorApplication.Exit with a non-zero return code. </span><br><span class="line">To pass parameters, add them to the command line and retrieve them inside the function using System.Environment.GetCommandLineArgs. </span><br><span class="line">To use -executeMethod, you need to place the enclosing script in an Editor folder. The method you execute must be defined as static.</span><br></pre></td></tr></table></figure>
<p>4.-quit：退出unity</p>
<p>5.-logFile：log的输出路径，方便在命令失败时查看日志</p>
<p>6.-buildTarget：指定目标平台。建议每个平台拷贝一份unity项目而不是通过这个参数指定平台</p>
<p>三、unity如何解析命令行参数</p>
<p>使用c# 的Environment.GetCommandLineArgs方法可以获取到命令行的参数列表</p>
<p>//Returns a string array containing the command-line arguments for the current process.<br>public static string[] GetCommandLineArgs ();<br>建议使用键值对的方式定义参数，方便解析和理解。例如symbols:”1” checkupdate:0。解析如下，key对应参数名字如symbols</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static string GetValueFromArgs(string key, string defaultValue)</span><br><span class="line">    &#123;</span><br><span class="line">        string ret &#x3D; defaultValue;</span><br><span class="line">        foreach (string arg in System.Environment.GetCommandLineArgs())</span><br><span class="line">        &#123;</span><br><span class="line">            if (arg.StartsWith(key))</span><br><span class="line">            &#123;</span><br><span class="line">                ret &#x3D; arg.Split(&quot;:&quot;[0])[1];</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>四、如何同步git代码？</p>
<p>git:定位到你的git目录（cd），然后调用’git pull’命令</p>
<p>那么在unity可以调用命令行吗？  可以的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static void ProcessCommand(string command, string argument, string workingdir)</span><br><span class="line">    &#123;</span><br><span class="line">        ProcessStartInfo start &#x3D; new ProcessStartInfo(command)</span><br><span class="line">        &#123;</span><br><span class="line">            Arguments &#x3D; argument,</span><br><span class="line">            CreateNoWindow &#x3D; false,</span><br><span class="line">            ErrorDialog &#x3D; true,</span><br><span class="line">            UseShellExecute &#x3D; true,</span><br><span class="line">            WorkingDirectory &#x3D; workingdir</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Process p &#x3D; Process.Start (start);</span><br><span class="line"></span><br><span class="line">        p.WaitForExit ();</span><br><span class="line">        p.Close ();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>调用：</p>
<p>ShellHelper.ProcessCommand (“git”, “pull”, loadDir);<br>五、如何统一设置图集</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private static void SetSingleAtlasName(string strFile)</span><br><span class="line">&#123;</span><br><span class="line">    string strPath &#x3D; Path.GetDirectoryName (strFile);</span><br><span class="line">    string strSPName &#x3D; GetSpriteNameFromPath (strPath);</span><br><span class="line"></span><br><span class="line">    TextureImporter importer &#x3D; TextureImporter.GetAtPath (strFile) as TextureImporter;</span><br><span class="line">    if(importer&#x3D;&#x3D;null)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogErrorFormat (&quot;Import atlas:&#123;0&#125;, is not a texture!&quot;, strFile);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    Debug.LogFormat (&quot;TextureImport:&#123;0&#125;--&gt;spname:&#123;1&#125;&quot;, strFile, strSPName);</span><br><span class="line">    if(importer.textureType !&#x3D; TextureImporterType.Sprite)</span><br><span class="line">    &#123;</span><br><span class="line">         return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(importer.spritePackingTag!&#x3D;strSPName)</span><br><span class="line">    &#123;</span><br><span class="line">        importer.spritePackingTag &#x3D; strSPName;</span><br><span class="line">        importer.SaveAndReimport ();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static string GetSpriteNameFromPath(string strSpritePath)</span><br><span class="line">&#123;</span><br><span class="line">   strSpritePath &#x3D; strSpritePath.Replace (&quot;&#x2F;&quot;, &quot;_&quot;);</span><br><span class="line">   string strAtlasName &#x3D; strSpritePath.Replace (&quot;Assets_Art_&quot;, &quot;&quot;).Replace (&quot;Assets_Data_&quot;, &quot;&quot;).ToLower();</span><br><span class="line">   return strAtlasName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，核心是GetSpriteNameFromPath和importer.spritePackingTag。GetSpriteNameFromPath通过图片的目录获取图片的图集名字，importer.spritePackingTag设置图片的名字。使用时需要将每个要打图集的.pngg文件调用此方法。获取某个目录下的.png文件方法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">string[] arrFiles &#x3D; FileHelper.GetAllChildFiles (strPath, &quot;.png&quot;, SearchOption.AllDirectories);</span><br><span class="line">int len &#x3D; arrFiles.Length;</span><br><span class="line">for(int i&#x3D;0; i&lt;len; i++)</span><br><span class="line">&#123;</span><br><span class="line">    string strFile &#x3D; arrFiles [i];</span><br><span class="line">    SetSingleAtlasName (strFile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>六、如何统一设置ab包并生成md5</p>
<p>这边需要注意的是，业务传入文件名，框架如何加载到对应的ab包并加载出asset。</p>
<p>一个可行的方法是把文件的文件名和文件的ab包名字作一个映射并保存到本地，框架加载ab包时先加载该配置并获取对应的ab包名字。</p>
<p>核心的方法是unity设置ab包的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">　　　　&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; 摘要:</span><br><span class="line">&#x2F;&#x2F;     Set the AssetBundle name and variant.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; 参数:</span><br><span class="line">&#x2F;&#x2F;   assetBundleName:</span><br><span class="line">&#x2F;&#x2F;     AssetBundle name.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;   assetBundleVariant:</span><br><span class="line">&#x2F;&#x2F;     AssetBundle variant.</span><br><span class="line">[GeneratedByOldBindingsGenerator]</span><br><span class="line">public void SetAssetBundleNameAndVariant(string assetBundleName, string assetBundleVariant);</span><br></pre></td></tr></table></figure>
<p>详细代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Text;</span><br><span class="line">using UnityEditor;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">public class ImporterAssetBundle</span><br><span class="line">&#123;</span><br><span class="line">    static Dictionary&lt;string, string&gt; ms_uiBundles &#x3D; new Dictionary&lt;string, string&gt;();</span><br><span class="line">    public static void Reimport(bool buildLua &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        ClearBundleName();</span><br><span class="line">        ms_uiBundles.Clear();</span><br><span class="line"></span><br><span class="line">        ImportAll();</span><br><span class="line"></span><br><span class="line">        AssetDatabase.RemoveUnusedAssetBundleNames();</span><br><span class="line">        AssetDatabase.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 清除AssetBundle设置</span><br><span class="line">    public static void ClearBundleName()</span><br><span class="line">    &#123;</span><br><span class="line">        var names &#x3D; AssetDatabase.GetAllAssetBundleNames();</span><br><span class="line">        foreach (string name in names)</span><br><span class="line">        &#123;</span><br><span class="line">            AssetDatabase.RemoveAssetBundleName(name, true);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void ImportAll()</span><br><span class="line">    &#123;</span><br><span class="line">        ImportSubPath(&quot;Assets&#x2F;Data&#x2F;city&#x2F;sky&quot;, &quot;city&#x2F;sky&#x2F;&quot;, true);</span><br><span class="line">        ImportFilesInPath(&quot;Assets&#x2F;Data&#x2F;city&#x2F;buildingpart&quot;, &quot;city&#x2F;buildingpart&#x2F;&quot;, true);</span><br><span class="line">        ImportSingleFile(&quot;Assets&#x2F;Data&#x2F;city&#x2F;other&quot;, &quot;city&#x2F;other&quot;, true);</span><br><span class="line"></span><br><span class="line">        SaveBundleList(ms_uiBundles, &quot;BundleDefine&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static bool CheckStringInArray(string[] arrStr, string value)</span><br><span class="line">    &#123;</span><br><span class="line">        if (arrStr &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; arrStr.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            if (arrStr[i] &#x3D;&#x3D; value)</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;获取所有子文件</span><br><span class="line">    public static string[] GetAllChildFiles(string path, string suffix &#x3D; &quot;&quot;, SearchOption option &#x3D; SearchOption.AllDirectories)</span><br><span class="line">    &#123;</span><br><span class="line">        string strPattner &#x3D; &quot;*&quot;;</span><br><span class="line">        if (suffix.Length &gt; 0 &amp;&amp; suffix[0] !&#x3D; &#39;.&#39;)</span><br><span class="line">        &#123;</span><br><span class="line">            strPattner +&#x3D; &quot;.&quot; + suffix;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            strPattner +&#x3D; suffix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] files &#x3D; Directory.GetFiles(path, strPattner, option);</span><br><span class="line"></span><br><span class="line">        return files;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #region 导入功能函数</span><br><span class="line">    &#x2F;&#x2F; 将路径下的子路径，按目录设置Bundle</span><br><span class="line">    private static void ImportSubPath(string strPath, string abHead, bool bAddDefine, string[] excludes &#x3D; null)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!Directory.Exists(strPath))</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] allChilds &#x3D; Directory.GetDirectories(strPath);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; allChilds.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            string childPath &#x3D; allChilds[i];</span><br><span class="line">            if (excludes !&#x3D; null &amp;&amp; CheckStringInArray(excludes, childPath))</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            string strPathName &#x3D; childPath.Replace(&#39;\\&#39;, &#39;&#x2F;&#39;);</span><br><span class="line">            strPathName &#x3D; strPathName.Substring(strPathName.LastIndexOf(&#39;&#x2F;&#39;) + 1);</span><br><span class="line">            string strAbName &#x3D; abHead + strPathName;</span><br><span class="line"></span><br><span class="line">            ImportSingleFile(childPath, strAbName, bAddDefine);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 将路径下的每个文件导出成独立的Bundle 只处理一级文件</span><br><span class="line">    private static void ImportFilesInPath(string path, string abHead, bool bAddDefine, string suffix &#x3D; &quot;&quot;, string[] excludes &#x3D; null, SearchOption option &#x3D; SearchOption.TopDirectoryOnly)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!Directory.Exists(path))</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] allFiles &#x3D; GetAllChildFiles(path, suffix, option);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; allFiles.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            string file &#x3D; allFiles[i];</span><br><span class="line">            if (file.EndsWith(&quot;.meta&quot;) || file.EndsWith(&quot;txt&quot;))</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            string strFileName &#x3D; Path.GetFileNameWithoutExtension(file);</span><br><span class="line">            if (excludes !&#x3D; null &amp;&amp; CheckStringInArray(excludes, strFileName))</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            string abName &#x3D; abHead + strFileName;</span><br><span class="line">            ImportSingleFile(file, abName, bAddDefine);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 设置单个文件（或目录）的ABName</span><br><span class="line">    private static void ImportSingleFile(string Path, string abName, bool bAddDefine)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetImporter importer &#x3D; AssetImporter.GetAtPath(Path);</span><br><span class="line">        if (bAddDefine)</span><br><span class="line">        &#123;</span><br><span class="line">            AddBundleDefine(Path, abName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (importer &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        abName &#x3D; abName.Replace(&#39;\\&#39;, &#39;_&#39;).Replace(&#39;&#x2F;&#39;, &#39;_&#39;);</span><br><span class="line">        importer.SetAssetBundleNameAndVariant(abName, &quot;unity3d&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    private static void AddBundleDefine(string strPath, string strABName)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;如果是一个路径 才需要添加到字典</span><br><span class="line">        if (Directory.Exists(strPath))</span><br><span class="line">        &#123;</span><br><span class="line">            string[] files &#x3D; Directory.GetFiles(strPath, &quot;*&quot;, SearchOption.AllDirectories);</span><br><span class="line">            for (int i &#x3D; 0; i &lt; files.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                string filename &#x3D; files[i];</span><br><span class="line">                if (filename.EndsWith(&quot;.meta&quot;))</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                AddToBundleDic(filename, strABName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (File.Exists(strPath))</span><br><span class="line">        &#123;</span><br><span class="line">            AddToBundleDic(strPath, strABName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void AddToBundleDic(string strFileName, string strABName)</span><br><span class="line">    &#123;</span><br><span class="line">        string strExtension &#x3D; Path.GetExtension(strFileName);</span><br><span class="line">        string fullName &#x3D; strFileName.Replace(&quot;Assets&#x2F;Data&#x2F;&quot;, &quot;&quot;).Replace(strExtension, &quot;&quot;).Replace(&quot;\\&quot;, &quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        if (ms_uiBundles.ContainsKey(fullName))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;文件名字重复:&#123;0&#125;, strABName old:&#123;1&#125;, new:&#123;2&#125;&quot;, strFileName, ms_uiBundles[fullName], strABName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ms_uiBundles[fullName] &#x3D; strABName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static void SaveBundleList(Dictionary&lt;string, string&gt; dicAB, string strFileName)</span><br><span class="line">    &#123;</span><br><span class="line">        string strSaveFile &#x3D; string.Format(&quot;Assets&#x2F;Lua&#x2F;game&#x2F;define&#x2F;&#123;0&#125;.lua&quot;, strFileName);</span><br><span class="line">        &#x2F;&#x2F; 保存到文件</span><br><span class="line">        StringBuilder builder &#x3D; new StringBuilder();</span><br><span class="line">        builder.AppendLine(&quot;-- Create by Tool, don&#96;t modify&quot;);</span><br><span class="line">        builder.AppendLine();</span><br><span class="line"></span><br><span class="line">        string strHeadLine &#x3D; strFileName + &quot; &#x3D; &#123;&quot;;</span><br><span class="line">        builder.AppendLine(strHeadLine);</span><br><span class="line">        &#123;</span><br><span class="line">            var iter &#x3D; dicAB.GetEnumerator();</span><br><span class="line">            while (iter.MoveNext())</span><br><span class="line">            &#123;</span><br><span class="line">                string prefabName &#x3D; iter.Current.Key.Replace(&quot;\\&quot;, &quot;&#x2F;&quot;).ToLower();</span><br><span class="line">                string abName &#x3D; iter.Current.Value.Replace(&quot;\\&quot;, &quot;&#x2F;&quot;).ToLower();</span><br><span class="line">                builder.AppendFormat(&quot;\t[\&quot;&#123;0&#125;\&quot;] &#x3D; \&quot;&#123;1&#125;\&quot;,\n&quot;, prefabName, abName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        builder.AppendLine(&quot;&#125;&quot;);</span><br><span class="line">        builder.AppendLine();</span><br><span class="line">        builder.AppendLine(&quot;--EOF&quot;);</span><br><span class="line"></span><br><span class="line">        FileHelper.SaveTextToFile(builder.ToString(), strSaveFile);</span><br><span class="line">        EditorHelper.EditorSaveFile(strSaveFile);</span><br><span class="line"></span><br><span class="line">        ms_uiBundles.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成ab包：ab包的压缩模式选择：<a href="https://docs.unity3d.com/Manual/AssetBundles-Building.html" target="_blank" rel="noopener">https://docs.unity3d.com/Manual/AssetBundles-Building.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> public static void BuildAssetBundle()</span><br><span class="line">&#123;</span><br><span class="line">   string pathDst &#x3D; AssetBundlePath;</span><br><span class="line">   FileHelper.CreateDirectory (pathDst);</span><br><span class="line"></span><br><span class="line">   BuildAssetBundleOptions options &#x3D; BuildAssetBundleOptions.DeterministicAssetBundle;</span><br><span class="line">   options |&#x3D; BuildAssetBundleOptions.ChunkBasedCompression;</span><br><span class="line"></span><br><span class="line">   BuildPipeline.BuildAssetBundles (pathDst, options, EditorUserBuildSettings.activeBuildTarget);</span><br><span class="line">   AssetDatabase.Refresh ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>md5生成：md5用于热更时判断一个文件是否需要更新（只有变化的文件md5才会变更改）</p>
<p>FileStream fs = File.OpenRead(filePath)<br>MD5 md5 = MD5.Create();<br>byte[]　fileMd5Bytes=md5.ComputeHash(fs);//计算FileStream 对象的哈希值<br>fileMd5　＝　System.BitConverter.ToString(fileMd5Bytes).Replace(“-“, “”).ToLower();<br>七、如何导出包给两端使用</p>
<p>获取当前项目的平台：BuildTarget target = EditorUserBuildSettings.activeBuildTarget;</p>
<p>如果使用xcode\as等进行打包，options需要设置成BuildOptions options = BuildOptions.AcceptExternalModificationsToPlayer;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">On iOS, this setting will append an existing Xcode project. Existing Xcode project setting changes will be preserved. With the IL2CPP scripting backend, this setting will also allow incremental builds of the generated C++ code to work in Xcode.</span><br><span class="line"></span><br><span class="line">On Android, this setting will create a new Eclipse project. Existing Eclipse project setting changes will be discarded.</span><br></pre></td></tr></table></figure>
<p>当然你也可以拼接多个option</p>
<p>if (CommandHelper.IsDevelopment) {<br>    options |= BuildOptions.Development;<br>    options |= BuildOptions.AllowDebugging;<br>}<br>八、如何调用as命令生成apk，如何调用xcode生成ipa</p>
<p>主要就是下面两行命令</p>
<p>cmdBuild = ‘xcodebuild archive  -workspace Unity-iPhone.xcworkspace  -scheme Unity-iPhone -archivePath %s || exit ‘%(archivePath)<br>cmdIpa = ‘xcodebuild -exportArchive -archivePath %s -exportPath %s -exportOptionsPlist &quot;%s/config/ad-hoc.plist&quot;‘ % (archivePath, ipaDir, self.CurrPath)<br>archive参数如下，如果使用CocoaPod,workspace必须传，scheme不传则默认为项目第一个Target。archivePath为archive包存储路径。其余参数可不传</p>
<p>exportArchive ，导出ipa，参数如下：archivePath上面的archivePath路径。exportPath ：ipa导出路径。exportOptionsPlist ：list文件</p>
<p>android 端直接调用：./gradlew assembleNormal就好了</p>
<p>九、如何导出配置给两个端使用</p>
<p>1.ios直接修改info.plist文件和项目设置项</p>
<p>首先我们需要了解OnPostprocessBuild方法。就是说unity每次build完后都会回调这个方法，该方法有两个参数，一个是xcode的Target，一个是导出的工程目录。我们可以在这个回调里设置证书、权限、白名单等信息</p>
<p>Implement this function to receive a callback after the build is complete.<br>示例如下，具体可以参考API：<a href="https://docs.unity3d.com/ScriptReference/iOS.Xcode.PBXProject.html。主要是PBXProject这个API" target="_blank" rel="noopener">https://docs.unity3d.com/ScriptReference/iOS.Xcode.PBXProject.html。主要是PBXProject这个API</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">　　[PostProcessBuild]</span><br><span class="line">static void OnPostprocessBuild(BuildTarget target, string pathToBuildProject)&#123;</span><br><span class="line">    &#x2F;&#x2F;pathToBuildProject unity export路径</span><br><span class="line">    EditProject(pathToBuildProject);&#x2F;&#x2F;添加framework、设置证书</span><br><span class="line">    EditPlist (pathToBuildProject);&#x2F;&#x2F;配置appid等、设置白名单、权限</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">　　static void EditProject(string path)</span><br><span class="line">&#123;</span><br><span class="line">    string projPath &#x3D; PBXProject.GetPBXProjectPath(path);</span><br><span class="line">    PBXProject pbxProj &#x3D; new PBXProject();</span><br><span class="line">    pbxProj.ReadFromString(File.ReadAllText(projPath));</span><br><span class="line"></span><br><span class="line">    string target &#x3D; pbxProj.TargetGuidByName(&quot;Unity-iPhone&quot;);</span><br><span class="line">    if (!string.IsNullOrEmpty(target))</span><br><span class="line">    &#123;</span><br><span class="line">        pbxProj.RemoveFrameworkFromProject(target, &quot;libiconv.2.dylib&quot;);</span><br><span class="line">        pbxProj.AddFrameworkToProject(target, &quot;AdSupport.framework&quot;, true); &#x2F;&#x2F;用于firebase推送</span><br><span class="line"></span><br><span class="line">        pbxProj.SetBuildProperty(target, &quot;ENABLE_BITCODE&quot;, &quot;false&quot;);</span><br><span class="line">        pbxProj.SetBuildProperty(target, &quot;DEVELOPMENT_TEAM&quot;, GetTeamId());</span><br><span class="line">        pbxProj.SetBuildProperty(target, &quot;CODE_SIGN_IDENTITY&quot;, GetCertificate()); &#x2F;&#x2F;证书</span><br><span class="line">        pbxProj.SetBuildProperty(target, &quot;PROVISIONING_PROFILE&quot;, GetProfiles());&#x2F;&#x2F;描述文件</span><br><span class="line"></span><br><span class="line">        string googleServicedir &#x3D; ConfigHelper.IsDeveloper ? &quot;develop&quot; : &quot;release&quot;;</span><br><span class="line">        string rootGoogleServicepath &#x3D; string.Format(&quot;&#123;0&#125;&#x2F;..&#x2F;Config&#x2F;GoogleService&#x2F;&quot;, Application.dataPath) + googleServicedir;</span><br><span class="line">        FileCopy(rootGoogleServicepath, path);</span><br><span class="line">        pbxProj.AddFileToBuild(target, pbxProj.AddFile(path + &quot;&#x2F;GoogleService-Info.plist&quot;, &quot;GoogleService-Info.plist&quot;, PBXSourceTree.Build));</span><br><span class="line">        pbxProj.AddFileToBuild(target, pbxProj.AddFile(path + &quot;&#x2F;OMTService-Info.plist&quot;, &quot;OMTService-Info.plist&quot;, PBXSourceTree.Build));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    File.WriteAllText(projPath, pbxProj.WriteToString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 这是plist</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;pathToBuildProject&quot;&gt;Path to build project.&lt;&#x2F;param&gt;</span><br><span class="line">static void EditPlist(string pathToBuildProject)</span><br><span class="line">&#123;</span><br><span class="line">    string _plistPath &#x3D; pathToBuildProject + &quot;&#x2F;Info.plist&quot;;</span><br><span class="line">    PlistDocument _plist &#x3D; new PlistDocument();</span><br><span class="line"></span><br><span class="line">    _plist.ReadFromString(File.ReadAllText(_plistPath));</span><br><span class="line">    PlistElementDict _rootDic &#x3D; _plist.root;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;添加Scheme白名单</span><br><span class="line">    PlistElementArray _array2 &#x3D; _rootDic.CreateArray(&quot;LSApplicationQueriesSchemes&quot;);</span><br><span class="line">    _array2.AddString(&quot;fbapi&quot;);</span><br><span class="line">    _array2.AddString(&quot;fb-messenger-api&quot;);</span><br><span class="line">    _array2.AddString(&quot;fbauth2&quot;);</span><br><span class="line">    _array2.AddString(&quot;fbshareextension&quot;);</span><br><span class="line">    _array2.AddString(&quot;gamcoios&quot;);</span><br><span class="line">    _array2.AddString(&quot;whatsapp&quot;);</span><br><span class="line">    _array2.AddString(&quot;twitter&quot;);</span><br><span class="line">    _array2.AddString(&quot;twitterauth&quot;);</span><br><span class="line">    _array2.AddString(&quot;instagram&quot;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;配置权限</span><br><span class="line">    _rootDic.SetString(&quot;NSPhotoLibraryUsageDescription&quot;, SDKConfig.PhotoDesc);</span><br><span class="line">    _rootDic.SetString(&quot;NSMicrophoneUsageDescription&quot;, SDKConfig.MicrophoneDes);</span><br><span class="line">    _rootDic.SetString(&quot;NSPhotoLibraryAddUsageDescription&quot;, SDKConfig.PhotoAddDesc);</span><br><span class="line">    _rootDic.SetString(&quot;NSCameraUsageDescription&quot;, SDKConfig.CameraDes);</span><br><span class="line">    _rootDic.SetString(&quot;NSLocationWhenInUseUsageDescription&quot;, SDKConfig.LocationDes);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;正式版&#x2F;测试版</span><br><span class="line">    _rootDic.SetBoolean(&quot;DebugMode&quot;, ConfigHelper.IsDeveloper);</span><br><span class="line"></span><br><span class="line">    File.WriteAllText(_plistPath, _plist.WriteToString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>2.Android端：通过json或.properties文件存储，然后拷贝到android目录下就好了。以下以.properties文件作为实例</p>
<p>c#端存储：FileHelper.SaveTextToFile只是调用file.write方法，把字符串写进文件里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">System.Text.StringBuilder sb &#x3D; new System.Text.StringBuilder();</span><br><span class="line">sb.AppendFormat(&quot;GAME_NAME&#x3D;&#123;0&#125;\n&quot;, ConfigHelper.GameName);</span><br><span class="line">sb.AppendFormat(&quot;VERSION_NAME&#x3D;&#123;0&#125;\n&quot;, ConfigHelper.Version);</span><br><span class="line">sb.AppendFormat(&quot;VERSION_CODE&#x3D;&#123;0&#125;\n&quot;, ConfigHelper.BuildNo);</span><br><span class="line">sb.AppendFormat(&quot;BUNDLE_IDENTIFIER&#x3D;&#123;0&#125;\n&quot;, CommandHelper.BundleIdentifier);</span><br><span class="line">sb.AppendFormat(&quot;IS_DEVELOPER&#x3D;&#123;0&#125;\n&quot;, ConfigHelper.IsDeveloper);</span><br><span class="line">sb.AppendFormat(&quot;IABKEY&#x3D;&#123;0&#125;\n&quot;, SDKConfig.IABKey);</span><br><span class="line"></span><br><span class="line">FileHelper.SaveTextToFile(sb.ToString(), string.Format(&quot;&#123;0&#125;&#x2F;&#123;1&#125;&#x2F;version.properties&quot;, CommandHelper.OutputPath, CommandHelper.ProjectName));</span><br></pre></td></tr></table></figure>
<p>android端读取：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">　　def verName &#x3D; &quot;1.0.0&quot;</span><br><span class="line">def verCode &#x3D; 8</span><br><span class="line">def bundleId &#x3D; &quot;and.onemt.sf.ar&quot;</span><br><span class="line">def isDeveloper &#x3D; false</span><br><span class="line">def iabKey &#x3D; &quot;&quot;</span><br><span class="line">def name &#x3D; &quot;@string&#x2F;app_name&quot;</span><br><span class="line"></span><br><span class="line">def versionPropsFile &#x3D; file(&#39;version.properties&#39;)</span><br><span class="line"></span><br><span class="line">if (versionPropsFile.canRead()) &#123;</span><br><span class="line">    def Properties versionProps &#x3D; new Properties()</span><br><span class="line">    versionProps.load(new FileInputStream(versionPropsFile))</span><br><span class="line">    verName &#x3D; versionProps[&#39;VERSION_NAME&#39;]</span><br><span class="line">    verCode &#x3D; versionProps[&#39;VERSION_CODE&#39;].toInteger()</span><br><span class="line">    bundleId &#x3D; versionProps[&#39;BUNDLE_IDENTIFIER&#39;]</span><br><span class="line">    isDeveloper &#x3D; versionProps[&#39;IS_DEVELOPER&#39;]</span><br><span class="line"></span><br><span class="line">    iabKey &#x3D; versionProps[&#39;IABKEY&#39;]</span><br><span class="line">    if (&quot;True&quot;.equalsIgnoreCase(isDeveloper)) &#123;</span><br><span class="line">        name &#x3D; &quot;@string&#x2F;app_name_test&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意 ：一键打包只有购买了Unity Pro才能使用，免费版只能手动打包。 IOS打IPA 包，需要购买开发者证书，并且需要真机调试。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/10/2025-07-12/" data-id="cmd12rpt60005clz859vx7sit" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity-python/" rel="tag">unity python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-10" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/10/2025-07-10/" class="article-date">
  <time datetime="2025-07-10T00:27:04.000Z" itemprop="datePublished">2025-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/10/2025-07-10/">Unity UI框架总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>目前出海的手游的开发过程中，大部分业务玩法都是围绕着UI进行的。一个玩法业务不管是大型还是小型，UI上能占用40%-60%的工作量，不过当然也与玩法类型也有关系，玩法越偏3D，UI占有率越低，玩法越偏2D，UI占有率就越高，比如我们公司的Slot，甚至能达到99%。作为一个拥有8年多的U3D工作经验，曾经工作中大部分都跟UI息息相关，积累了不少的工作经验。趁现在空闲时间比较多，整理一下对UI框架的理解。</p>
<p>一个好用的UI框架应该具备哪些功能呢？我认为应该具备以下功能：<br>支持UI的OnCreate，OnEnable，OnDisable，OnDestroy, Update等这些基本事件回调的编写，我们的日常工作大多也是基于这些回调进行功能上的开发。<br>支持多个不同的层次栈，多个栈可以处理不同层级需求。新界面一定处理层次栈节点的末尾。<br>支持多个不同的显示栈，每个显示栈只能有一个UI进行显示。控制打开新界面时，是否隐藏当前显示的界面。关闭新界面时，恢复对隐藏界面的显示。<br>尽量代码逻辑处理要做到同步，不要让业务人员去思考异步代码的编写，因为这还涉及异步资源的释放，会导致日常开发的困难。<br>UI自己申请的资源要自己做到释放，比如在Enable有自动注册一些功能，例如事件监听，需要在Disable去主动的解绑，避免业务人员在开发过程还要大量思考内存泄露问题。<br>需要有定时销毁UI的功能，避免一些关闭的UI长时间占据内存。<br>支持自定义参数传递，需要从父UI传递到子UI。在开发成就相关的功能时，常常需要我们跳转到相关的界面，并且还要在对应的界面进行一些展示处理。<br>同时打开多个UI时，要根据调用打开的接口的顺序按序显示UI，而非通过资源加载完成后的顺序去显示。<br>UI框架要维护好已打开界面的缓存和释放，避免界面频繁重新加载，以及不能释放导致的内存泄露问题。</p>
<p>本文提出的UI架构，是基于Lua实现的，在Slot游戏中得到的充分的验证，支持全UI游戏。智能动态适配、高效资源管理、深度层级控制。<br>该架构采用”分层-分治”设计理念，通过界面生命周期管理、动态适配策略、资源优化机制三个维度的协同工作，构建了适应复杂交互需求的弹性UI框架。<br>简单说一下架构的组成：<br>1、核心类，UIManager, UIBaseView, UIConfig, UILayer<br>UIManager：提供UI操作、UI层级、UI消息、UI资源加载、UI调度、UI缓存等管理<br>注意：<br>1、Window包括：Model、Ctrl、View、和Active状态等构成的一个整体概念<br>2、所有带Window接口的都是操作整个窗口，如CloseWindow以后：整个窗口将不再活动<br>3、所有带View接口的都是操作视图层展示，如CloseView以后：View、Model依然活跃，只是看不见，可看做切入了后台<br>4、如果只是要监听数据，可以创建不带View、Ctrl的后台窗口，配置为nil，比如多窗口需要共享某控制model（配置为后台窗口）<br>5、可将UIManager看做一个挂载在UIRoot上的不完全UI组件，但是它是Singleton，不使用多重继承，UI组件特性隐式实现</p>
<p>UIBaseView：提供UI基础功能，如生命周期函数（OnCreate，OnEnable，OnDisable，OnDestroy, Update）、UI消息传递、UI参数传递。<br>每个UI基础自UIBaseView，再配置一个Config，配置改UI的名字，层级，预制体名，控制器名。<br>注意：<br>1、被动刷新：所有界面刷新通过消息驱动—除了打开界面时的刷新<br>2、对Model层可读，不可写—调试模式下强制<br>3、所有写数据、游戏控制操作、网络相关操作全部放Ctrl层<br>4、Ctrl层不依赖View层，但是依赖Model层<br>5、任何情况下不要在游戏逻辑代码操作界面刷新—除了打开、关闭界面</p>
<p>UIConfig：将游戏中的UI的Config注册到UIConfig中，由UIManager管理。</p>
<p>UILayer：UI的显示层级。UIManager负责管理所有UI的层级关系，通过在Config中配置的View的显示层级，包括UI的显示顺序和层级。</p>
<p>再好的设计最后还是需要人来执行，每个人的编码习惯不同，编码风格不同，编码能力不同，所以需要制定一套UI编码规范，让开发人员按照规范进行编码，提高代码的可读性，减少程序的出错率，提高程序的稳定性，降低维护成本。</p>
<h3 id="监控指标体系"><a href="#监控指标体系" class="headerlink" title="监控指标体系"></a>监控指标体系</h3><p>监控项 阈值 应对策略<br>帧率稳定性     &lt; 30fps  优化合批策略<br>内存波动幅度   &gt;15%     调整对象池配置<br>加载延迟      &gt;200ms   优化资源预加载<br>输入响应延迟   &gt;50ms    改进事件分发机制</p>
<h4 id="集成建议："><a href="#集成建议：" class="headerlink" title="集成建议："></a>集成建议：</h4><p>建立UI设计规范<br>实施自动化测试<br>集成性能分析工具链<br>制定多分辨率适配标准<br>建立UI组件库<br>持续优化输入响应链路</p>
<h4 id="附录：设计规范"><a href="#附录：设计规范" class="headerlink" title="附录：设计规范"></a>附录：设计规范</h4><p>一：命名规范：<br>    1、类命名：驼峰式命名：单词首字母大写，如：PharaohsMagicView、SlotGameBoard<br>    2、函数命名：同类名，如：IsInFreeSpinBoard()、EnableAllButton()<br>    3、公有变量命名：首字母小写，其后驼峰式命名，如：boardConfigs、slotGameBoards、currentGameBoard<br>    4、私有变量命名：”_”开头，驼峰式命名，_fastMode、_autoSpin<br>    5、局部变量命名：小写，单词之间用“_”分隔，如：local action_list, local current_bet_Index<br>    6、参数名命名：同局部变量命名<br>    7、任何情况下不应该由外部访问的成员，使用双下划线打头，其它同私有变量命名，如：析构函数<strong>init，内部成员self.</strong>callback<br>    8、由于脚本语言没有跳转功能，最好在UI组件实例的名字末尾标识组件类型，提高可读性：<br>        a）基础组件（UIBaseComponent）：xxxCmp<br>        b）按钮（UIButton）：xxxBtn<br>        c）文本（UIText）：xxxTxt<br>        d）图片（UIImage）：xxxImg<br>        e）输入框（UIInput）：xxxInput<br>        f）标签组（UITabGroup）：xxxTabGroup<br>        g）按钮组（UIButtonGroup）：xxxBtnGroup<br>        h）可选中按钮（UIToggelButton）：xxxBtnToggle<br>        i）可复用组件（UIWrapGroup）：xxxWrapGroup<br>        j）滑动条组件（UISlider）：xxxSlider<br>        k）后续…<br>    9、所有UI脚本以UI打头，即UIxxxx<br>    10、系统功能扩展函数：全部使用小写，不用下划线，如对table的扩展：table.walksort<br>    11、所有协程函数体以”Co”打头，如：CoAsyncLoad，表示该函数必须运行在协程中，并且可以使用任意协程相关函数<br>    12、所有Unity Object均使用全局函数IsNull判空===&gt;***很重要<br>    13、所有热修复脚本放XLua目录下，由于以前写热修复脚本命名习惯沿用了XLua作者的命名习惯，现在不再去动它</p>
<p>二：类定义和使用<br>    1、所有函数定义为local，在脚本最底部导出，导出的函数一定是公有的<br>    2、所有公有函数第一个参数是self，函数使用调用：instance:function(…)<br>    3、所有私有函数第一个参数是self，不导出，只能在脚本内访问，函数调用：function(self, …)<br>    4、所有私有函数一定要先定义，后调用<br>    5、override的使用有点特殊：先用base = baseClassType，然后override时使用：base.function(self)调用父类方法<br>    6、继承类时，如果不是等同于cs侧sealed的概念，那么必须把基类的参数列表填写完整，后面接上自己需要的参数<br>    7、函数需要重载时，一般通过判断参数个数和类型来实现，此时必须把最长参数列表填齐，除了回调绑定等不定参数的特俗情况，一般情况下不要使用可变参数（…）<br>    9、所有定义回调的地方，都需要预先声明回调和注释说明回调原型，让使用者一目了然<br>    10、<strong>init不需要调用base.</strong>init，底层会自动调用基类构造函数，__delete也一样</p>
<p>三：单例类定义和使用<br>    1、单例类从Singleton继承，不要重写GetInstance、Delete方法<br>    2、单例类定义时内部函数书写规范同上：类定义和使用<br>    3、单例类调用一律使用singletonClass:GetInstance():function/.var访问<br>    4、除了局部变量，不要使用成员变量或者全局变量缓存单例类引用，如：inst = singletonClass:GetInstance(),inst:function/.var，因为单例类销毁后inst还会存在引用<br>    5、单例类的Instace只用来查询该单例类是否已经被创建，如：if singletonClass.Instance ~= nil then singletonClass:Delete() end</p>
<p>四：数据类定义和使用<br>    1、数据类：对普通类增加访问限制，具体为：不能对不存在的域进行读写。目的：减少因为笔误而造成的不可察Bug<br>    2、定义格式使用：DataClass(“dataClassName”, dataTable)<br>    3、dataTable是一张普通表，定义了该数据成员的域，必须初始化，不能有nil值<br>    4、定义以后不能新增数据域，访问不存在的域会提示错误，New新的数据实例同New新的类实例</p>
<p>五：常量类定义和使用<br>    1、常量类：对普通类增加访问限制，具体为：不能对不存在的域进行读写，数据域只读，不可写。目的：减少因为笔误而造成的不可察Bug<br>    2、定义格式使用：ConstClass(“constClassName”, constTable)，一般用于配置表等数据，一旦生成只能查表，不能写表<br>    3、定义以后查询不存在的域、写不存在的域、写存在的域都会有错误提示</p>
<p>六：UI窗口代码规范<br>    1、严格遵守MVC架构：Model层数据、View层窗口组件操作、Ctrl层数据操作<br>    2、View层直接依赖Ctrl层，间接依赖Model层（只读）；Ctrl层依赖Model层；Model层不依赖Ctrl和View层<br>    3、Ctrl层没有状态，可以操作游戏逻辑和Model层数据；View层除了读取配置表，不能直接操作任何游戏逻辑<br>    4、逻辑的运行不能依赖窗口的Ctrl层，如果需要这样的控制代码，写到游戏逻辑模块中<br>    5、窗口Model层不存游戏数据，它的生命周期是和窗口绑定在一起的，只能缓存用户操作，比如：当前选择了那个服务器做登陆服务器<br>    6、窗口Model层是针对窗口的数据，是游戏数据中心的一个抽取，比如数据中心UserData可能包括用户名、背包、Vip、英雄等等数据，但是用于界面可能只是从用户名、Vip提取部分数据展示</p>
<p>七：UI组件代码规范<br>    1、所有需要调度和管理的UI组件最好使用Lua侧封装的各种UIComponent，不要直接使用Unity侧的UI原生组件，否则不受Lua侧组件系统调度管理，需自行管理<br>    2、原则上尽量对UI组件执行封装：一是可以简化逻辑层脚本使用方式，二是可以利用缓存尽量减少lua与cs交换，提升性能<br>    3、原则上游戏逻辑代码中（包括窗口View层代码）不对UI组件做任何假设，即不假设Unity侧使用的是NGUI还是UGUI<br>    4、虽然目前这套框架是针对UGUI编写，但是如果要扩展（或者要替换插件），只需要另外针对NGUI写一个Lua侧的各种UIComponent<br>    5、所有UI组件最好先封装，后使用，以尽量使用Lua侧组件管理系统来简化写View层脚本的工作量，各个使用到的组件现在还不是很完善，后续…<br>    6、一个窗口（window.view）下的所有组件持有对窗口view脚本的引用，方便访问window.view，或者window.model层数据<br>    7、当设计通用组件时，不能直接依赖window.view，需要数据刷新最好提供函数回调<br>    8、UI组件代码所有函数的执行规律同Unity脚本，UI组件代码不要使用<strong>init、</strong>delete函数，由OnCreate、OnDestory代替<br>    9、最好不要自己去New组件，使用AddComponent替代，否则必须自己管理生命周期—在OnDestory中调用组件的Delete方法</p>
<p>八：工具类代码规范<br>    1、所有和UI界面相关的公共函数添加到UIUtil<br>    2、所有和Lua语言直接相关的公共函数添加到LuaUtil<br>    3、所有对table操作的扩展函数添加到TableUtil<br>    4、其它待续…</p>
<p>九：框架代码规范<br>    1、原则：保证框架代码的可迁移，如果需要迁移到新项目，可以不修改任何代码，或者修改很少的粘合代码即可使用<br>    2、如果需要完善框架，框架内的代码理论山不要牵涉任何游戏逻辑，一般只提供管理类和基类，和业务相关的子类不要放在框架中</p>
<p>十：性能<br>    1、性能瓶颈出现在两点：lua作为脚本语言本身的速度问题、lua与cs的频繁交互造成高频率堆栈操作和Marshall操作<br>    2、原则1：单次调用，内部执行性能要求高的函数，比如寻路计算，考虑放CS侧，或者用C/CPP写—要求：函数执行时间要高于lua与cs调用交互时间，否则得不偿失<br>    3、原则2：尽量避免与cs的交互，交互越少越好，如tolua作者对Vector3在lua侧的实现，就是为了避免Vector3操作调用cs接口，其它实现的数据结构类似<br>    4、不要使用cs侧协程，lua这边我已经实现了一套，Unity支持的所有协程功能这里都支持，而且进行了很大的性能优化<br>    5、更新频率低的函数（如UI界面倒计时）使用定时器，尽量不要用Updater<br>    6、虽然Lua采用分步GC，不需要太关注GC造成游戏Lag的问题，但是分配、回收频率很高的table，还是要做缓存，参考定时器管理模块</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/10/2025-07-10/" data-id="cmcvdrdx3000occz8gsquhgv9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unity-UI%E6%A1%86%E6%9E%B6-UGUI/" rel="tag">Unity, UI框架, UGUI</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-09" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/09/2025-07-09/" class="article-date">
  <time datetime="2025-07-09T00:27:04.000Z" itemprop="datePublished">2025-07-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/09/2025-07-09/">Unity 打android 包报错总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>unity 打包的版本（Unity 2020.3.60f1）,<br>打android  的target  sdk 版本 34<br>最小支持版本 19</p>
<p>问题一：<br>1、error CS0117: ‘Type’ does not contain a definition for ‘MakeGenericSignatureType’ #1066<br>解决办法：<br>在Editor/xlua/genconfig.cs 中  public static Func&lt;MemberInfo, bool&gt; MethodFilter = (memberInfo) 函数下加上下面代码：<br>    if (memberInfo.DeclaringType  == typeof(Type))<br>    {<br>        if (memberInfo.MemberType == MemberTypes.Method)<br>        {<br>            var methodInfo = memberInfo as MethodInfo;<br>            if (methodInfo.Name == “MakeGenericSignatureType” &amp;&amp; methodInfo.GetParameters().Length == 2)<br>            {<br>                return true;<br>            }<br>        }<br>    }<br>问题二：<br><img src="img/2025-7-9_2.png" alt="img"><br>Unity使用XLua插件报错 ReadOnlySpan＜＞ &amp; Span＜＞<br>解决办法：在Editor/xlua/genconfig.cs 中 加入下面代码<br>[BlackList]<br>public static List<Type> BlackGenericTypeList = new List<Type>()<br>{<br>    typeof(Span&lt;&gt;),<br>    typeof(ReadOnlySpan&lt;&gt;)<br>};<br>private static bool IsBlacklistedGenericType(Type type)<br>{<br>    if (!type.IsGenericType) return false;<br>    return BlackGenericTypeList.Contains(type.GetGenericTypeDefinition());<br>}</p>
<p>[BlackList]<br>public static Func&lt;MemberInfo, bool&gt; GenericTypeFilter = (memberInfo) =&gt;<br>{<br>    switch (memberInfo)<br>    {<br>        case PropertyInfo propertyInfo:<br>            return IsBlacklistedGenericType(propertyInfo.PropertyType);<br>        case ConstructorInfo constructorInfo:<br>            return constructorInfo.GetParameters().Any(p =&gt; IsBlacklistedGenericType(p.ParameterType));<br>        case MethodInfo methodInfo:<br>            return methodInfo.GetParameters().Any(p =&gt; IsBlacklistedGenericType(p.ParameterType));<br>        default:<br>            return false;<br>    }<br>};<br>然后clear xlua genarated code ，重新生成一下就好了</p>
<p>问题三：<br><img src="img/2025-7-9_1.png" alt="img"><br>（1）Cannot parse project property android.enableR8=‘’ of type ‘class java.lang.String’ as boolean. Expected ‘true’ or ‘false’.<br>解决办法：<br>注释掉android.enableR8=MINIFY_WITH_R_EIGHT打包就可以了</p>
<p>问题四：<br>(3) Installed Build Tools revision 34.0.0 is corrupted. Remove and install again using the SDK Manager.<br>在unity hub  安装目录 mac 上的路径 /Applications/Unity/Hub/Editor/2022.3.60f1c1/PlaybackEngines/AndroidPlayer/SDK/build-tools/34.0.0<br>中的 d8 改成 dx，lib/r8.jar  改成 rx.jar</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/09/2025-07-09/" data-id="cmcvdrdx4000pccz8h4ooc2vv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xlua-lua-framework/" rel="tag">xlua, lua, framework</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-08" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/08/2025-07-08/" class="article-date">
  <time datetime="2025-07-08T00:27:04.000Z" itemprop="datePublished">2025-07-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/08/2025-07-08/">框架之消息机制（通知系统，观察者模式）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本篇我们实现一种消息机制。为什么需要消息机制，很简单，解耦合。</p>
<p>举个例子，游戏里面当资源数量更新时（例如粮食+200），所有显示该资源数量的界面都需要更新该资源的数量文本（例如训练士兵、升级建筑、治疗、研发等等），这可能会涉及十几种界面，而只有打开的界面需要更新。</p>
<p>那么当客户端收到服务端的数量更新消息时，在逻辑类里一个个的判断界面是否打开，如果界面打开则调用界面的更新方法显然是很低效、耦合的。那么消息机制的实现方式是怎么样的呢？</p>
<p>界面在打开时监听一条事件RESOURCE_DATA_UPDATE，在关闭时移除该事件RESOURCE_DATA_UPDATE，逻辑类收到资源更新消息时会触发这个事件，这样每个监听该事件的界面都可以收到资源更新的通知。</p>
<p>具体的实现是通过事件类型EventType 和c#委托Delegate实现的，EventType是自己定义的枚举。关键代码如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private static Dictionary&lt;EventType, Delegate&gt; m_EventTable &#x3D; new Dictionary&lt;EventType, Delegate&gt;();</span><br><span class="line">public delegate void CallBack();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;添加一个事件（例如界面打开时）</span><br><span class="line">public static void AddListener(EventType eventType, CallBack callBack)</span><br><span class="line">&#123;</span><br><span class="line">     m_EventTable[eventType] &#x3D; (CallBack)m_EventTable[eventType] + callBack;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;移除一个事件（例如界面关闭时）</span><br><span class="line">public static void RemoveListener(EventType eventType, CallBack callBack)</span><br><span class="line">&#123;</span><br><span class="line">     m_EventTable[eventType] &#x3D; (CallBack)m_EventTable[eventType] - callBack;</span><br><span class="line">     OnListenerRemoved(eventType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;触发事件，逻辑类调用</span><br><span class="line">public static void Broadcast(EventType eventType)</span><br><span class="line">&#123;</span><br><span class="line">    Delegate d;</span><br><span class="line">    if (m_EventTable.TryGetValue(eventType, out d))</span><br><span class="line">    &#123;</span><br><span class="line">        CallBack callBack &#x3D; d as CallBack;</span><br><span class="line">        if (callBack !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            callBack();</span><br><span class="line">        &#125;</span><br><span class="line">         else</span><br><span class="line">        &#123;</span><br><span class="line">            throw new Exception(string.Format(&quot;广播事件错误：事件&#123;0&#125;对应委托具有不同的类型&quot;, eventType));</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>详细代码如下：</p>
<p>一、c#端</p>
<p>1.回调定义：原本打算使用params object[] param作为回调参数，这样只需要定义一个回调。但是这种做法会导致频繁的装箱、拆箱操作，而且业务的代码也不好写。</p>
<p>装箱：值类型转引用类型，例如int装object。对值类型进行装箱会在堆中分配一个对象实例，并将该值复制到新的对象中。 最后会返回指向该内存的指针。我们应该尽量避免装箱操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public delegate void CallBack();</span><br><span class="line">public delegate void CallBack&lt;T&gt;(T arg);</span><br><span class="line">public delegate void CallBack&lt;T, X&gt;(T arg1, X arg2);</span><br><span class="line">public delegate void CallBack&lt;T, X, Y&gt;(T arg1, X arg2, Y arg3);</span><br><span class="line">public delegate void CallBack&lt;T, X, Y, Z&gt;(T arg1, X arg2, Y arg3, Z arg4);</span><br><span class="line">public delegate void CallBack&lt;T, X, Y, Z, W&gt;(T arg1, X arg2, Y arg3, Z arg4, W arg5);</span><br><span class="line">&#x2F;&#x2F;public delegate void CallBack(params object[] param);</span><br></pre></td></tr></table></figure>
<p>2.事件定义：</p>
<p>public enum EventType<br>{<br>    ShowText,<br>}<br>3.事件添加、移除、分发：最多支持五个参数的回调</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line">public class EventCenter</span><br><span class="line">&#123;</span><br><span class="line">    private static Dictionary&lt;EventType, Delegate&gt; m_EventTable &#x3D; new Dictionary&lt;EventType, Delegate&gt;();</span><br><span class="line"></span><br><span class="line">    private static void OnListenerAdding(EventType eventType, Delegate callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!m_EventTable.ContainsKey(eventType))</span><br><span class="line">        &#123;</span><br><span class="line">            m_EventTable.Add(eventType, null);</span><br><span class="line">        &#125;</span><br><span class="line">        Delegate d &#x3D; m_EventTable[eventType];</span><br><span class="line">        if (d !&#x3D; null &amp;&amp; d.GetType() !&#x3D; callBack.GetType())</span><br><span class="line">        &#123;</span><br><span class="line">            throw new Exception(string.Format(&quot;尝试为事件&#123;0&#125;添加不同类型的委托，当前事件所对应的委托是&#123;1&#125;，要添加的委托类型为&#123;2&#125;&quot;, eventType, d.GetType(), callBack.GetType()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private static void OnListenerRemoving(EventType eventType, Delegate callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_EventTable.ContainsKey(eventType))</span><br><span class="line">        &#123;</span><br><span class="line">            Delegate d &#x3D; m_EventTable[eventType];</span><br><span class="line">            if (d &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                throw new Exception(string.Format(&quot;移除监听错误：事件&#123;0&#125;没有对应的委托&quot;, eventType));</span><br><span class="line">            &#125;</span><br><span class="line">            else if (d.GetType() !&#x3D; callBack.GetType())</span><br><span class="line">            &#123;</span><br><span class="line">                throw new Exception(string.Format(&quot;移除监听错误：尝试为事件&#123;0&#125;移除不同类型的委托，当前委托类型为&#123;1&#125;，要移除的委托类型为&#123;2&#125;&quot;, eventType, d.GetType(), callBack.GetType()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            throw new Exception(string.Format(&quot;移除监听错误：没有事件码&#123;0&#125;&quot;, eventType));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private static void OnListenerRemoved(EventType eventType)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_EventTable[eventType] &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_EventTable.Remove(eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;no parameters</span><br><span class="line">    public static void AddListener(EventType eventType, CallBack callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack)m_EventTable[eventType] + callBack;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;Single parameters</span><br><span class="line">    public static void AddListener&lt;T&gt;(EventType eventType, CallBack&lt;T&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T&gt;)m_EventTable[eventType] + callBack;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;two parameters</span><br><span class="line">    public static void AddListener&lt;T, X&gt;(EventType eventType, CallBack&lt;T, X&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T, X&gt;)m_EventTable[eventType] + callBack;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;three parameters</span><br><span class="line">    public static void AddListener&lt;T, X, Y&gt;(EventType eventType, CallBack&lt;T, X, Y&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T, X, Y&gt;)m_EventTable[eventType] + callBack;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;four parameters</span><br><span class="line">    public static void AddListener&lt;T, X, Y, Z&gt;(EventType eventType, CallBack&lt;T, X, Y, Z&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T, X, Y, Z&gt;)m_EventTable[eventType] + callBack;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;five parameters</span><br><span class="line">    public static void AddListener&lt;T, X, Y, Z, W&gt;(EventType eventType, CallBack&lt;T, X, Y, Z, W&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T, X, Y, Z, W&gt;)m_EventTable[eventType] + callBack;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;no parameters</span><br><span class="line">    public static void RemoveListener(EventType eventType, CallBack callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack)m_EventTable[eventType] - callBack;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;single parameters</span><br><span class="line">    public static void RemoveListener&lt;T&gt;(EventType eventType, CallBack&lt;T&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T&gt;)m_EventTable[eventType] - callBack;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;two parameters</span><br><span class="line">    public static void RemoveListener&lt;T, X&gt;(EventType eventType, CallBack&lt;T, X&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T, X&gt;)m_EventTable[eventType] - callBack;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;three parameters</span><br><span class="line">    public static void RemoveListener&lt;T, X, Y&gt;(EventType eventType, CallBack&lt;T, X, Y&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T, X, Y&gt;)m_EventTable[eventType] - callBack;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;four parameters</span><br><span class="line">    public static void RemoveListener&lt;T, X, Y, Z&gt;(EventType eventType, CallBack&lt;T, X, Y, Z&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T, X, Y, Z&gt;)m_EventTable[eventType] - callBack;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;five parameters</span><br><span class="line">    public static void RemoveListener&lt;T, X, Y, Z, W&gt;(EventType eventType, CallBack&lt;T, X, Y, Z, W&gt; callBack)</span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, callBack);</span><br><span class="line">        m_EventTable[eventType] &#x3D; (CallBack&lt;T, X, Y, Z, W&gt;)m_EventTable[eventType] - callBack;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;no parameters</span><br><span class="line">    public static void Broadcast(EventType eventType)</span><br><span class="line">    &#123;</span><br><span class="line">        Delegate d;</span><br><span class="line">        if (m_EventTable.TryGetValue(eventType, out d))</span><br><span class="line">        &#123;</span><br><span class="line">            CallBack callBack &#x3D; d as CallBack;</span><br><span class="line">            if (callBack !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                callBack();</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                throw new Exception(string.Format(&quot;广播事件错误：事件&#123;0&#125;对应委托具有不同的类型&quot;, eventType));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;single parameters</span><br><span class="line">    public static void Broadcast&lt;T&gt;(EventType eventType, T arg)</span><br><span class="line">    &#123;</span><br><span class="line">        Delegate d;</span><br><span class="line">        if (m_EventTable.TryGetValue(eventType, out d))</span><br><span class="line">        &#123;</span><br><span class="line">            CallBack&lt;T&gt; callBack &#x3D; d as CallBack&lt;T&gt;;</span><br><span class="line">            if (callBack !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                callBack(arg);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                throw new Exception(string.Format(&quot;广播事件错误：事件&#123;0&#125;对应委托具有不同的类型&quot;, eventType));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;two parameters</span><br><span class="line">    public static void Broadcast&lt;T, X&gt;(EventType eventType, T arg1, X arg2)</span><br><span class="line">    &#123;</span><br><span class="line">        Delegate d;</span><br><span class="line">        if (m_EventTable.TryGetValue(eventType, out d))</span><br><span class="line">        &#123;</span><br><span class="line">            CallBack&lt;T, X&gt; callBack &#x3D; d as CallBack&lt;T, X&gt;;</span><br><span class="line">            if (callBack !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                callBack(arg1, arg2);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                throw new Exception(string.Format(&quot;广播事件错误：事件&#123;0&#125;对应委托具有不同的类型&quot;, eventType));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;three parameters</span><br><span class="line">    public static void Broadcast&lt;T, X, Y&gt;(EventType eventType, T arg1, X arg2, Y arg3)</span><br><span class="line">    &#123;</span><br><span class="line">        Delegate d;</span><br><span class="line">        if (m_EventTable.TryGetValue(eventType, out d))</span><br><span class="line">        &#123;</span><br><span class="line">            CallBack&lt;T, X, Y&gt; callBack &#x3D; d as CallBack&lt;T, X, Y&gt;;</span><br><span class="line">            if (callBack !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                callBack(arg1, arg2, arg3);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                throw new Exception(string.Format(&quot;广播事件错误：事件&#123;0&#125;对应委托具有不同的类型&quot;, eventType));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;four parameters</span><br><span class="line">    public static void Broadcast&lt;T, X, Y, Z&gt;(EventType eventType, T arg1, X arg2, Y arg3, Z arg4)</span><br><span class="line">    &#123;</span><br><span class="line">        Delegate d;</span><br><span class="line">        if (m_EventTable.TryGetValue(eventType, out d))</span><br><span class="line">        &#123;</span><br><span class="line">            CallBack&lt;T, X, Y, Z&gt; callBack &#x3D; d as CallBack&lt;T, X, Y, Z&gt;;</span><br><span class="line">            if (callBack !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                callBack(arg1, arg2, arg3, arg4);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                throw new Exception(string.Format(&quot;广播事件错误：事件&#123;0&#125;对应委托具有不同的类型&quot;, eventType));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;five parameters</span><br><span class="line">    public static void Broadcast&lt;T, X, Y, Z, W&gt;(EventType eventType, T arg1, X arg2, Y arg3, Z arg4, W arg5)</span><br><span class="line">    &#123;</span><br><span class="line">        Delegate d;</span><br><span class="line">        if (m_EventTable.TryGetValue(eventType, out d))</span><br><span class="line">        &#123;</span><br><span class="line">            CallBack&lt;T, X, Y, Z, W&gt; callBack &#x3D; d as CallBack&lt;T, X, Y, Z, W&gt;;</span><br><span class="line">            if (callBack !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                callBack(arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                throw new Exception(string.Format(&quot;广播事件错误：事件&#123;0&#125;对应委托具有不同的类型&quot;, eventType));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>二、lua端，lua对调并不需要定义。</p>
<p>1.事件定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">-- 广播消息定义</span><br><span class="line">local BroadcastMsgConfig &#x3D; &#123;</span><br><span class="line">    ACTIVITY_INIT                &#x3D; &quot;ACTIVITY_INIT&quot;, -- 活动初始化</span><br><span class="line">    ACTIVITY_EXPIRE              &#x3D; &quot;ACTIVITY_EXPIRE&quot;, -- 活动过期</span><br><span class="line">    ACTIVITY_REFRESH             &#x3D; &quot;ACTIVITY_REFRESH&quot;, -- 活动刷新</span><br><span class="line">    ACTIVITY_ENTER               &#x3D; &quot;ACTIVITY_ENTER&quot;, -- 进入活动</span><br><span class="line">    ACTIVITY_PLAY                &#x3D; &quot;ACTIVITY_PLAY&quot;, -- 玩活动</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--  广播消息中心管理</span><br><span class="line">local BroadcastCenter &#x3D; BaseClass(&quot;BroadcastCenter&quot;, Singleton)</span><br><span class="line">local Messenger &#x3D; require &quot;Framework.Common.Messenger&quot;</span><br><span class="line"></span><br><span class="line">-- 构造函数</span><br><span class="line">function BroadcastCenter.__init(cls_obj)</span><br><span class="line">    cls_obj.msgRegister &#x3D; Messenger.New()  -- 广播消息注册器</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 析构函数</span><br><span class="line">function BroadcastCenter.__delete(cls_obj)</span><br><span class="line">	cls_obj.msgRegister:Delete()</span><br><span class="line">	cls_obj.msgRegister &#x3D; nil</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 注册消息</span><br><span class="line">function BroadcastCenter:AddListener(msg_type, msg_listener, ...)</span><br><span class="line">    self.msgRegister:AddListener(msg_type, msg_listener, ...)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 注销消息</span><br><span class="line">function BroadcastCenter:RemoveListener(msg_type, msg_listener)</span><br><span class="line">    if self.msgRegister then</span><br><span class="line">        self.msgRegister:RemoveListener(msg_type, msg_listener)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 发送消息</span><br><span class="line">function BroadcastCenter:Broadcast(msg_type, ...)</span><br><span class="line">    if self.msgRegister then</span><br><span class="line">        self.msgRegister:Broadcast(msg_type, ...)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">return BroadcastCenter</span><br><span class="line"></span><br><span class="line">local Messenger &#x3D; BaseClass(&quot;Messenger&quot;);</span><br><span class="line"></span><br><span class="line">function Messenger.__init(cls_obj)</span><br><span class="line">	cls_obj.events &#x3D; &#123;&#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function Messenger.__delete(cls_obj)</span><br><span class="line">	cls_obj.events &#x3D; nil	</span><br><span class="line">	cls_obj.error_handle &#x3D; nil</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function Messenger.AddListener(cls_obj, e_type, e_listener, ...)</span><br><span class="line">	local event &#x3D; cls_obj.events[e_type]</span><br><span class="line">	if event &#x3D;&#x3D; nil then</span><br><span class="line">		event &#x3D; setmetatable(&#123;&#125;, &#123;__mode &#x3D; &quot;k&quot;&#125;)</span><br><span class="line">	end</span><br><span class="line">	</span><br><span class="line">	for k, v in pairs(event) do</span><br><span class="line">		if k &#x3D;&#x3D; e_listener then</span><br><span class="line">			error(&quot;Aready cotains listener : &quot;..tostring(e_listener))</span><br><span class="line">			return</span><br><span class="line">		end</span><br><span class="line">	end</span><br><span class="line">	</span><br><span class="line">	event[e_listener] &#x3D; setmetatable(SafePack(...), &#123;__mode &#x3D; &quot;kv&quot;&#125;) </span><br><span class="line">	cls_obj.events[e_type] &#x3D; event;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function Messenger.Broadcast(cls_obj, e_type, ...)</span><br><span class="line">	local event &#x3D; cls_obj.events[e_type]</span><br><span class="line">	if event &#x3D;&#x3D; nil then</span><br><span class="line">		return</span><br><span class="line">	end</span><br><span class="line">	</span><br><span class="line">	for k, v in pairs(event) do</span><br><span class="line">		assert(k ~&#x3D; nil)</span><br><span class="line">		local args &#x3D; ConcatSafePack(v, SafePack(...))</span><br><span class="line">		k(SafeUnpack(args))</span><br><span class="line">	end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function Messenger.RemoveListener(cls_obj, e_type, e_listener)</span><br><span class="line">	local event &#x3D; cls_obj.events[e_type]</span><br><span class="line">	if event &#x3D;&#x3D; nil then</span><br><span class="line">		return</span><br><span class="line">	end</span><br><span class="line"></span><br><span class="line">	event[e_listener] &#x3D; nil</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function Messenger.RemoveListenerByType(cls_obj, e_type)</span><br><span class="line">	cls_obj.events[e_type] &#x3D; nil</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function Messenger.Cleanup(cls_obj)</span><br><span class="line">	cls_obj.events &#x3D; &#123;&#125;;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">return Messenger</span><br></pre></td></tr></table></figure>
<p>注意：<br>1、模块实例销毁时，要自动移除消息监听，不移除的话不能自动清理监听<br>2、使用弱引用，即使监听不手动移除，消息系统也不会持有对象引用，所以对象的销毁是不受消息系统影响的<br>3、换句话说：广播发出，回调一定会被调用，但回调参数中的实例对象，可能已经被销毁，所以回调函数一定要注意判空</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/08/2025-07-08/" data-id="cmcvdrdx2000mccz82thv137d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity/" rel="tag">unity</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-07" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/07/2025-07-07/" class="article-date">
  <time datetime="2025-07-07T00:27:04.000Z" itemprop="datePublished">2025-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/07/2025-07-07/">unity游戏开发之三方SDK接入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>出海游戏开发中，sdk接入是必不可少的，sdk接入包括：</p>
<p>1.账号类：创建、登录、切换 Facebook SDK， AppleId SDK</p>
<p>2.充值 ，unity IAP，如果接入其他平台，比如亚马逊，需要调用这些平台的接口</p>
<p>3.外部分享如微信、朋友圈、FB等</p>
<p>4.打开外部链接，如helpshift ,广告平台</p>
<p>5.功能类：语音、头像、埋点</p>
<p>这些功能都是sdk提供的，而我们要做的就是调用sdk的接口（有的有Unity SDK，有的是原生接口，ios的OC接口，android的java接口）<br>如果有Unity SDK ，直接导入到Unity 工程，像调用正常的C#方法一样调用即可。</p>
<p>一、android和c#交互</p>
<p>1.c#调用android方法，如下，使用 AndroidJavaClass获取AndroidJavaObject对象，在通过AndroidJavaObject调用java方法。最常用的是AndroidJavaObject的Call方法，unity文档：<a href="http://docs.unity3d.com/ScriptReference/AndroidJavaObject.html" target="_blank" rel="noopener">http://docs.unity3d.com/ScriptReference/AndroidJavaObject.html</a><br>这个Call是支持多参数的，第一个参数必须是方法名，第二个开始则是各种参数。如果有返回值则需要使用泛型版本Call<Type>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; Android帮助库</span><br><span class="line">&#x2F;&#x2F;&#x2F; 提供unity对android端的调用，属性的get和set麻烦封装成方法</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class AndroidHelper</span><br><span class="line">&#123;</span><br><span class="line">    const string AndroidMainActivity &#x3D; &quot;com.unity3d.player.UnityPlayer&quot;;</span><br><span class="line"></span><br><span class="line">static AndroidJavaObject ms_MainActivity;</span><br><span class="line">    public static AndroidJavaObject MainActivity &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            if (ms_MainActivity &#x3D;&#x3D; null) &#123;</span><br><span class="line">                AndroidJavaClass jc &#x3D; new AndroidJavaClass (AndroidMainActivity);</span><br><span class="line">                if (jc !&#x3D; null) &#123;</span><br><span class="line">                    ms_MainActivity &#x3D; jc.GetStatic&lt;AndroidJavaObject&gt; (&quot;currentActivity&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return ms_MainActivity;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #region MainActivity的非静态方法</span><br><span class="line">    public static void Call(string method)</span><br><span class="line">    &#123;</span><br><span class="line">        MainActivity.Call(method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void Call(string method, object[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        MainActivity.Call(method, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void Call(string method, bool val)</span><br><span class="line">    &#123;</span><br><span class="line">        MainActivity.Call(method, new object[] &#123; val &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void Call(string method, string val)</span><br><span class="line">    &#123;</span><br><span class="line">        MainActivity.Call(method, new object[] &#123; val &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static string CallWithReturn(string method)</span><br><span class="line">    &#123;</span><br><span class="line">        string result &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        AndroidJavaClass jc &#x3D; new AndroidJavaClass(&quot;com.unity3d.player.UnityPlayer&quot;);</span><br><span class="line">        AndroidJavaObject jo &#x3D; jc.GetStatic&lt;AndroidJavaObject&gt;(&quot;currentActivity&quot;);</span><br><span class="line">        result &#x3D; jo.Call&lt;string&gt;(method);</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    #region MainActivity的静态方法</span><br><span class="line">    public static void CallStatic(string method)</span><br><span class="line">    &#123;</span><br><span class="line">        MainActivity.CallStatic(method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void CallStatic(string method, string val)</span><br><span class="line">    &#123;</span><br><span class="line">        MainActivity.CallStatic(method, new object[] &#123; val &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static string CallStaticWithReturn(string val)</span><br><span class="line">    &#123;</span><br><span class="line">        string result &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        AndroidJavaClass jc &#x3D; new AndroidJavaClass(&quot;com.unity3d.player.UnityPlayer&quot;);</span><br><span class="line">        AndroidJavaObject jo &#x3D; jc.GetStatic&lt;AndroidJavaObject&gt;(&quot;currentActivity&quot;);</span><br><span class="line">        result &#x3D; jo.CallStatic&lt;string&gt;(val);</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.Java回调unity，public static void UnitySendMessage(String var0, String var1, String var2) ，第一个参数为unity中的一个gameobject名称，第二个参数为这个gameobject身上捆绑的脚本中的一个方法，而第三参数是这个对应方法上的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static final String UNITY_HANDLER &#x3D; &quot;SDKMsgHandler&quot;;</span><br><span class="line">**</span><br><span class="line"> * 向Unity传送</span><br><span class="line">* @param arg1 函数名</span><br><span class="line">* @param arg2 参数</span><br><span class="line">*&#x2F;</span><br><span class="line">public static void UnitySendMessage(String arg1, String arg2)</span><br><span class="line">&#123;</span><br><span class="line">     UnityPlayer.UnitySendMessage(UNITY_HANDLER, arg1, arg2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>二、ios和c#的交互，可以参照官网：<a href="https://docs.unity3d.com/Manual/PluginsForIOS.html，" target="_blank" rel="noopener">https://docs.unity3d.com/Manual/PluginsForIOS.html，</a><br>你需要把你的oc代码放在Plugins/iOS文件夹下才能正确调用到OC的代码</p>
<p>c#调用ios：c#端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[DllImport(&quot;__Internal&quot;)]</span><br><span class="line">private static extern string U3dGetAvailableDiskSize();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 获取磁盘空间</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public long GetAvailableDiskSize()</span><br><span class="line">&#123;</span><br><span class="line">    string size &#x3D; U3dGetAvailableDiskSize();</span><br><span class="line">    return long.Parse(size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OC端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">char* _MakeStringCopy( const char* string)</span><br><span class="line">&#123;</span><br><span class="line">    if (NULL &#x3D;&#x3D; string) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    char* res &#x3D; (char*)malloc(strlen(string)+1);</span><br><span class="line">    strcpy(res, string);</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const char* U3dGetAvailableDiskSize()</span><br><span class="line">&#123;</span><br><span class="line">    struct statfs buf;</span><br><span class="line">    long long freespace &#x3D; -1;</span><br><span class="line">    if(statfs(&quot;&#x2F;var&quot;, &amp;buf) &gt;&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        freespace &#x3D; (long long)(buf.f_bsize * buf.f_bfree);</span><br><span class="line">    &#125;</span><br><span class="line">    NSString *_msg &#x3D; [NSString stringWithFormat:@&quot;%lld&quot;, freespace];</span><br><span class="line">    </span><br><span class="line">    return _MakeStringCopy([_msg UTF8String]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.OC回调unity：</p>
<p>UnitySendMessage(“GameObjectName1”, “MethodName1”, “Message to send”);<br>参数1：gameobject名字；参数2：回调函数的名字；参数3：参数。同android开发中java回调c#一样，三个参数都是字符串类型！</p>
<p>三、好了。我们知道unity跟ios\android怎么交互了，可以开始设计我们的接口了，首先在c#端，我们需要区分三种平台，ios\android\unity editor三种平台，我们不可能像下面这么写，几十个接口如果都这么写，会原地爆炸的，所以我们需要用的接口来规范我们的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if(platform &#x3D;&#x3D; ios)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;xxxx</span><br><span class="line">&#125;else if(paltform &#x3D;&#x3D; android)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;xxxx</span><br><span class="line">&#125;else if(platform &#x3D;&#x3D; editor)&#123;</span><br><span class="line">    &#x2F;&#x2F;xxxx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.首先我们需要有一个接口类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public interface SDKInterface</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;** 登录 **&#x2F;</span><br><span class="line">    void Login();</span><br><span class="line"></span><br><span class="line">    &#x2F;** 打开SDK用户中心界 **&#x2F;</span><br><span class="line">    void ShowUserCenter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.我们需要有每个平台的具体实现类（其实就是ios调用OC，android调用Java，editor平台啥也不做），如下所示，U3dLogin\ShowUserCenter是Ios、android两端的实现代码，这里就不上了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#if UNITY_ANDROID</span><br><span class="line">public class AndroidSDK : SDKInterface</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 登录</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public void Login()</span><br><span class="line">    &#123;</span><br><span class="line">        Call(&quot;U3dLogin&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 打开SDK用户中心界</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public void ShowUserCenter()</span><br><span class="line">    &#123;</span><br><span class="line">        Call(&quot;U3dShowUserCenter&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#if UNITY_IOS</span><br><span class="line">public class IOSSDK : SDKInterface</span><br><span class="line">&#123;</span><br><span class="line">    [DllImport(&quot;__Internal&quot;)]</span><br><span class="line">    private static extern void U3dLogin();</span><br><span class="line"></span><br><span class="line">    [DllImport(&quot;__Internal&quot;)]</span><br><span class="line">    private static extern void U3dShowUserCenter();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 登录</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public void Login()</span><br><span class="line">    &#123;</span><br><span class="line">        U3dLogin();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 打开SDK用户中心界</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public void ShowUserCenter()</span><br><span class="line">    &#123;</span><br><span class="line">        U3dShowUserCenter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class EmptySDK : SDKInterface</span><br><span class="line">&#123;</span><br><span class="line">    public void Login() &#123; &#125;</span><br><span class="line"></span><br><span class="line">    public void ShowUserCenter() &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.一个接受两端回调消息的类，ios\android共用一个就好了，该类会在管理类里面初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class SDKMsgHandler : MonoBehaviour</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 登录回调</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;msg&quot;&gt;msg&lt;&#x2F;param&gt;</span><br><span class="line">    public void LoginNotification(string msg)</span><br><span class="line">    &#123;        </span><br><span class="line">　　　　Debug.Log(&quot;登录回调：&quot; + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>4.我们需要一个管理类，来确定具体是调用哪一个接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public class SDKModule : ModuleBase</span><br><span class="line">&#123;</span><br><span class="line">    public SDKModule ()</span><br><span class="line">    &#123;</span><br><span class="line">        #if UNITY_EDITOR || GUIDE</span><br><span class="line">        _sdk &#x3D; new EmptySDK ();</span><br><span class="line">        #elif UNITY_IOS</span><br><span class="line">        _sdk &#x3D; new IOSSDK();</span><br><span class="line">        #elif UNITY_ANDROID</span><br><span class="line">        _sdk &#x3D; new AndroidSDK();</span><br><span class="line">        #else</span><br><span class="line">        _sdk &#x3D; new EmptySDK();</span><br><span class="line">        #endif</span><br><span class="line"></span><br><span class="line">        GameObject go &#x3D; new GameObject (&quot;SDKMsgHandler&quot;);</span><br><span class="line">        GameObject.DontDestroyOnLoad (go);</span><br><span class="line">        go.AddComponent&lt;SDKMsgHandler&gt; ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 登录</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public void Login ()</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(&quot;Login c&quot;);</span><br><span class="line">        _sdk.Login ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 打开SDK用户中心界</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public void ShowUserCenter ()</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(&quot;ShowUserCenter c&quot;);</span><br><span class="line">        _sdk.ShowUserCenter ();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，c#端就完成了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/07/2025-07-07/" data-id="cmcvdrdx1000lccz81dr632ht" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-06" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/06/2025-07-06/" class="article-date">
  <time datetime="2025-07-06T00:27:04.000Z" itemprop="datePublished">2025-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/06/2025-07-06/">框架之UI管理模块</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.界面的加载、卸载</p>
<p>2.打开、关闭、隐藏、显示界面，这边隐藏是指界面被遮挡的意思，一般来说，界面被遮住时，应该关闭界面的更新</p>
<p>3.界面栈的管理，主要是用于场景切换时需要回到上一个场景打开的界面栈</p>
<p>4.需要的功能：图片镜像（节省资源）、滑动列表（复用）、模糊背景等</p>
<p>注意点：</p>
<p>1.界面的生成：class的生成、预制体的实例化，类和实例的关联。</p>
<p>业务打开一个界面需要传入界面的标识（枚举、或者字符串），如何通过这个标识找到预制体并实例化go、如何生成指定的界面view，如何绑定view和go</p>
<p>如何销毁一个界面，清除ab缓存、清除引用关系、destory go</p>
<p>2.界面的层级关系：每次打开一个新的UI，都将它堆入栈，关闭时出栈。这个栈是一个特殊的栈，例如它可以实现，某个不在栈顶的UI，可以“TOP”到栈顶。</p>
<p>打开一个界面：1.从已打开界面搜索，避免重复打开界面。2.从缓存界面搜索，避免重复加载。3.隐藏栈顶界面。4.打开新界面</p>
<p>关闭一个界面：1.关闭界面并加入缓存。2.从已打开界面栈顶取出一个界面，显示该界面。3.重复步骤2直到打开一个全屏界面。</p>
<p>退出场景：1.所有界面入栈，当再次回到场景时可以恢复界面栈。2.关闭界面</p>
<p>进入场景：1.如果需要恢复界面栈，从界面栈取出界面并打开显示该界面。2.重复1步骤直到打开一个全屏界面。3.不需要恢复：打开当前场景的界面。</p>
<p>3.界面间的通信：最好不要有界面之间的通信，界面的更新通过数据（逻辑）类发送消息通知给界面。例如使用道具后界面的更新，数据类接收到服务器道具使用成功后，发送道具更新消息BAG_DATA_UPDATE，需要更新的界面监听BAG_DATA_UPDATE消息并刷新界面。</p>
<p>4.界面打开动画控制。统一使用Animator（Animation），且每个界面最多只有一个Animator（Animation），界面获取焦点时调用Animator的Play方法播放动画。</p>
<p>5.界面特效控制：游戏会有很多进入界面播放一次的特效，如果你的界面关闭不是使用SetActive处理的（例如设置layer、移到屏幕外等），那么在你的界面再次打开时特效不会再次被播放。</p>
<p>6.界面内使用的对象怎么获取？（例如要修改界面的某个text）</p>
<p>每个需要在脚本内加载的对象都挂载一个UIExportItem对象，在界面初始化时统一收集这些对象，并存储在一个map里给界面使用</p>
<p>UI模块分以下几部分：</p>
<p>1.界面类：负责界面的逻辑，提供生命周期方法供业务使用，如OnOpen、OnClose等。负责界面的生成、销毁（以及界面ab包的加载、卸载）。子窗口、子item的管理（生成、缓存、销毁）</p>
<p>2.管理类：提供界面的生命周期管理，如打开、关闭、显示（获得焦点，显示在最上层）、隐藏（失去焦点，可以理解成被其他界面挡住了）一个界面、打开、关闭一堆界面（场景切入、切出时）。缓存界面。维护窗体中间的层级关系。</p>
<p>3.配置类：负责配置界面的预制体路径、类、界面类型等参数。</p>
<p>4.功能类：滑动列表、图片镜像、模糊、弹窗适配、通用的标题、通用的tab等。</p>
<p>5.item类，例如界面的滑动列表的子项。</p>
<p>详细代码如下：</p>
<p>一、ViewDefine：定义类的配置：这边主要是一些界面定义以及界面的配置，通过配置类名可以用反射实例化界面类，通过配置的路径可以加载并实例化预制体。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">public class ViewDefine </span><br><span class="line">&#123;</span><br><span class="line">    public enum ViewType </span><br><span class="line">    &#123;</span><br><span class="line">        MAIN &#x3D; 1,      &#x2F;&#x2F; 主窗口(全屏)</span><br><span class="line">        POPUP &#x3D; 2,    &#x2F;&#x2F; 弹窗</span><br><span class="line">        FIXED &#x3D; 3,    &#x2F;&#x2F; 固化窗口</span><br><span class="line">        SCENE &#x3D; 4,    &#x2F;&#x2F; 场景UI窗口</span><br><span class="line">        GUIDE &#x3D; 5,    &#x2F;&#x2F; 引导UI窗口</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum ViewPopModal</span><br><span class="line">    &#123;</span><br><span class="line">        Blur &#x3D; 1,                       &#x2F;&#x2F; 带有模糊效果的模态弹窗</span><br><span class="line">        Lucency_ImPenetrable &#x3D; 2,       &#x2F;&#x2F; 无模糊，不可穿透</span><br><span class="line">        Lucency_Penetrate &#x3D; 3,          &#x2F;&#x2F; 无模糊, 可穿透</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum ViewLoadStateDefine</span><br><span class="line">    &#123;</span><br><span class="line">        NONE &#x3D; 0,</span><br><span class="line">        LOADING &#x3D; 1,</span><br><span class="line">        LOADED &#x3D; 2,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum ViewOnLoadDefine</span><br><span class="line">    &#123;</span><br><span class="line">        Cache &#x3D; 1,</span><br><span class="line">        Destroy &#x3D; 2,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum ViewAlignmentType</span><br><span class="line">    &#123;</span><br><span class="line">        UpperLeft &#x3D; 0,</span><br><span class="line">        UpperCenter &#x3D; 1,</span><br><span class="line">        UpperRight &#x3D; 2,</span><br><span class="line">        MiddleLeft &#x3D; 3,</span><br><span class="line">        MiddleCenter &#x3D; 4,</span><br><span class="line">        MiddleRight &#x3D; 5,</span><br><span class="line">        LowerLeft &#x3D; 6,</span><br><span class="line">        LowerCenter &#x3D; 7,</span><br><span class="line">        LowerRight &#x3D; 8,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum ViewID</span><br><span class="line">    &#123;</span><br><span class="line">        TOAST,          &#x2F;&#x2F; 吐司界面</span><br><span class="line">        TOAST_BATTLE,   &#x2F;&#x2F; 战斗中吐司界面</span><br><span class="line">        NETWAIT,        &#x2F;&#x2F; 网络等待界面</span><br><span class="line">        NETWORK_TIPS,   &#x2F;&#x2F; 网络异常提示</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static Dictionary&lt;int, string&gt; _viewConfig &#x3D; new Dictionary&lt;int, string&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &#123; (int)ViewID.TOAST,            &quot;ToastView,Prefab&#x2F;Common&#x2F;ToastPanel&quot; &#125;,</span><br><span class="line">        &#123; (int)ViewID.TOAST_BATTLE,     &quot;ToastBattleView,Prefab&#x2F;Common&#x2F;ToastBattlePanel&quot; &#125;,</span><br><span class="line">        &#123; (int)ViewID.NETWAIT,          &quot;NetwaitView,Prefab&#x2F;Common&#x2F;NetwaitPanel&quot; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    public static string GetViewType(ViewID viewID)</span><br><span class="line">    &#123;</span><br><span class="line">        string config &#x3D; _viewConfig[(int)viewID];</span><br><span class="line">        if (string.IsNullOrEmpty(config))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogErrorFormat(&quot;未配置界面路径 ： &#123;0&#125;&quot;, viewID);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] split &#x3D; config.Split(&#39;,&#39;);</span><br><span class="line">        return split[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static string GetViewPath(ViewID viewID)</span><br><span class="line">    &#123;</span><br><span class="line">        string config &#x3D; _viewConfig[(int)viewID];</span><br><span class="line">        if (string.IsNullOrEmpty(config))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogErrorFormat(&quot;未配置界面路径 ： &#123;0&#125;&quot;, viewID);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] split &#x3D; config.Split(&#39;,&#39;);</span><br><span class="line">        return split[1];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>二、UIBase ，ui元素基类，主要提供go的销毁以及导入界面需要引用的对象并保存在_viewObj里，业务可以通过_viewObj[“对象名”]访问对象而不用去定义参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; item、view的基类，提供预制体的生成、卸载（ab包的维护），提供子节点的生成</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class UIBase</span><br><span class="line">&#123;</span><br><span class="line">    protected GameObject gameObject;</span><br><span class="line">    protected Transform transform;</span><br><span class="line"></span><br><span class="line">    public string Name &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    protected Dictionary&lt;string, Object&gt; _viewObj &#x3D; new Dictionary&lt;string, Object&gt;();&#x2F;&#x2F;导出的界面对象</span><br><span class="line"></span><br><span class="line">    public virtual void Ctor(GameObject obj, Transform parent)</span><br><span class="line">    &#123;</span><br><span class="line">        if (obj !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            gameObject &#x3D; obj;</span><br><span class="line">            transform &#x3D; obj.transform;</span><br><span class="line">            ExportHierarchy();</span><br><span class="line"></span><br><span class="line">            if (parent !&#x3D; null) &#123;</span><br><span class="line">                transform.SetParent(parent);</span><br><span class="line">                transform.localPosition &#x3D; Vector3.zero;</span><br><span class="line">                transform.localScale &#x3D; Vector3.zero;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected virtual void OnLoad() &#123; &#125;</span><br><span class="line"></span><br><span class="line">    public void SetActive(bool isShow)</span><br><span class="line">    &#123;</span><br><span class="line">        gameObject.SetActive(isShow);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Dispose()</span><br><span class="line">    &#123;</span><br><span class="line">        if (gameObject !&#x3D; null) &#123;</span><br><span class="line">            GameObject.Destroy(gameObject);</span><br><span class="line">            transform &#x3D; null;</span><br><span class="line">            gameObject &#x3D; null;           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void ExportHierarchy()</span><br><span class="line">    &#123;</span><br><span class="line">        if (gameObject)</span><br><span class="line">        &#123;</span><br><span class="line">            UIHierarchy hierarchy &#x3D; gameObject.GetComponent&lt;UIHierarchy&gt;();</span><br><span class="line">            if (hierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                foreach (var item in hierarchy.widgets)</span><br><span class="line">                &#123;</span><br><span class="line">                    _viewObj.Add(item.name, item.item);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                foreach (var item in hierarchy.externals)</span><br><span class="line">                &#123;</span><br><span class="line">                    _viewObj.Add(item.name, item.item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三、UIItemBase ，item类，主要是提供OnItemOpen、OnItemClose方法，方便item在界面打开和关闭时监听（移除）事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 界面item</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class UIItemBase:UIBase</span><br><span class="line">&#123;</span><br><span class="line">    protected ViewBase parentView;</span><br><span class="line">    protected bool isItemOpen &#x3D; false;</span><br><span class="line"></span><br><span class="line">    public virtual void OnItemOpen()</span><br><span class="line">    &#123;</span><br><span class="line">        isItemOpen &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void OnItemClose()</span><br><span class="line">    &#123;</span><br><span class="line">        isItemOpen &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsItemOpen()</span><br><span class="line">    &#123;</span><br><span class="line">        return isItemOpen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void SetParentView(ViewBase parent)</span><br><span class="line">    &#123;</span><br><span class="line">        parentView &#x3D; parent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>四、PanelBase ，子界面、界面的基类。主要是提供子item的生成、维护。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 所有界面的基类，包括子窗口、所有的界面</span><br><span class="line">&#x2F;&#x2F;&#x2F; 这个类主要功能是：提供给子界面生个生成、维护item的接口</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class PanelBase:UIBase</span><br><span class="line">&#123;</span><br><span class="line">    protected bool isOpen &#x3D; false;</span><br><span class="line">    protected Dictionary&lt;string, Queue&lt;UIItemBase&gt;&gt; childItemPool &#x3D; new Dictionary&lt;string, Queue&lt;UIItemBase&gt;&gt;(); &#x2F;&#x2F;缓存item的池子</span><br><span class="line">    protected List&lt;UIBase&gt; subItems &#x3D; new List&lt;UIBase&gt;();&#x2F;&#x2F;维护子对象，包括子窗口、子item</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; UIModule调用，用于打开一个界面。如果该界面还未加载，会调用Load加载界面</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;args&quot;&gt;&lt;&#x2F;param&gt; 界面参数</span><br><span class="line">    public virtual void Open(params object[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Close()</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsOpen()</span><br><span class="line">    &#123;</span><br><span class="line">        return isOpen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 生成一个子item</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;className&quot;&gt;&lt;&#x2F;param&gt; 子item的类名</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;prefabs&quot;&gt;&lt;&#x2F;param&gt; 子item的预制体</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;parent&quot;&gt;&lt;&#x2F;param&gt; 子item的父节点</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">    protected UIItemBase GenerateItem(string className, GameObject prefabs, Transform parent)</span><br><span class="line">    &#123;</span><br><span class="line">        Queue&lt;UIItemBase&gt; pool &#x3D; childItemPool[className];</span><br><span class="line"></span><br><span class="line">        if (pool !&#x3D; null &amp;&amp; pool.Count &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            return pool.Dequeue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UIItemBase item &#x3D; InstantiateItem(className, prefabs, parent);</span><br><span class="line">        AddSubItem(item);</span><br><span class="line">        return item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void GenerateItemList(string className, GameObject prefabs, Transform parent, int count, ref List&lt;UIItemBase&gt; container)</span><br><span class="line">    &#123;</span><br><span class="line">        while (container.Count &lt; count)</span><br><span class="line">        &#123;</span><br><span class="line">            UIItemBase item &#x3D; GenerateItem(className, prefabs, transform);</span><br><span class="line">            container.Add(item);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        while (container.Count &gt; count)</span><br><span class="line">        &#123;</span><br><span class="line">            UIItemBase item &#x3D; container[container.Count];</span><br><span class="line">            container.Remove(item);</span><br><span class="line">            RecyleItem(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected UIItemBase InstantiateItem(string className, GameObject prefabs, Transform parent)</span><br><span class="line">    &#123;</span><br><span class="line">        GameObject obj &#x3D; GameObject.Instantiate(prefabs, parent);</span><br><span class="line">        UIItemBase item &#x3D; (UIItemBase)UIModule.Instance.CreateUIClass(className);</span><br><span class="line">        item.Ctor(obj, parent);</span><br><span class="line">        item.Name &#x3D; className;</span><br><span class="line">        return item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 回收子item</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;item&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    protected void RecyleItem(UIItemBase item)</span><br><span class="line">    &#123;</span><br><span class="line">        RemoveSubItem(item);</span><br><span class="line"></span><br><span class="line">        Queue&lt;UIItemBase&gt; cachePool &#x3D; childItemPool[item.Name];</span><br><span class="line">        if (cachePool &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            cachePool &#x3D; new Queue&lt;UIItemBase&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cachePool.Enqueue(item);</span><br><span class="line">        item.SetActive(false);</span><br><span class="line">        if (item.IsItemOpen())</span><br><span class="line">        &#123;</span><br><span class="line">            item.OnItemClose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void RecyleItemList(int count, ref List&lt;UIItemBase&gt; container)</span><br><span class="line">    &#123;</span><br><span class="line">        while (container.Count &gt; count)</span><br><span class="line">        &#123;</span><br><span class="line">            UIItemBase item &#x3D; container[container.Count];</span><br><span class="line">            RecyleItem(item);</span><br><span class="line">            container.Remove(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void ClearCache()</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (var pool in childItemPool.Values)</span><br><span class="line">        &#123;</span><br><span class="line">            foreach (var item in pool)</span><br><span class="line">            &#123;</span><br><span class="line">                item.Dispose();</span><br><span class="line">            &#125;</span><br><span class="line">            pool.Clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        childItemPool.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 添加子对象，包括item、childview</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;item&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    protected void AddSubItem(UIBase item)</span><br><span class="line">    &#123;</span><br><span class="line">        if (subItems.Contains(item))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(&quot;item已存在&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        subItems.Add(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void RemoveSubItem(UIBase item)</span><br><span class="line">    &#123;</span><br><span class="line">        if (subItems.Contains(item))</span><br><span class="line">        &#123;</span><br><span class="line">            subItems.Remove(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void RemoveAllSubItem()</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (var item in subItems)</span><br><span class="line">        &#123;</span><br><span class="line">            item.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        subItems.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void OnOpenSubItem()</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (var item in subItems)</span><br><span class="line">        &#123;</span><br><span class="line">            if (item is UIItemBase)</span><br><span class="line">            &#123;</span><br><span class="line">                (item as UIItemBase).OnItemOpen();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void OnCloseSubItem()</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (var item in subItems)</span><br><span class="line">        &#123;</span><br><span class="line">            if (item is UIItemBase)</span><br><span class="line">            &#123;</span><br><span class="line">                (item as UIItemBase).OnItemClose();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Dispose()</span><br><span class="line">    &#123;</span><br><span class="line">        base.Dispose();</span><br><span class="line"></span><br><span class="line">        RemoveAllSubItem();</span><br><span class="line">        ClearCache();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>五、ChildViewBase ：重写了Open、Close方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class ChildViewBase:PanelBase</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; UIModule调用，用于打开一个界面。如果该界面还未加载，会调用Load加载界面</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;args&quot;&gt;&lt;&#x2F;param&gt; 界面参数</span><br><span class="line">    public override void Open(params object[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!isOpen)</span><br><span class="line">        &#123;</span><br><span class="line">            SetActive(true);</span><br><span class="line">            OnOpenSubItem();</span><br><span class="line">            isOpen &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Close()</span><br><span class="line">    &#123;</span><br><span class="line">        if (isOpen)</span><br><span class="line">        &#123;</span><br><span class="line">            OnCloseSubItem();</span><br><span class="line">            SetActive(false);</span><br><span class="line">            isOpen &#x3D; false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>六、ViewBase ：所有界面基类，主要是提供了界面的加载、卸载（注意ab的加、卸载），子界面的添加、维护。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 界面基类，可以生成ChildView</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class ViewBase: PanelBase</span><br><span class="line">&#123;</span><br><span class="line">    protected object[] openParam;</span><br><span class="line">    protected ViewDefine.ViewType viewType;</span><br><span class="line">    protected ViewDefine.ViewLoadStateDefine loadState &#x3D; ViewDefine.ViewLoadStateDefine.NONE;</span><br><span class="line">    protected bool isHide &#x3D; false;</span><br><span class="line">    protected float closeTime &#x3D; 0;&#x2F;&#x2F;用于回收计时</span><br><span class="line"></span><br><span class="line">    public ViewDefine.ViewID ViewID &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 打开界面，一次OnOpen对应一次OnClose，子类实现</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;args&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    protected virtual void OnOpen(params object[] args)&#123; &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 用于刷新界面，每次调用OpenView都会调用，避免业务重复打开界面</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;args&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    protected virtual void OnRefreshView(params object[] args) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 获得焦点。1.打开界面。2.上一层界面被关闭，重新获得焦点</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    protected virtual void OnEnabled() &#123; &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Update(float dt) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 失去焦点。1.关闭界面。2.有新的界面打开。</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    protected virtual void OnDisable() &#123; &#125;</span><br><span class="line"></span><br><span class="line">    protected virtual void OnClose() &#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; UIModule调用，用于打开一个界面。如果该界面还未加载，会调用Load加载界面</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;args&quot;&gt;&lt;&#x2F;param&gt; 界面参数</span><br><span class="line">    public override void Open(params object[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        openParam &#x3D; args;</span><br><span class="line">        if (loadState &#x3D;&#x3D; ViewDefine.ViewLoadStateDefine.LOADED)</span><br><span class="line">        &#123;</span><br><span class="line">            DoRealOpen();</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            Load();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 加载界面，包括界面的ab包，ab的依赖包，最终返回一个Prefab用于实例化界面</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    private void Load()</span><br><span class="line">    &#123;</span><br><span class="line">        if (loadState !&#x3D; ViewDefine.ViewLoadStateDefine.NONE) return;</span><br><span class="line"></span><br><span class="line">        loadState &#x3D; ViewDefine.ViewLoadStateDefine.LOADING;</span><br><span class="line">        ResManager.Instance.LoadPrefab(ViewDefine.GetViewPath(ViewID), &quot;&quot;, LoadFinish);      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void LoadFinish(object prefab)</span><br><span class="line">    &#123;</span><br><span class="line">        loadState &#x3D; ViewDefine.ViewLoadStateDefine.LOADED;</span><br><span class="line">        gameObject &#x3D; GameObject.Instantiate((GameObject)prefab, UIModule.Instance.GetViewRoot(viewType));</span><br><span class="line">        transform &#x3D; gameObject.transform;</span><br><span class="line">        ExportHierarchy();</span><br><span class="line"></span><br><span class="line">        OnLoad();</span><br><span class="line">        DoRealOpen();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void DoRealOpen()</span><br><span class="line">    &#123;</span><br><span class="line">        if (!isOpen)</span><br><span class="line">        &#123;</span><br><span class="line">            SetActiveEx(true);</span><br><span class="line">            OnOpen(openParam);</span><br><span class="line">            OnOpenSubItem();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        OnRefreshView(openParam);</span><br><span class="line">        ShowView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 显示、隐藏界面，这边使用的方式是将界面移到屏幕外。</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 另外几种做法是：1.SetActive直接隐藏go。2.设置Scale为0。3.设置layer out</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;isActive&quot;&gt;&lt;&#x2F;param&gt; 是否显示</span><br><span class="line">    public void SetActiveEx(bool isActive)</span><br><span class="line">    &#123;</span><br><span class="line">        if (transform) &#123;</span><br><span class="line">            if (isActive)</span><br><span class="line">            &#123;</span><br><span class="line">                transform.localPosition &#x3D; Vector3.zero;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                transform.localPosition &#x3D; new Vector3(10000, 10000, 0);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void ShowView()</span><br><span class="line">    &#123;</span><br><span class="line">        SetActiveEx(true);</span><br><span class="line">        transform.SetAsFirstSibling();</span><br><span class="line"></span><br><span class="line">        if (!isHide)</span><br><span class="line">        &#123;</span><br><span class="line">            isHide &#x3D; true;</span><br><span class="line">            OnEnabled();</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 界面失去焦点，如果是打开弹窗，不隐藏该界面。</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;keepShow&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    public virtual void HideView(bool keepShow &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        SetActiveEx(keepShow);</span><br><span class="line"></span><br><span class="line">        if (isHide)</span><br><span class="line">        &#123;</span><br><span class="line">            isHide &#x3D; false;</span><br><span class="line">            OnDisable();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Close()</span><br><span class="line">    &#123;</span><br><span class="line">        if (isOpen)</span><br><span class="line">        &#123;</span><br><span class="line">            UIModule.Instance.CloseView(ViewID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void CloseView()</span><br><span class="line">    &#123;</span><br><span class="line">        HideView();</span><br><span class="line">        if (isOpen)</span><br><span class="line">        &#123;</span><br><span class="line">            OnClose();</span><br><span class="line">            OnCloseSubItem();</span><br><span class="line">            CloseSubPanel();</span><br><span class="line">            closeTime &#x3D; Time.realtimeSinceStartup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public float GetCloseTime()</span><br><span class="line">    &#123;</span><br><span class="line">        return closeTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsPopView()</span><br><span class="line">    &#123;</span><br><span class="line">        return viewType &#x3D;&#x3D; ViewDefine.ViewType.POPUP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsMainView()</span><br><span class="line">    &#123;</span><br><span class="line">        return viewType &#x3D;&#x3D; ViewDefine.ViewType.MAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsFixedView()</span><br><span class="line">    &#123;</span><br><span class="line">        return viewType &#x3D;&#x3D; ViewDefine.ViewType.FIXED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsShow()</span><br><span class="line">    &#123;</span><br><span class="line">        return !isHide;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsOnLoadDestroy()</span><br><span class="line">    &#123;</span><br><span class="line">        return loadState &#x3D;&#x3D; ViewDefine.ViewLoadStateDefine.LOADING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected List&lt;ChildViewBase&gt; childView &#x3D; new List&lt;ChildViewBase&gt;();</span><br><span class="line">    protected ChildViewBase AddChildPanel(string className, GameObject obj, Transform parent)</span><br><span class="line">    &#123;</span><br><span class="line">        ChildViewBase view &#x3D; (ChildViewBase)UIModule.Instance.CreateUIClass(className);</span><br><span class="line">        view.Ctor(obj, parent);</span><br><span class="line">        childView.Add(view);</span><br><span class="line">        AddSubItem(view);</span><br><span class="line">        return view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void CloseSubPanel()</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (var item in childView)</span><br><span class="line">        &#123;</span><br><span class="line">            if (item.IsOpen())</span><br><span class="line">            &#123;</span><br><span class="line">                item.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>七、UIHierarchy：保存了业务导出的引用对象。ExportPanelHierarchy寻找UIExportItem 元素并保存到UIHierarchy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public class UIHierarchy : MonoBehaviour</span><br><span class="line">&#123;</span><br><span class="line">    [System.Serializable]</span><br><span class="line">    public class ItemInfo</span><br><span class="line">    &#123;</span><br><span class="line">        public string name;</span><br><span class="line">        public Object item;</span><br><span class="line"></span><br><span class="line">        public ItemInfo() &#123; &#125;</span><br><span class="line">        public ItemInfo(string _name, Object _item) &#123; name &#x3D; _name; item &#x3D; _item; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 控件</span><br><span class="line">    public List&lt;ItemInfo&gt; widgets;</span><br><span class="line">    public void SetWidgets(List&lt;ItemInfo&gt; data)</span><br><span class="line">    &#123;</span><br><span class="line">        if (data.Count &#x3D;&#x3D; 0) return;</span><br><span class="line">        if (widgets &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            widgets &#x3D; new List&lt;ItemInfo&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        widgets.Clear();</span><br><span class="line">        widgets.AddRange(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 外部引用</span><br><span class="line">    public List&lt;ItemInfo&gt; externals;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">[DisallowMultipleComponent]</span><br><span class="line">public class UIExportItem : MonoBehaviour</span><br><span class="line">&#123;</span><br><span class="line">    public string FieldName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.UI;</span><br><span class="line">using UnityEditor;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">public class ExportPanelHierarchy</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 导出组件优先级</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    private static System.Type[] ms_componentTypes &#x3D; &#123;</span><br><span class="line">        typeof(Button),</span><br><span class="line">        typeof(InputField),</span><br><span class="line">        typeof(ScrollRect),</span><br><span class="line">        typeof(Dropdown),</span><br><span class="line">        typeof(Image),</span><br><span class="line">        typeof(RawImage),</span><br><span class="line">        typeof(Scrollbar),</span><br><span class="line">        typeof(Slider),</span><br><span class="line">        typeof(Text),</span><br><span class="line">        typeof(Toggle),</span><br><span class="line">        typeof(GridLayoutGroup),</span><br><span class="line">        typeof(HorizontalOrVerticalLayoutGroup),</span><br><span class="line">        typeof(LayoutElement),        </span><br><span class="line">        typeof(CanvasGroup),</span><br><span class="line">        typeof(ToggleGroup),</span><br><span class="line">        typeof(TextMesh),</span><br><span class="line">        typeof(Animation),</span><br><span class="line">        typeof(Camera),</span><br><span class="line">        typeof(SpriteRenderer),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    static Object FindComponent(GameObject go)</span><br><span class="line">    &#123;</span><br><span class="line">        Object component &#x3D; null;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; ms_componentTypes.Length; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            component &#x3D; go.GetComponent(ms_componentTypes[i]);</span><br><span class="line">            if (component !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return component;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;生成嵌套UI层级</span><br><span class="line">    public static void ExportNested(Object obj)</span><br><span class="line">    &#123;</span><br><span class="line">        GameObject root &#x3D; obj as GameObject;</span><br><span class="line">        if (root &#x3D;&#x3D; null) return;</span><br><span class="line"></span><br><span class="line">        UIHierarchy hierarchy &#x3D; root.GetComponent&lt;UIHierarchy&gt; ();</span><br><span class="line">        if(hierarchy&#x3D;&#x3D;null)</span><br><span class="line">        &#123;</span><br><span class="line">            hierarchy &#x3D; root.AddComponent&lt;UIHierarchy&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;生成根节点层级</span><br><span class="line">        List&lt;UIHierarchy.ItemInfo&gt; fields &#x3D; new List&lt;UIHierarchy.ItemInfo&gt;();</span><br><span class="line">        GetChildComponentUtilHierarchy (root.transform, fields);</span><br><span class="line">        hierarchy.SetWidgets(fields);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;生成子panel层级</span><br><span class="line">        UIHierarchy[] childHierarchys &#x3D; root.GetComponentsInChildren&lt;UIHierarchy&gt;(true);</span><br><span class="line">        for(int i&#x3D;1; i&lt;childHierarchys.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            UIHierarchy childHrcy &#x3D; childHierarchys [i];</span><br><span class="line"></span><br><span class="line">            List&lt;UIHierarchy.ItemInfo&gt; childUIItem &#x3D; new List&lt;UIHierarchy.ItemInfo&gt;();</span><br><span class="line">            GetChildComponentUtilHierarchy (childHrcy.transform, childUIItem);</span><br><span class="line">            childHrcy.SetWidgets(childUIItem);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EditorUtility.SetDirty(root);</span><br><span class="line">        AssetDatabase.SaveAssets();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;导出传入节点的层级，直到某个子节点挂有UIHierarchy组件</span><br><span class="line">    private static void GetChildComponentUtilHierarchy(Transform transRoot, List&lt;UIHierarchy.ItemInfo&gt; fields)</span><br><span class="line">    &#123;</span><br><span class="line">        for(int i&#x3D;0; i&lt;transRoot.childCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Transform trans &#x3D; transRoot.GetChild (i);</span><br><span class="line"></span><br><span class="line">            UIHierarchy hrchy &#x3D; trans.GetComponent&lt;UIHierarchy&gt; ();</span><br><span class="line">            if(hrchy!&#x3D;null)</span><br><span class="line">            &#123;</span><br><span class="line">                fields.Add (new UIHierarchy.ItemInfo(hrchy.name, hrchy));</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            UIExportItem uiItem &#x3D; trans.GetComponent&lt;UIExportItem&gt;();</span><br><span class="line">            if (uiItem !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                Object fieldItem &#x3D; FindComponent(uiItem.gameObject);</span><br><span class="line">                if (fieldItem &#x3D;&#x3D; null)</span><br><span class="line">                &#123;</span><br><span class="line">                    fieldItem &#x3D; uiItem.transform;</span><br><span class="line">                &#125;</span><br><span class="line">                fields.Add(new UIHierarchy.ItemInfo(uiItem.name, fieldItem));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            GetChildComponentUtilHierarchy (trans, fields);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>八、UIModule：核心管理类，提供给全局唯一的打开界面方法，维护层级栈。维护界面缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Reflection;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">public class UIModule</span><br><span class="line">&#123;</span><br><span class="line">    #region Instance</span><br><span class="line">    private static UIModule m_Instance;</span><br><span class="line">    public static UIModule Instance</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_Instance ?? (m_Instance &#x3D; new UIModule());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    private const float CACHE_TIME &#x3D; 30;&#x2F;&#x2F;界面缓存时间</span><br><span class="line">    private int curSceneID &#x3D; 0;&#x2F;&#x2F;当前打开的场景id，每个场景都有自己的层级栈</span><br><span class="line">    private int curViewID &#x3D; 0;&#x2F;&#x2F;当前打开的界面id</span><br><span class="line">    private int lastViewID &#x3D; 0;&#x2F;&#x2F;上一个界面id</span><br><span class="line"></span><br><span class="line">    private List&lt;int&gt; openViewList;&#x2F;&#x2F;当前打开的界面列表，按顺序</span><br><span class="line">    private Dictionary&lt;int, ViewBase&gt; cacheView;&#x2F;&#x2F;缓存区，等待销毁，从缓存区取要移除</span><br><span class="line">    private Dictionary&lt;int, List&lt;int&gt;&gt; naviStack;&#x2F;&#x2F;场景的层级栈，key为场景id,用于维护场景</span><br><span class="line">    private Dictionary&lt;int, ViewBase&gt; viewPool;&#x2F;&#x2F;保存所有ViewBase的引用，包括缓存区的，界面销毁时需要移除。</span><br><span class="line">    private Dictionary&lt;ViewDefine.ViewType, Transform&gt; viewRoot;&#x2F;&#x2F;界面实例化出来的父节点，不同界面的父节点不一样。</span><br><span class="line">    private Transform uiRoot;&#x2F;&#x2F;ui根节点</span><br><span class="line">    private float lastCheckCacheTime;&#x2F;&#x2F;上次检查缓存时间，一秒检查一次</span><br><span class="line"></span><br><span class="line">    public void Init()</span><br><span class="line">    &#123;</span><br><span class="line">        openViewList &#x3D; new List&lt;int&gt;();</span><br><span class="line">        cacheView &#x3D; new Dictionary&lt;int, ViewBase&gt;();</span><br><span class="line">        naviStack &#x3D; new Dictionary&lt;int, List&lt;int&gt;&gt;();</span><br><span class="line">        viewPool &#x3D; new Dictionary&lt;int, ViewBase&gt;();</span><br><span class="line"></span><br><span class="line">        uiRoot &#x3D; GameObject.Find(&quot;UIRoot&quot;).transform;</span><br><span class="line">        viewRoot &#x3D; new Dictionary&lt;ViewDefine.ViewType, Transform&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            &#123; ViewDefine.ViewType.MAIN, uiRoot.Find(&quot;main&quot;) &#125;,</span><br><span class="line">            &#123; ViewDefine.ViewType.POPUP, uiRoot.Find(&quot;main&quot;) &#125;,</span><br><span class="line">            &#123; ViewDefine.ViewType.FIXED, uiRoot.Find(&quot;fixed&quot;) &#125;,</span><br><span class="line">            &#123; ViewDefine.ViewType.GUIDE, uiRoot.Find(&quot;guide&quot;) &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        lastCheckCacheTime &#x3D; Time.realtimeSinceStartup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Transform GetViewRoot(ViewDefine.ViewType viewType)</span><br><span class="line">    &#123;</span><br><span class="line">        if (viewType &#x3D;&#x3D; ViewDefine.ViewType.SCENE)</span><br><span class="line">        &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            return viewRoot[viewType];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        int openCount &#x3D; openViewList.Count;</span><br><span class="line">        ViewBase view;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; openCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            int viewId &#x3D; openViewList[i];</span><br><span class="line">            if (viewPool.TryGetValue(viewId, out view))</span><br><span class="line">            &#123;</span><br><span class="line">                view.Update(dt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;清楚缓存时间到了的界面</span><br><span class="line">        float curTime &#x3D; Time.realtimeSinceStartup;</span><br><span class="line">        if (curTime - lastCheckCacheTime &gt; 1)</span><br><span class="line">        &#123;</span><br><span class="line">            foreach (var item in cacheView)</span><br><span class="line">            &#123;</span><br><span class="line">                if (curTime - item.Value.GetCloseTime() &gt; CACHE_TIME)</span><br><span class="line">                &#123;</span><br><span class="line">                    item.Value.Dispose();</span><br><span class="line">                    cacheView.Remove(item.Key);</span><br><span class="line">                    viewPool.Remove(item.Key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastCheckCacheTime &#x3D; curTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 外部调用 打开一个窗口的唯一方式</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 如果上一个界面lastView存在，需要把lastView入栈</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;viewID&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;param&quot;&gt;&lt;&#x2F;param&gt; 界面打开参数，给业务使用的</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">    public ViewBase OpenView(ViewDefine.ViewID viewID, params object[] param)</span><br><span class="line">    &#123;</span><br><span class="line">        int viewKey &#x3D; (int)viewID;</span><br><span class="line">        ViewBase view &#x3D; FindOpenView(viewKey);</span><br><span class="line"></span><br><span class="line">        if (view &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            view &#x3D; CreateView(viewID);</span><br><span class="line"></span><br><span class="line">            if (view &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogErrorFormat(&quot;OpenView CreateView Fail..viewID:&quot;, viewID);</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            view.ViewID &#x3D; viewID;</span><br><span class="line">            AddOpenView(viewKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (curViewID &#x3D;&#x3D; viewKey)</span><br><span class="line">        &#123;</span><br><span class="line">            view.Open(param);</span><br><span class="line">            return view;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (view.IsPopView() || view.IsMainView())</span><br><span class="line">        &#123;</span><br><span class="line">            lastViewID &#x3D; curViewID;</span><br><span class="line">            curViewID &#x3D; viewKey;</span><br><span class="line"></span><br><span class="line">            if (lastViewID &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                OnBackstage(lastViewID);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        view.Open(param);</span><br><span class="line">        return view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ViewBase FindOpenView(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        ViewBase view &#x3D; null;</span><br><span class="line">        if (openViewList.Contains(viewKey))</span><br><span class="line">        &#123;            </span><br><span class="line">            viewPool.TryGetValue(viewKey, out view);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void AddOpenView(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        if (openViewList.Contains(viewKey))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogFormat(&quot;界面已打开:&#123;0&#125;&quot;, viewKey);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        openViewList.Add(viewKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void RemoveOpenView(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        if (openViewList.Contains(viewKey))</span><br><span class="line">        &#123;</span><br><span class="line">            openViewList.Remove(viewKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 创建新的view，先从缓存里面找</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;viewID&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">    private ViewBase CreateView(ViewDefine.ViewID viewID)</span><br><span class="line">    &#123;</span><br><span class="line">        int viewKey &#x3D; (int)viewID;</span><br><span class="line">        ViewBase view &#x3D; GetViewFromCache(viewKey);</span><br><span class="line"></span><br><span class="line">        if (view &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            string viewName &#x3D; ViewDefine.GetViewType(viewID);</span><br><span class="line">            &#x2F;&#x2F;加载程序集，创建程序集里面的 命名空间.类型名 实例</span><br><span class="line">            object ect &#x3D; CreateUIClass(viewName);</span><br><span class="line"></span><br><span class="line">            view &#x3D; (ViewBase)ect;&#x2F;&#x2F;类型转换并返回</span><br><span class="line">            viewPool.Add((int)viewID, view);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public object CreateUIClass(string calssName)</span><br><span class="line">    &#123;</span><br><span class="line">        return Assembly.GetExecutingAssembly().CreateInstance(calssName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ViewBase GetViewFromCache(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        ViewBase view &#x3D; null;</span><br><span class="line">        if (cacheView.TryGetValue(viewKey, out view)) &#123;</span><br><span class="line">            cacheView.Remove(viewKey);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void AddViewToCache(int viewKey, ViewBase view)</span><br><span class="line">    &#123;</span><br><span class="line">        cacheView[viewKey] &#x3D; view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private int GetTopViewOfStack()</span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;int&gt; stack &#x3D; naviStack[curSceneID];</span><br><span class="line">        if (stack &#x3D;&#x3D; null || stack.Count &#x3D;&#x3D; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return stack[stack.Count];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ViewBase PopViewFormStack()</span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;int&gt; stack &#x3D; naviStack[curSceneID];</span><br><span class="line">        if (stack &#x3D;&#x3D; null || stack.Count &#x3D;&#x3D; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int index &#x3D; stack.Count;</span><br><span class="line">        int viewId &#x3D; stack[index];</span><br><span class="line">        ViewBase view &#x3D; GetViewByKey(viewId);</span><br><span class="line">        stack.RemoveAt(index);</span><br><span class="line"></span><br><span class="line">        if (view.IsPopView())</span><br><span class="line">        &#123;</span><br><span class="line">            for (int i &#x3D; index-1; i &gt; 0; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                ViewBase temp &#x3D; GetViewByKey(stack[i]);</span><br><span class="line">                temp.SetActiveEx(true);</span><br><span class="line"></span><br><span class="line">                if (temp.IsMainView()) break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        curViewID &#x3D; viewId;</span><br><span class="line">        view.ShowView();</span><br><span class="line">        AddOpenView(viewId);</span><br><span class="line">        return view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 向栈里添加元素</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;viewKey&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;isForce&quot;&gt;&lt;&#x2F;param&gt;true时，栈里存在会先移除在加入，否则栈里存在就不处理了</span><br><span class="line">    private void AddViewToStack(int viewKey, bool isForce &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;int&gt; stack &#x3D; naviStack[curSceneID];</span><br><span class="line">        if (stack &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            stack &#x3D; new List&lt;int&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (stack.Contains(viewKey))</span><br><span class="line">        &#123;</span><br><span class="line">            if (isForce)</span><br><span class="line">            &#123;</span><br><span class="line">                stack.Remove(viewKey);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stack.Add(viewKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void RemoveFromStack(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;int&gt; stack &#x3D; naviStack[curSceneID];</span><br><span class="line">        if (stack &#x3D;&#x3D; null || stack.Count &#x3D;&#x3D; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (stack.Contains(viewKey))</span><br><span class="line">        &#123;</span><br><span class="line">            stack.Remove(viewKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 进入后台</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;viewKey&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    private void OnBackstage(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        AddViewToStack(viewKey);</span><br><span class="line">        ViewBase lastView &#x3D; GetViewByKey(lastViewID);</span><br><span class="line"></span><br><span class="line">        if (lastView.IsPopView())</span><br><span class="line">        &#123;</span><br><span class="line">            lastView.HideView(true);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            lastView.HideView(false);</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 关闭界面，如果是当前打开界面，需要从栈顶弹出新的界面</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;viewKey&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    private void InsertClose(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        RemoveView(viewKey);</span><br><span class="line"></span><br><span class="line">        if (viewKey &#x3D;&#x3D; curViewID)</span><br><span class="line">        &#123;</span><br><span class="line">            curViewID &#x3D; 0;</span><br><span class="line">            PopViewFormStack();</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveFromStack(viewKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 移除界面，从打开列表移除，添加到缓存</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;viewKey&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    private void RemoveView(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        RemoveOpenView(viewKey);</span><br><span class="line">        RemoveFromStack(viewKey);</span><br><span class="line">        ViewBase view &#x3D; GetViewByKey(viewKey);</span><br><span class="line">        view.CloseView();</span><br><span class="line">        AddViewToCache(viewKey, view);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ViewBase GetViewByKey(int viewKey)</span><br><span class="line">    &#123;</span><br><span class="line">        return viewPool[viewKey];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void CloseView(ViewDefine.ViewID viewID)</span><br><span class="line">    &#123;</span><br><span class="line">        int viewKey &#x3D; (int)viewID;</span><br><span class="line">        if (openViewList.Contains(viewKey))</span><br><span class="line">        &#123;</span><br><span class="line">            InsertClose(viewKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void CloseCurView()</span><br><span class="line">    &#123;</span><br><span class="line">        if (curViewID &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            CloseView((ViewDefine.ViewID)curViewID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 进入新的场景</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;sceneID&quot;&gt;&lt;&#x2F;param&gt; 场景id</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;isNative&quot;&gt;&lt;&#x2F;param&gt; 是否需要打开ui栈，isBack&#x3D;true时，从当前场景的栈顶弹出界面</span><br><span class="line">    public void EnterScene(int sceneID, bool isBack)</span><br><span class="line">    &#123;</span><br><span class="line">        curSceneID &#x3D; sceneID;</span><br><span class="line">        if (naviStack[sceneID] &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            naviStack[sceneID] &#x3D; new List&lt;int&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (isBack)</span><br><span class="line">        &#123;</span><br><span class="line">            PopViewFormStack();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 退出当前场景</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;pushToStack&quot;&gt;&lt;&#x2F;param&gt; 是否压栈，用于场景返回时恢复ui层级</span><br><span class="line">    public void ExitScene(bool pushToStack)</span><br><span class="line">    &#123;</span><br><span class="line">        int count &#x3D; openViewList.Count;</span><br><span class="line">        ViewBase temp &#x3D; null;</span><br><span class="line">        int viewKey &#x3D; 0;</span><br><span class="line"></span><br><span class="line">        for (int i &#x3D; count; i &gt; 0; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            viewKey &#x3D; openViewList[i];</span><br><span class="line">            temp &#x3D; GetViewByKey(viewKey);</span><br><span class="line"></span><br><span class="line">            if (temp !&#x3D; null &amp;&amp; (temp.IsMainView() || temp.IsPopView()))</span><br><span class="line">            &#123;</span><br><span class="line">                if (pushToStack)</span><br><span class="line">                &#123;</span><br><span class="line">                    RemoveOpenView(viewKey);</span><br><span class="line">                    AddViewToStack(viewKey, false);</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    RemoveView(viewKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;int&gt; stack &#x3D; naviStack[curSceneID];</span><br><span class="line">        if (stack !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; stack.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                ViewBase view &#x3D; GetViewByKey(stack[i]);</span><br><span class="line">                view.HideView();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        curViewID &#x3D; 0;</span><br><span class="line">        lastViewID &#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/06/2025-07-06/" data-id="cmcvdrdx1000kccz83jv97m49" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity/" rel="tag">unity</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-05" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/05/2025-07-05/" class="article-date">
  <time datetime="2025-07-05T00:27:04.000Z" itemprop="datePublished">2025-07-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/05/2025-07-05/">框架之资源加载</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本篇我们实现unity里的加载模块，他的主要功能是，业务传入资源名字和资源类型，加载模块加载到对应的资源后返回给业务，业务不需要关心该资源是从本地加载还是从AssetBundle里加载。</p>
<p>加载模块分两部分1.各资源的加载器，例如ab包加载器、Asset加载器、网络下载。2.各加载器的管理类，提供给业务的接口都在这里</p>
<p>需要支持的能力</p>
<p>1.能切换不同加载模式 开发阶段编辑器运行直接加载资源无需打ab包,测试或正式发布阶段通过ab包加载资源</p>
<p>2.缓存机制 能定时清理长时间未使用的资源内存</p>
<p>3.既有同步加载 也有异步加载</p>
<p>复杂点：</p>
<p>1.根据业务传入的资源名字，获取到editor路径、ab包名字。需要事先根据资源名字保存资源的路径、ab包路径配置。</p>
<p>2.ab包的引用计数维护：加载时ReferencedCount+1，卸载时ReferencedCount-1。</p>
<p>两种引用：AB包之间的相互依赖，ab包加载时，依赖包引用计数加1，ab包卸载时，依赖包引用减1。2.资源引用，例如使用AssetBundle.LoadAsset加载资源时，该ab包引用计数加一，引用对象被删除时，引用计数减1.</p>
<p>问题是如何确保被删除的引用对象引用计数能正确减少。</p>
<p>有两种方式：</p>
<p>　　1.纯引用计数。ab包依赖和asset引用都使用引用计数。asset引用类型大概以下几种</p>
<p>　　1-1.预制体，额外封装一层，所有预制体的生成和销毁都由一个管理类统一管理。</p>
<p>例如封装一个ResourceItem类，所有预制体的生成和销毁都必须走这个类的的Create和Dispose类，在ctor方法里加载ab包、实例化预制体，在Dispose方法里Distory对象、卸载ab包（这里的加、卸载只是引用计数加1、减1）。需要业务手动的释放调用Dispose释放对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">-- 资源</span><br><span class="line">-- 所有非UI的预制加载</span><br><span class="line">local ResourceItem &#x3D; class(&quot;ResourceItem&quot;, ObjectBase)</span><br><span class="line"></span><br><span class="line">-- 静态创建ResourceItem接口</span><br><span class="line">-- path Data目录以下，预制的路径</span><br><span class="line">function ResourceItem.Create(target, filepath, parent, onLoaded, async)</span><br><span class="line">    local abpath &#x3D; PubFunc.GetAbNameOfPath(filepath)</span><br><span class="line">    local name &#x3D;  PubFunc.GetNameFromPath(filepath)</span><br><span class="line">    local item &#x3D; ResourceItem.new(filepath, abpath, name, parent, onLoaded, async)</span><br><span class="line">    target:AddSubItem(item)</span><br><span class="line">    return item</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function ResourceItem.CreateUIItem(target, abpath, name, parent, onLoaded, async)</span><br><span class="line">    local filepath &#x3D; abpath</span><br><span class="line">    if string.find(abpath, name)&#x3D;&#x3D;nil then</span><br><span class="line">        filepath &#x3D; abpath..name</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local item &#x3D; ResourceItem.new(filepath, abpath, name, parent, onLoaded, async)</span><br><span class="line">    target:AddSubItem(item)</span><br><span class="line">    return item</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function ResourceItem:ctor(filepath, abpath, name, parent, onLoaded, async)</span><br><span class="line">    ResourceItem.super.ctor(self)async &#x3D; async and true or false</span><br><span class="line"></span><br><span class="line">    self._filepath  &#x3D; filepath</span><br><span class="line">    self._path         &#x3D; abpath         -- 文件路径</span><br><span class="line">    self._name         &#x3D; name</span><br><span class="line">    self._parent    &#x3D; parent</span><br><span class="line">    self._onLoaded     &#x3D; onLoaded     -- 加载完回调</span><br><span class="line"></span><br><span class="line">    self.gameObject         &#x3D; nil         --外部可直接获取</span><br><span class="line">    self.transform             &#x3D; nil</span><br><span class="line"></span><br><span class="line">    self._loadKey &#x3D; me.modules.resource:CreateAsyn(abpath, name, handler(self, self.OnLoadComplete), async)</span><br><span class="line">end-- 清理</span><br><span class="line">function ResourceItem:Dispose()</span><br><span class="line">    if self.gameObject then</span><br><span class="line">        -- 销毁</span><br><span class="line">        me.modules.resource:Delete(self.gameObject)</span><br><span class="line">        self.gameObject &#x3D; nil</span><br><span class="line">        self.transform &#x3D; nil</span><br><span class="line">    elseif self._loadKey then</span><br><span class="line">        -- 取消加载</span><br><span class="line">        me.modules.resource:CancelLoad(self._loadKey)</span><br><span class="line">        self._loadKey &#x3D; nil</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    ResourceItem.super.Dispose(self)</span><br><span class="line">end-- 是否已加载</span><br><span class="line">function ResourceItem:IsLoaded()</span><br><span class="line">    return self.gameObject ~&#x3D; nil</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 加载完成回调</span><br><span class="line">function ResourceItem:OnLoadComplete(go)</span><br><span class="line">    self._loadKey    &#x3D; nil</span><br><span class="line">    local trans &#x3D; nil</span><br><span class="line"></span><br><span class="line">    if go then</span><br><span class="line">        trans &#x3D; go.transform</span><br><span class="line">        if self._parent then</span><br><span class="line">            go:SetParent(self._parent)</span><br><span class="line">        end</span><br><span class="line">        trans:SetLocalPositionZero()</span><br><span class="line">        trans:SetLocalScaleOne()</span><br><span class="line">    else</span><br><span class="line">        printError(&quot;加载RedourceItem失败，path:&quot;, self._path)</span><br><span class="line">    end</span><br><span class="line">    self.gameObject &#x3D; go</span><br><span class="line">    self.transform &#x3D; trans</span><br><span class="line"></span><br><span class="line">    -- 回调给外部</span><br><span class="line">    if self._onLoaded then</span><br><span class="line">        self._onLoaded(self)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">return ResourceItem</span><br></pre></td></tr></table></figure>
<p>你也可以在每个实例化的GameObject上挂在一个脚本，并在该脚本的Destory方法里卸载ab包的引用　　</p>
<p>1-2.场景类，这个比较简单，场景管理类肯定会记录当前的场景信息，在加载新场景时，先卸载当前的ab包就可以了。</p>
<p>1-3.sprite类，sprite是给image使用的，那么我们可以扩展一下Image的类。例如业务传入图片的名字，ImageEx类根据名字到LoadModule加载对应的ab及sprite并记录当前的sprite名字，当业务下次设置图片或Image对象被Destory时，根据保存的sprite名字卸载ab包。　　</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.UI;</span><br><span class="line">using Debugger &#x3D; LuaInterface.Debugger;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; image扩展，提供通过图片名字加载图片、从ab包、url、高清资源下载、emoji加载图片接口</span><br><span class="line">&#x2F;&#x2F;&#x2F; TP形Image. </span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class ImageEx : Image</span><br><span class="line">&#123;</span><br><span class="line">    private string m_SpriteName &#x3D; &quot;&quot;;</span><br><span class="line">    public string SpriteName</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_SpriteName;</span><br><span class="line">        &#125;</span><br><span class="line">        set</span><br><span class="line">        &#123;</span><br><span class="line">            m_SpriteName &#x3D; value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;protected override void OnDestroy()</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 销毁的时候要卸载一下ab</span><br><span class="line">        UnloadSprite();</span><br><span class="line">        StopCurrLoadingUrl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void UnloadSprite()</span><br><span class="line">    &#123;</span><br><span class="line">        if (!string.IsNullOrEmpty(SpriteName) &amp;&amp; sprite !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            SpriteModule.Instance.UnloadSpriteByName(SpriteName);</span><br><span class="line">            SpriteName &#x3D; null;</span><br><span class="line">            this.sprite &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;public void SetSpriteName(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        if (sprite !&#x3D; null &amp;&amp; SpriteName &#x3D;&#x3D; name)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UnloadSprite();</span><br><span class="line">        </span><br><span class="line">        if(string.IsNullOrEmpty(name))</span><br><span class="line">        &#123;</span><br><span class="line">            this.sprite &#x3D; null;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SpriteName &#x3D; name;</span><br><span class="line">        SpriteModule.Instance.LoadSpriteByName(name, onLoadedSprite);</span><br><span class="line">    &#125;private void onLoadedSprite(object obj)</span><br><span class="line">    &#123;</span><br><span class="line">        Sprite sp &#x3D; obj as Sprite;</span><br><span class="line">        this.sprite &#x3D; sp;</span><br><span class="line">        if (sp &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debugger.LogError(&quot;Load sprite null, name:&#123;0&#125;&quot;, m_SpriteUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if(!string.IsNullOrEmpty(m_strHdResName))</span><br><span class="line">            &#123;</span><br><span class="line">                sprite.name &#x3D; m_strHdResName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　1-4.shader类：全局就一个ab包，常驻内存就好了</p>
<p>　　1-5.音乐类：PlayMusic加载、StopMusic卸载就好了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 背景音乐</span><br><span class="line">    &#x2F;&#x2F; fromResources 是否从Resources文件夹下加载 </span><br><span class="line">    public void PlayMusic(string name, bool fromResources &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        if (string.IsNullOrEmpty(name)) return;</span><br><span class="line"></span><br><span class="line">        if (fromResources)</span><br><span class="line">        &#123;</span><br><span class="line">            if(MusicMute)</span><br><span class="line">            &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            AudioClip clip &#x3D; Resources.Load&lt;AudioClip&gt;(name);</span><br><span class="line">            if(clip !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                m_musicSource.enabled &#x3D; true;</span><br><span class="line">                m_musicSource.clip &#x3D; clip;</span><br><span class="line">                m_musicSource.loop &#x3D; true;</span><br><span class="line">                m_musicSource.Play();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            string strBundleName &#x3D; &quot;sound&#x2F;music&#x2F;&quot; +name;</span><br><span class="line">            LoadModule.Instance.LoadAssetFromBundle(strBundleName, name, typeof(AudioClip), (data) &#x3D;&gt; &#123;</span><br><span class="line">                m_musicSource.enabled &#x3D; true;</span><br><span class="line">                m_musicSource.clip &#x3D; data as AudioClip;</span><br><span class="line">                m_musicSource.loop &#x3D; true;</span><br><span class="line">                m_musicSource.Play();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 停止音乐并清理</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public void StopMusic()</span><br><span class="line">    &#123;</span><br><span class="line">        AudioClip m_musicClip &#x3D; m_musicSource.clip;</span><br><span class="line">        if (m_musicClip)</span><br><span class="line">        &#123;</span><br><span class="line">            m_musicSource.Stop();</span><br><span class="line">            m_musicSource.clip &#x3D; null;</span><br><span class="line"></span><br><span class="line">            string currentMusicName &#x3D; m_musicClip.name;</span><br><span class="line">            AssetBundleCache assetBundleCache &#x3D; ABCachePool.Instance.GetABCacheByName(string.Format(&quot;sound_music_&#123;0&#125;.unity3d&quot;, currentMusicName));</span><br><span class="line">            if (assetBundleCache !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                assetBundleCache.ReferencedCount &#x3D; 1;</span><br><span class="line">                LoadModule.Instance.UnloadAssetBundle(string.Format(&quot;sound&#x2F;music&#x2F;&#123;0&#125;&quot;, currentMusicName), true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　2.引用计数+弱引用。ab包依赖使用引用计数，asset引用使用弱引用，业务在加载asset时需要传入引用的对象（实例化就不用了，可以把实例化出来的GameObject当作引用对象），通过判断对象是否为空来判断引用关系。</p>
<p>　　强引用：我们实例化一个对象，直接引用了这个对象就是强引用。在这个对象被强引用的时，GC无法回收这个对象。只有当该对象所有的强引用都失去的时候，GC才会回收该对象。</p>
<p>　　弱引用：弱引用可以保持对对象的引用，同时允许GC在必要时释放对象，回收内存。这边一定要用弱引用，不然会影响对象的回收。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;System.WeakReference&gt; mReferenceOwnerList;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 为AB添加指定owner的引用</span><br><span class="line">&#x2F;&#x2F;&#x2F; 所有owner都销毁则ab引用计数归零可回收</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;owner&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">protected void retainOwner(UnityEngine.Object owner)</span><br><span class="line">&#123;</span><br><span class="line">   if (owner &#x3D;&#x3D; null)</span><br><span class="line">   &#123;</span><br><span class="line">       ResourceLogger.logErr(string.Format(&quot;引用对象不能为空!无法为资源:&#123;0&#125;添加引用!&quot;, AssetBundleName));</span><br><span class="line">       return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    foreach (var referenceowner in mReferenceOwnerList)</span><br><span class="line">    &#123;</span><br><span class="line">        if (owner.Equals(referenceowner))</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.WeakReference wr &#x3D; new System.WeakReference(owner);</span><br><span class="line">    mReferenceOwnerList.Add(wr);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 获取AB有效的引用对象计数</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">protected int updateOwnerReference()</span><br><span class="line">&#123;</span><br><span class="line">   for (int i &#x3D; 0; i &lt; mReferenceOwnerList.Count; i++)</span><br><span class="line">   &#123;</span><br><span class="line">        UnityEngine.Object o &#x3D; (UnityEngine.Object)mReferenceOwnerList[i].Target;</span><br><span class="line">        if (!o)</span><br><span class="line">        &#123;</span><br><span class="line">            mReferenceOwnerList.RemoveAt(i);</span><br><span class="line">            i--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return mReferenceOwnerList.Count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>第一种方式需要业务手动Dispose无用的对象，当然这是个好习惯，需要框架严格注意引用对象的管理。第二种需要业务在引用时传入引用的对象，需要额外的参数。</p>
<p>一个加载模块大致结构如下：</p>
<p>加载模块结构如上图，load为加载器，ResManager为提供给业务调用的接口，LoadModule为不使用ab包的加载接口，ABLoadModule为使用ab包的加载接口，这两个module对用户封闭。</p>
<p>AssetLoader：在editor模式下加载资源。AssetBundleLoader ：ab包加载器，负责从内存加载AssetBundle。BundleAssetLoader ：负责从指定的ab包加载资源。AssetBundleCache:缓存的ab包。</p>
<p>一、加载器实现</p>
<p>上篇我们有说到，unity有四种加载方式</p>
<p>1.AssetDatabase:在编辑器内加载卸载资源，并不能在游戏发布时使用，它只能在编辑器内使用。但是，它加载速度快，使用简单。</p>
<p>2.Resources：因为使用Resources文件夹无法热更，本片篇就不实现此途径了。</p>
<p>3.AssetBundle：支持热更，但是每次资源变化都得重新打ab包（奇慢），所以适合发布模式，但开发模式千万别用。</p>
<p>4.UnityWebRequest：从网络端下载</p>
<p>1.所有的加载器都继承自一个接口：Loader，该类定义了当前的加载类型、初始化、回收的重置方法、加载方法、加载进度回调等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">public class Loader</span><br><span class="line">&#123;</span><br><span class="line">    #region Define</span><br><span class="line">    public enum LoaderType</span><br><span class="line">    &#123;</span><br><span class="line">        STREAM,            &#x2F;&#x2F; 流(原则上可以是任何文件,包括远程服务器上的)</span><br><span class="line">        ASSET,            &#x2F;&#x2F; Asset目录下的资源</span><br><span class="line">        BUNDLE,            &#x2F;&#x2F; AssetBundle</span><br><span class="line">        BUNDLEASSET,    &#x2F;&#x2F; AssetBundle中的资源</span><br><span class="line">        SCENE,          &#x2F;&#x2F; 场景</span><br><span class="line">        Texture,        &#x2F;&#x2F; 图片</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum LoaderState</span><br><span class="line">    &#123;</span><br><span class="line">        NONE,            &#x2F;&#x2F; </span><br><span class="line">        LOADING,        &#x2F;&#x2F; 加载中</span><br><span class="line">        FINISHED,        &#x2F;&#x2F; 完成</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public delegate void ProgressHandle(Loader loader, float rate);</span><br><span class="line">    public delegate void LoadedHandle(Loader loader, object data);</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    protected Loader(LoaderType type)</span><br><span class="line">    &#123;</span><br><span class="line">        m_type &#x3D; type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected LoaderType m_type;            &#x2F;&#x2F; 加载器类型</span><br><span class="line">    protected LoaderState m_state;            &#x2F;&#x2F; 加载状态</span><br><span class="line">    protected string m_path;                &#x2F;&#x2F; 路径</span><br><span class="line">    protected bool m_async;                    &#x2F;&#x2F; 是否异步</span><br><span class="line"></span><br><span class="line">    protected ProgressHandle m_onProgress;    &#x2F;&#x2F; 加载进度</span><br><span class="line">    protected LoadedCallback m_onloaded;    &#x2F;&#x2F; 加载完成回调通知</span><br><span class="line"></span><br><span class="line">    protected System.Diagnostics.Stopwatch m_watch &#x3D; new System.Diagnostics.Stopwatch ();&#x2F;&#x2F;加载时间统计</span><br><span class="line"></span><br><span class="line">    public LoaderType Type &#123; get &#123; return m_type; &#125; &#125;</span><br><span class="line">    public string Path &#123; get &#123; return m_path; &#125; &#125;</span><br><span class="line">    public bool IsFinish &#123; get &#123; return m_state &#x3D;&#x3D; LoaderState.FINISHED; &#125; &#125;</span><br><span class="line">    public bool IsAsync &#123; get &#123; return m_async; &#125; &#125;</span><br><span class="line"></span><br><span class="line">　　&#x2F;&#x2F;主要用于ab包的判断，因为ab包需要等待依赖包的加载</span><br><span class="line">    public virtual bool IsPrepareToLoad()</span><br><span class="line">    &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化参数</span><br><span class="line">    public virtual void Init(string path, LoadedCallback onloaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        m_state &#x3D; LoaderState.NONE;</span><br><span class="line">        m_path &#x3D; path;</span><br><span class="line">        m_async &#x3D; async;</span><br><span class="line">        m_onloaded &#x3D; onloaded;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public virtual void Reset()</span><br><span class="line">    &#123;</span><br><span class="line">        m_path &#x3D; &quot;&quot;;</span><br><span class="line">        m_async &#x3D; true;</span><br><span class="line">        m_onloaded &#x3D; null;</span><br><span class="line">        m_state &#x3D; LoaderState.NONE;</span><br><span class="line">        m_onProgress &#x3D; null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Load()</span><br><span class="line">    &#123;</span><br><span class="line">        m_watch.Reset ();</span><br><span class="line">        m_watch.Start ();</span><br><span class="line">        m_state &#x3D; LoaderState.LOADING;</span><br><span class="line">        OnLoadProgress(0f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Stop()</span><br><span class="line">    &#123;</span><br><span class="line">        Reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public virtual void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected virtual void OnLoadProgress(float rate)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_onProgress !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_onProgress(this, rate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected virtual void OnLoadCompleted(object data)</span><br><span class="line">    &#123;</span><br><span class="line">        m_state &#x3D; LoaderState.FINISHED;</span><br><span class="line"></span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_onloaded!&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                m_onloaded (data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch(System.Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            LuaInterface.Debugger.LogError(e.Message);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        OnLoadProgress(1f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.editor模式下的加载，直接使用AssetDatabase加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public class AssetLoader : Loader</span><br><span class="line">&#123;</span><br><span class="line">    Object m_data &#x3D; null;</span><br><span class="line">    System.Type m_assetType &#x3D; null;        &#x2F;&#x2F;资源类型</span><br><span class="line"></span><br><span class="line">    public AssetLoader()</span><br><span class="line">        : base(Loader.LoaderType.ASSET)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Init (string path, System.Type type, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        base.Init (path, onLoaded, async);</span><br><span class="line">        m_assetType &#x3D; type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Load()</span><br><span class="line">    &#123;</span><br><span class="line">        base.Load();</span><br><span class="line"></span><br><span class="line">#if UNITY_EDITOR</span><br><span class="line">        if (m_assetType &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_assetType &#x3D; typeof(Object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_data &#x3D; UnityEditor.AssetDatabase.LoadAssetAtPath(m_path, m_assetType);</span><br><span class="line">        if (!m_async)</span><br><span class="line">        &#123;</span><br><span class="line">            OnLoadCompleted(m_data);</span><br><span class="line">        &#125;</span><br><span class="line">#else</span><br><span class="line">        if(!m_async)</span><br><span class="line">        &#123;</span><br><span class="line">            OnLoadCompleted(null);</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_state &#x3D;&#x3D; LoaderState.LOADING)</span><br><span class="line">        &#123;</span><br><span class="line">            OnLoadCompleted(m_data);</span><br><span class="line">            m_data &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.ab包的缓存可以参考我之前的文章：ab包的缓存</p>
<p>ab加载如下：当且仅当IsPrepareToLoad判断通过（即所有依赖包都加载完成）才能调用load方法，开始ab包的加载。InitDependencies方法用于初始化当前ab包的依赖项</p>
<p>load加载分两种，第一种是从扩展包加载，第二种是从本地加载。</p>
<p>ab包的加载无非就是同步和异步加载的区别，ab包的卸载也只需要调用Unload方法就好了。唯一需要注意的是，记载asset前必须保证ab的依赖包都加载完成了。</p>
<p>AssetBundleCache:缓存类，用于缓存ab包，提供从ab包加载asset的方法并缓存a包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line">public class AssetBundleCache</span><br><span class="line">&#123;</span><br><span class="line">    private string m_name;          &#x2F;&#x2F; AssetBundle name</span><br><span class="line">    private int m_referencedCount;  &#x2F;&#x2F; 引用计数</span><br><span class="line">    private float m_unloadTime;     &#x2F;&#x2F; 释放时间</span><br><span class="line"></span><br><span class="line">    private HashSet&lt;string&gt; m_setAllAssetNames &#x3D; null;&#x2F;&#x2F;ab包包含的所有asset的名字，用于判断指定asset是否存在于ab中</span><br><span class="line">    private Dictionary&lt;string, AssetBundleRequest&gt; m_dicAsync &#x3D; new Dictionary&lt;string, AssetBundleRequest&gt;();&#x2F;&#x2F;正在异步加载的asset</span><br><span class="line">    private Dictionary&lt;string, Object&gt; m_dicAssetCache &#x3D; null;&#x2F;&#x2F;已经加载完的asset</span><br><span class="line"></span><br><span class="line">    public AssetBundleCache(string name, AssetBundle ab, int refCount)</span><br><span class="line">    &#123;</span><br><span class="line">        m_name &#x3D; name;</span><br><span class="line">        Bundle &#x3D; ab;</span><br><span class="line">        ReferencedCount &#x3D; refCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; AssetBundle</span><br><span class="line">    public AssetBundle Bundle</span><br><span class="line">    &#123;</span><br><span class="line">        get;</span><br><span class="line">        private set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否常驻，通用资源的ab包不卸载</span><br><span class="line">    public bool Persistent</span><br><span class="line">    &#123;</span><br><span class="line">        get;</span><br><span class="line">        set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public string BundleName</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 引用计数</span><br><span class="line">    public int ReferencedCount</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_referencedCount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set</span><br><span class="line">        &#123;</span><br><span class="line">            m_referencedCount &#x3D; value;</span><br><span class="line">            if (m_referencedCount &lt;&#x3D; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                m_unloadTime &#x3D; Time.realtimeSinceStartup;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_unloadTime &#x3D; 0;</span><br><span class="line">            &#125;</span><br><span class="line">            if (m_referencedCount &lt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogWarningFormat(&quot;AssetBundleCache reference count &lt; 0, name:&#123;0&#125;, referencecount:&#123;1&#125;&quot;, m_name, m_referencedCount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否可以删除</span><br><span class="line">    public bool IsCanRemove</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; 常驻资源</span><br><span class="line">            if (Persistent) return false;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 非常驻，并且引用计数为0</span><br><span class="line">            if (!Persistent &amp;&amp; ReferencedCount &lt;&#x3D; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 缓存时间到</span><br><span class="line">    public bool IsTimeOut</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return Time.realtimeSinceStartup - m_unloadTime &gt;&#x3D; Config.Instance.AssetCacheTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 资源是否正在异步加载中</span><br><span class="line">    public bool IsAssetLoading(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        return m_dicAsync.ContainsKey(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;判断AB是否包含某个资源</span><br><span class="line">    public bool IsExistAsset(string strAssetName)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_setAllAssetNames !&#x3D; null &amp;&amp; m_setAllAssetNames.Contains(strAssetName))</span><br><span class="line">        &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 获取缓存中的资源</span><br><span class="line">    public Object GetCacheAsset(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_dicAssetCache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Object rst &#x3D; null;</span><br><span class="line">            if (m_dicAssetCache.TryGetValue(name, out rst))</span><br><span class="line">            &#123;</span><br><span class="line">                return rst;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 资源加载完 要缓存一下</span><br><span class="line">    public void OnLoadedAsset(string name, Object asset)</span><br><span class="line">    &#123;</span><br><span class="line">        m_unloadTime &#x3D; Time.realtimeSinceStartup;</span><br><span class="line"></span><br><span class="line">        if (m_dicAsync.ContainsKey(name))</span><br><span class="line">        &#123;</span><br><span class="line">            m_dicAsync.Remove(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 常驻ab加载进来的资源 用真实引用 不用弱引用</span><br><span class="line">        if (m_dicAssetCache &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_dicAssetCache &#x3D; new Dictionary&lt;string, Object&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        if (m_dicAssetCache.ContainsKey(name))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;警报! 缓存已经存在了还重新加载:&#123;0&#125;&quot;, name);</span><br><span class="line">        &#125;</span><br><span class="line">        m_dicAssetCache[name] &#x3D; asset;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;异步加载资源，需要添加到m_dicAsync里，防止重复加载</span><br><span class="line">    public AssetBundleRequest LoadAssetAsync(string name, System.Type type)</span><br><span class="line">    &#123;</span><br><span class="line">        if (Bundle &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;AssetBundle:&#123;0&#125; is null, load asset async:&#123;1&#125;,type:&#123;2&#125;, fail!!&quot;, m_name, name, type.ToString());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        AssetBundleRequest opt;</span><br><span class="line">        m_dicAsync.TryGetValue(name, out opt);</span><br><span class="line">        if (opt &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            opt &#x3D; Bundle.LoadAssetAsync(name, type);</span><br><span class="line">            m_dicAsync.Add(name, opt);</span><br><span class="line">        &#125;</span><br><span class="line">        return opt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;加载资源</span><br><span class="line">    public Object LoadAsset(string name, System.Type type)</span><br><span class="line">    &#123;</span><br><span class="line">        if (Bundle &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;AssetBundle:&#123;0&#125; is null, load asset:&#123;1&#125;,type:&#123;2&#125;, fail!!&quot;, m_name, name, type.ToString());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object asset &#x3D; Bundle.LoadAsset(name, type);</span><br><span class="line">        if (asset &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;AssetBuncleCache.LoadAsset, asset not exist:&#123;0&#125;, &#123;1&#125;&quot;, m_name, name);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            OnLoadedAsset(name, asset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return asset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;加载所有资源</span><br><span class="line">    public UnityEngine.Object[] LoadAllAssets(bool bCache &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        UnityEngine.Object[] allObjs &#x3D; Bundle.LoadAllAssets();</span><br><span class="line">        if (bCache)</span><br><span class="line">        &#123;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; allObjs.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Object obj &#x3D; allObjs[i];</span><br><span class="line">                OnLoadedAsset(obj.name, obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return allObjs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;异步加载所有资源 只用作预加载使用</span><br><span class="line">    public AssetBundleRequest LoadAllAssetsAsync()</span><br><span class="line">    &#123;</span><br><span class="line">        if (Bundle &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return Bundle.LoadAllAssetsAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool LoadAllAssetNames()</span><br><span class="line">    &#123;</span><br><span class="line">        if (Bundle &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        string[] arrNames &#x3D; Bundle.GetAllAssetNames();</span><br><span class="line">        if (arrNames.Length &#x3D;&#x3D; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        if (m_setAllAssetNames &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_setAllAssetNames &#x3D; new HashSet&lt;string&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (int i &#x3D; 0; i &lt; arrNames.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            string strName &#x3D; System.IO.Path.GetFileNameWithoutExtension(arrNames[i]);</span><br><span class="line">            m_setAllAssetNames.Add(strName);</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;卸载ab包</span><br><span class="line">    public void Unload()</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_dicAsync.Count &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;[仅提醒]该Bundle还有资源在加载中，暂时不卸载:&#123;0&#125;&quot;, m_name);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (Bundle !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            Bundle.Unload(false);</span><br><span class="line">            Bundle &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (m_setAllAssetNames !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_setAllAssetNames.Clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (m_dicAssetCache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_dicAssetCache.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ABCachePool：负责管理ab包的引用计数、缓存、获取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">public class ABCachePool</span><br><span class="line">&#123;</span><br><span class="line">    #region Instance</span><br><span class="line">    private static ABCachePool m_Instance;</span><br><span class="line">    public static ABCachePool Instance</span><br><span class="line">    &#123;</span><br><span class="line">        get &#123; return m_Instance ?? (m_Instance &#x3D; new ABCachePool()); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">    Dictionary&lt;string, AssetBundleCache&gt; m_AssetBundleCaches &#x3D; new Dictionary&lt;string, AssetBundleCache&gt;();  &#x2F;&#x2F; 缓存队列</span><br><span class="line">    HashSet&lt;string&gt; m_persistentABs &#x3D; new HashSet&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    public Dictionary&lt;string, AssetBundleCache&gt; AssetBundleCaches</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_AssetBundleCaches;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void ClearAllCache()</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (KeyValuePair&lt;string, AssetBundleCache&gt; keyval in m_AssetBundleCaches)</span><br><span class="line">        &#123;</span><br><span class="line">            keyval.Value.Unload();</span><br><span class="line">        &#125;</span><br><span class="line">        m_AssetBundleCaches.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsExistCache(string abName)</span><br><span class="line">    &#123;</span><br><span class="line">        return m_AssetBundleCaches.ContainsKey(abName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 引用这个bundle</span><br><span class="line">    public AssetBundleCache ReferenceCacheByName(string abName)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; null;</span><br><span class="line">        m_AssetBundleCaches.TryGetValue(abName, out cache);</span><br><span class="line">        if (cache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            ++cache.ReferencedCount;</span><br><span class="line">        &#125;</span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 获取ABCache 不增加引用</span><br><span class="line">    public AssetBundleCache GetABCacheByName(string abName)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; null;</span><br><span class="line">        m_AssetBundleCaches.TryGetValue(abName, out cache);</span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AssetBundleCache AddCache(string abName, AssetBundle bundle, int refCount)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_AssetBundleCaches.ContainsKey(abName))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarningFormat(&quot;AssetBundleCache already contains key:&#123;0&#125;, it will be cover by new value.&quot;, abName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AssetBundleCache cache &#x3D; new AssetBundleCache(abName, bundle, refCount);</span><br><span class="line">        m_AssetBundleCaches[abName] &#x3D; cache;</span><br><span class="line"></span><br><span class="line">        if (m_persistentABs.Contains(abName))</span><br><span class="line">        &#123;</span><br><span class="line">            cache.Persistent &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; immediate 只有场景是立刻卸载</span><br><span class="line">    public AssetBundleCache UnReferenceCache(string abName, bool immediate &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; null;</span><br><span class="line">        if (!m_AssetBundleCaches.TryGetValue(abName, out cache))</span><br><span class="line">        &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (cache.Persistent)</span><br><span class="line">        &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        --cache.ReferencedCount;</span><br><span class="line"></span><br><span class="line">        if (immediate &amp;&amp; cache.IsCanRemove)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveCache(abName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void RemoveCache(string abName)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; m_AssetBundleCaches[abName];</span><br><span class="line">        cache.Unload();</span><br><span class="line">        m_AssetBundleCaches.Remove(abName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private List&lt;string&gt; m_lstRm &#x3D; new List&lt;string&gt;();</span><br><span class="line">    &#x2F;&#x2F; 清除无引用的AssetBundle缓存</span><br><span class="line">    public void ClearNoneRefCache(bool mustTimeout)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (KeyValuePair&lt;string, AssetBundleCache&gt; keyval in m_AssetBundleCaches)</span><br><span class="line">        &#123;</span><br><span class="line">            AssetBundleCache item &#x3D; keyval.Value;</span><br><span class="line">            &#x2F;&#x2F; 只清除引用计数为0的</span><br><span class="line">            if (item.IsCanRemove &amp;&amp; (!mustTimeout || item.IsTimeOut))</span><br><span class="line">            &#123;</span><br><span class="line">                m_lstRm.Add(keyval.Key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_lstRm.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveCache(m_lstRm[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        m_lstRm.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 常驻ab包设置</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;arrAB&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    public void SetPersistentABs(string[] arrAB)</span><br><span class="line">    &#123;</span><br><span class="line">        m_persistentABs.Clear();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; arrAB.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            string strAB &#x3D; arrAB[i];&#x2F;&#x2F;FileHelper.GenBundlePath(arrAB[i]);</span><br><span class="line">            m_persistentABs.Add(strAB);</span><br><span class="line"></span><br><span class="line">            AssetBundleCache abCache;</span><br><span class="line">            m_AssetBundleCaches.TryGetValue(strAB, out abCache);</span><br><span class="line">            if (abCache !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                abCache.Persistent &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BundleLoader：用于加载AssetBundle</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">public class BundleLoader : Loader</span><br><span class="line">&#123;</span><br><span class="line">    AssetBundleCreateRequest m_abRequest &#x3D; null;</span><br><span class="line"></span><br><span class="line">    private int m_iRefCount;                &#x2F;&#x2F; 当前等待此加载的引用计数</span><br><span class="line">    private List&lt;string&gt; m_lstDepAbNames &#x3D; new List&lt;string&gt;();  &#x2F;&#x2F;依赖的未加载Bundle名字列表</span><br><span class="line"></span><br><span class="line">    private LoadedCallback m_onABLoaded;</span><br><span class="line"></span><br><span class="line">    private string m_strBundleName;         &#x2F;&#x2F; 相对路径</span><br><span class="line">    public string BundleName &#123; get &#123; return m_strBundleName; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    System.Diagnostics.Stopwatch m_saveAbWatcher &#x3D; new System.Diagnostics.Stopwatch();</span><br><span class="line">    public BundleLoader()</span><br><span class="line">        : base(Loader.LoaderType.BUNDLE)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void AddLoadedCallback(LoadedCallback onloaded)</span><br><span class="line">    &#123;</span><br><span class="line">        m_onABLoaded +&#x3D; onloaded;</span><br><span class="line">        m_iRefCount +&#x3D; 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void AddReferenced()</span><br><span class="line">    &#123;</span><br><span class="line">        m_iRefCount +&#x3D; 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Reset()</span><br><span class="line">    &#123;</span><br><span class="line">        base.Reset();</span><br><span class="line"></span><br><span class="line">        m_iRefCount &#x3D; 0;</span><br><span class="line">        m_lstDepAbNames.Clear();</span><br><span class="line">        m_strBundleName &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        m_abRequest &#x3D; null;</span><br><span class="line">        m_onABLoaded &#x3D; null;</span><br><span class="line">        m_lstDepAbNames.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 判断是否所有依赖都已经加载</span><br><span class="line">    public override bool IsPrepareToLoad()</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; m_lstDepAbNames.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            string strABName &#x3D; m_lstDepAbNames[i];</span><br><span class="line">            if (ABCachePool.Instance.IsExistCache(strABName))</span><br><span class="line">            &#123;</span><br><span class="line">                m_lstDepAbNames.RemoveAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return m_lstDepAbNames.Count &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Init(string path, string strName, string[] dependencies, LoadedCallback onloaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; Bundle 比较特殊 不使用父类的回调</span><br><span class="line">        base.Init(path, null, async);</span><br><span class="line"></span><br><span class="line">        m_iRefCount &#x3D; 1;</span><br><span class="line">        m_strBundleName &#x3D; strName;</span><br><span class="line">        m_onABLoaded &#x3D; onloaded;</span><br><span class="line">        InitDependencies(dependencies);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void InitDependencies(string[] dependencies)</span><br><span class="line">    &#123;</span><br><span class="line">        if (dependencies &#x3D;&#x3D; null || dependencies.Length &#x3D;&#x3D; 0)</span><br><span class="line">            return;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; dependencies.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            string strName &#x3D; dependencies[i];</span><br><span class="line">            if (!ABCachePool.Instance.IsExistCache(strName))</span><br><span class="line">            &#123;</span><br><span class="line">                m_lstDepAbNames.Add(strName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Load()</span><br><span class="line">    &#123;</span><br><span class="line">        base.Load();</span><br><span class="line"></span><br><span class="line">        if (m_async)</span><br><span class="line">        &#123;</span><br><span class="line">            string path &#x3D; FileHelper.GetAPKPath(m_path);&#x2F;&#x2F;根据ab包的名字索引ab包的存储路劲</span><br><span class="line">            m_abRequest &#x3D; AssetBundle.LoadFromFileAsync(path);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            AssetBundle ab &#x3D; null;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F; 同步使用AssetBundle.LoadFromFile加载,速度最快</span><br><span class="line">                if (ab &#x3D;&#x3D; null)</span><br><span class="line">                &#123;</span><br><span class="line">                    string path &#x3D; FileHelper.GetAPKPath(m_path);&#x2F;&#x2F;根据ab包的名字索引ab包的存储路劲</span><br><span class="line">                    ab &#x3D; AssetBundle.LoadFromFile(path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (System.Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(e.Message);</span><br><span class="line">            &#125;</span><br><span class="line">            finally</span><br><span class="line">            &#123;</span><br><span class="line">                OnLoaded(ab);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_state &#x3D;&#x3D; LoaderState.LOADING)</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_abRequest !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                if (m_abRequest.isDone)</span><br><span class="line">                &#123;</span><br><span class="line">                    OnLoaded(m_abRequest.assetBundle);</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    DoProgress(m_abRequest.progress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void DoProgress(float rate)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void OnLoaded(AssetBundle ab)</span><br><span class="line">    &#123;</span><br><span class="line">        AssetBundleCache cache &#x3D; ABCachePool.Instance.AddCache(m_strBundleName, ab, m_iRefCount);</span><br><span class="line">        OnLoadCompleted(ab);</span><br><span class="line"></span><br><span class="line">        if (m_onABLoaded !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            m_onABLoaded(cache);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>二、缓存池,缓存加载器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public class LoaderPool</span><br><span class="line">&#123;</span><br><span class="line">    #region Instance</span><br><span class="line">    private static LoaderPool m_Instance;</span><br><span class="line">    public static LoaderPool Instance</span><br><span class="line">    &#123;</span><br><span class="line">        get &#123; return m_Instance ?? (m_Instance &#x3D; new LoaderPool()); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    List&lt;Loader&gt; m_bundleLoaderPool &#x3D; new List&lt;Loader&gt;();       &#x2F;&#x2F; BundleLoader的缓存</span><br><span class="line">    List&lt;Loader&gt; m_assetLoaderPool &#x3D; new List&lt;Loader&gt;();        &#x2F;&#x2F; BundleAssetLoader的缓存</span><br><span class="line"></span><br><span class="line">    public T GetLoader&lt;T&gt;() where T : Loader, new()</span><br><span class="line">    &#123;</span><br><span class="line">        System.Type type &#x3D; typeof(T);</span><br><span class="line">        T loader &#x3D; null;</span><br><span class="line">        if (type &#x3D;&#x3D; typeof(BundleLoader))</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_bundleLoaderPool.Count &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                loader &#x3D; (T)m_bundleLoaderPool[0];</span><br><span class="line">                m_bundleLoaderPool.RemoveAt(0);</span><br><span class="line">                return loader;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(BundleAssetLoader))</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_assetLoaderPool.Count &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                loader &#x3D; (T)m_assetLoaderPool[0];</span><br><span class="line">                m_assetLoaderPool.RemoveAt(0);</span><br><span class="line">                return loader;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loader &#x3D; new T();</span><br><span class="line"></span><br><span class="line">        return loader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void RecycleLoader(Loader loader)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        if (loader.GetType() &#x3D;&#x3D; typeof(BundleLoader))</span><br><span class="line">        &#123;</span><br><span class="line">            loader.Reset();</span><br><span class="line">            m_bundleLoaderPool.Add(loader);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (loader.GetType() &#x3D;&#x3D; typeof(BundleAssetLoader))</span><br><span class="line">        &#123;</span><br><span class="line">            loader.Reset();</span><br><span class="line">            m_assetLoaderPool.Add(loader);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            loader.Reset();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三、加载管理器LoadModule</p>
<p>1.ResManager ：提供给业务的接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public class ResManager</span><br><span class="line">&#123;</span><br><span class="line">    #region Instance</span><br><span class="line">    private static ResManager m_Instance;</span><br><span class="line">    public static ResManager Instance</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return m_Instance ?? (m_Instance &#x3D; new ResManager());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">    public int SyncCount &#x3D; 6;                               &#x2F;&#x2F; 同步加载并发数</span><br><span class="line"></span><br><span class="line">    private bool m_isUseAssetBundle;</span><br><span class="line">    private ILoadModule m_loadModule;</span><br><span class="line"></span><br><span class="line">    public void Init(bool isUseAssetBundle)</span><br><span class="line">    &#123;</span><br><span class="line">        m_isUseAssetBundle &#x3D; isUseAssetBundle;</span><br><span class="line">        if (isUseAssetBundle)</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadModule &#x3D; new ABLoadModule();</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadModule &#x3D; new LoadModule();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_loadModule.Init(SyncCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void UnInit()</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.UnInit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.Update(dt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        ABCachePool.Instance.ClearNoneRefCache(false);</span><br><span class="line"></span><br><span class="line">        Resources.UnloadUnusedAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadPrefab(string strPath, string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.LoadPrefab(strPath, name, onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadMusic(string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.LoadMusic(name, onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadFont(string name, LoadedCallback onLoaded, bool async &#x3D; true, bool inBundle &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.LoadFont(name, onLoaded, async, inBundle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded)</span><br><span class="line">    &#123;</span><br><span class="line">        m_loadModule.LoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.两种加载器的接口类ILoadModule</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public interface ILoadModule</span><br><span class="line">&#123;</span><br><span class="line">    void Init(int syncCout);</span><br><span class="line"></span><br><span class="line">    void UnInit();</span><br><span class="line"></span><br><span class="line">    void Update(float dt);</span><br><span class="line"></span><br><span class="line">    void LoadPrefab(string strPath, string name, LoadedCallback onLoaded, bool async &#x3D; true);</span><br><span class="line"></span><br><span class="line">    void LoadMusic(string name, LoadedCallback onLoaded, bool async &#x3D; true);</span><br><span class="line"></span><br><span class="line">    void LoadFont(string name, LoadedCallback onLoaded, bool async &#x3D; true, bool inBundle &#x3D; false);</span><br><span class="line"></span><br><span class="line">    void LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.editor模式下的加载器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 不使用ab加载资源（Editor模式下）</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class LoadModule : ILoadModule</span><br><span class="line">&#123;</span><br><span class="line">    public int SyncCount;                               &#x2F;&#x2F; 同步加载并发数</span><br><span class="line">    public HashSet&lt;string&gt; m_loadedBundleNames &#x3D; new HashSet&lt;string&gt;();</span><br><span class="line">    &#x2F;&#x2F; 加载队列</span><br><span class="line">    List&lt;Loader&gt; m_loadings &#x3D; new List&lt;Loader&gt;();&#x2F;&#x2F;正在加载</span><br><span class="line">    List&lt;Loader&gt; m_loaderQueue &#x3D; new List&lt;Loader&gt;();&#x2F;&#x2F;等待加载</span><br><span class="line"></span><br><span class="line">    float m_lastClear &#x3D; 0;  &#x2F;&#x2F; 上一次清除时间</span><br><span class="line"></span><br><span class="line">    public void Init(int syncCout)</span><br><span class="line">    &#123;</span><br><span class="line">        SyncCount &#x3D; syncCout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void UnInit()</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_loadings.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadings[i].Stop();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_loadings.Clear();</span><br><span class="line">        m_loaderQueue.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private List&lt;int&gt; m_lstRmTemp &#x3D; new List&lt;int&gt;();</span><br><span class="line">    public void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; m_loadings.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            Loader loader &#x3D; m_loadings[i];</span><br><span class="line">            loader.Update(dt);</span><br><span class="line">            if (loader.IsFinish)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loadings.RemoveAt(i);</span><br><span class="line">                LoaderPool.Instance.RecycleLoader(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int remain &#x3D; Mathf.Min(SyncCount - m_loadings.Count, m_loaderQueue.Count);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_loaderQueue.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Loader loader &#x3D; m_loaderQueue[i];</span><br><span class="line">            m_loadings.Add(loader);</span><br><span class="line">            loader.Load();</span><br><span class="line">            loader.Update(dt);</span><br><span class="line">            m_lstRmTemp.Add(i);</span><br><span class="line">            if (m_lstRmTemp.Count &gt;&#x3D; remain)</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (m_lstRmTemp.Count &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            for (int i &#x3D; m_lstRmTemp.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.RemoveAt(m_lstRmTemp[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            m_lstRmTemp.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        Resources.UnloadUnusedAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadPrefab(string strPath, string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        LoadAssetByPath(strPath, name, typeof(GameObject), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadMusic(string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        string path &#x3D; string.Format(&quot;music&#x2F;&#123;0&#125;&quot;, name);</span><br><span class="line">        LoadAssetByPath(path, name, typeof(AudioClip), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadFont(string name, LoadedCallback onLoaded, bool async &#x3D; true, bool inBundle &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        string path &#x3D; string.Format(&quot;ui&#x2F;font&#x2F;&#123;0&#125;&quot;, name);</span><br><span class="line">        LoadAssetByPath(path, name, typeof(Font), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #region LoadScene</span><br><span class="line">    public void LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded)</span><br><span class="line">    &#123;</span><br><span class="line">        var activeSceneName &#x3D; SceneManager.GetActiveScene().name;</span><br><span class="line">        &#x2F;&#x2F; 如果当前场景是要加载的场景 直接返回</span><br><span class="line">        if (activeSceneName &#x3D;&#x3D; name)</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(null);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (isAdditive)</span><br><span class="line">        &#123;</span><br><span class="line">            __LoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#x2F;&#x2F;大场景先加载idle过渡</span><br><span class="line">        &#123;</span><br><span class="line">            __LoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void __LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        SceneLoader sLoader &#x3D; LoaderPool.Instance.GetLoader&lt;SceneLoader&gt;();</span><br><span class="line">        sLoader.Init(name, scenePath, isAdditive, onLoaded, async);</span><br><span class="line">        StartLoad(sLoader, true);</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;从Bundle中加载资源</span><br><span class="line">    public void LoadAssetByPath(string path, string name, System.Type type, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        path &#x3D; &quot;Assets&#x2F;Data&#x2F;&quot; + path;</span><br><span class="line">        if (Directory.Exists(path))</span><br><span class="line">        &#123;</span><br><span class="line">            path +&#x3D; &quot;&#x2F;&quot; + name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string suffix &#x3D; GetSuffixOfAsset(type);</span><br><span class="line">        string fullPath &#x3D; string.Format(&quot;&#123;0&#125;.&#123;1&#125;&quot;, path, suffix);</span><br><span class="line">        LoadAsset(fullPath, onLoaded, type, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 加载资源(Assets目录下,带后缀)</span><br><span class="line">    public void LoadAsset(string path, LoadedCallback onLoaded, System.Type type &#x3D; null, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!File.Exists(path))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogErrorFormat(&quot;Load Asset, Path:[&#123;0&#125;] not exist!  &quot;, path);</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(null);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AssetLoader aLoader &#x3D; LoaderPool.Instance.GetLoader&lt;AssetLoader&gt;();</span><br><span class="line">        aLoader.Init(path, type, onLoaded, async);</span><br><span class="line">        StartLoad(aLoader, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void StartLoad(Loader loader, bool async, bool toHead &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 异步加载或者加载还未准备好，则当做异步处理，外部控制是否加入队列开头</span><br><span class="line">        &#x2F;&#x2F; 同步加载，并且已经具备加载条件，则直接调用Load进行加载</span><br><span class="line">        if (async || !loader.IsPrepareToLoad())</span><br><span class="line">        &#123;</span><br><span class="line">            if (toHead)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.Insert(0, loader);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.Add(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadings.Add(loader);</span><br><span class="line">            loader.Load();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载关卡场景</span><br><span class="line">    public void UnloadLevelScene(string sceneName, bool immediate)</span><br><span class="line">    &#123;</span><br><span class="line">        SceneManager.UnloadSceneAsync(sceneName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void CallFunc_LoadedBack(LoadedCallback callback, object data)</span><br><span class="line">    &#123;</span><br><span class="line">        if (callback !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            callback(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private string GetSuffixOfAsset(System.Type type)</span><br><span class="line">    &#123;</span><br><span class="line">        if (type &#x3D;&#x3D; typeof(Font))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;ttf&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(AudioClip))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;ogg&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(GameObject))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;prefab&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(TextAsset))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;bytes&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (type &#x3D;&#x3D; typeof(Texture2D) || type &#x3D;&#x3D; typeof(Sprite))</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;png&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.ab包加载模块：和LoadModule 相比，1.ABLoadModule 需要在初始化前加载manifest文件。2.需要在加载资源前加载ab包以及a包的依赖包。3.需要提供卸载ab包的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 使用ab加载资源（Editor模式下、线上平台）</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class ABLoadModule : ILoadModule</span><br><span class="line">&#123;</span><br><span class="line">    public int SyncCount;                               &#x2F;&#x2F; 同步加载并发数</span><br><span class="line">    private AssetBundleManifest m_manifest &#x3D; null;</span><br><span class="line">    private HashSet&lt;string&gt; m_bundleNames &#x3D; new HashSet&lt;string&gt;();</span><br><span class="line">    &#x2F;&#x2F; 加载队列</span><br><span class="line">    List&lt;Loader&gt; m_loadings &#x3D; new List&lt;Loader&gt;();&#x2F;&#x2F;正在加载</span><br><span class="line">    List&lt;Loader&gt; m_loaderQueue &#x3D; new List&lt;Loader&gt;();&#x2F;&#x2F;等待加载</span><br><span class="line">    Dictionary&lt;string, AssetBundleLoader&gt; m_dicAllLoader &#x3D; new Dictionary&lt;string, AssetBundleLoader&gt;();</span><br><span class="line"></span><br><span class="line">    float m_lastClear &#x3D; 0;  &#x2F;&#x2F; 上一次清除时间</span><br><span class="line"></span><br><span class="line">    public void Init(int syncCout)</span><br><span class="line">    &#123;</span><br><span class="line">        SyncCount &#x3D; syncCout;</span><br><span class="line">        LoadManifest();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void UnInit()</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_loadings.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadings[i].Stop();</span><br><span class="line">        &#125;</span><br><span class="line">        m_loadings.Clear();</span><br><span class="line"></span><br><span class="line">        m_loaderQueue.Clear();</span><br><span class="line">        ABCachePool.Instance.ClearAllCache();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private List&lt;int&gt; m_lstRmTemp &#x3D; new List&lt;int&gt;();</span><br><span class="line">    public void Update(float dt)</span><br><span class="line">    &#123;</span><br><span class="line">        for (int i &#x3D; m_loadings.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            Loader loader &#x3D; m_loadings[i];</span><br><span class="line">            loader.Update(dt);</span><br><span class="line">            if (loader.IsFinish)</span><br><span class="line">            &#123;</span><br><span class="line">                if (loader.Type &#x3D;&#x3D; Loader.LoaderType.BUNDLE)</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetBundleLoader bLoader &#x3D; loader as AssetBundleLoader;</span><br><span class="line">                    if (m_dicAllLoader.ContainsKey(bLoader.BundleName))</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_dicAllLoader.Remove(bLoader.BundleName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                m_loadings.RemoveAt(i);</span><br><span class="line">                LoaderPool.Instance.RecycleLoader(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int remain &#x3D; Mathf.Min(SyncCount - m_loadings.Count, m_loaderQueue.Count) ;</span><br><span class="line"></span><br><span class="line">        for (int i &#x3D; 0; i &lt; m_loaderQueue.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Loader loader &#x3D; m_loaderQueue[i];</span><br><span class="line">            if (loader.Type &#x3D;&#x3D; Loader.LoaderType.BUNDLE)</span><br><span class="line">            &#123;</span><br><span class="line">                AssetBundleLoader bLoader &#x3D; loader as AssetBundleLoader;</span><br><span class="line">                if (!bLoader.IsPrepareToLoad())</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;   &#x2F;&#x2F;如果有依赖未加载完直接跳过</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (loader.Type &#x3D;&#x3D; Loader.LoaderType.BUNDLEASSET)</span><br><span class="line">            &#123;</span><br><span class="line">                BundleAssetLoader bLoader &#x3D; loader as BundleAssetLoader;</span><br><span class="line">                if (!bLoader.IsPrepareToLoad())</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;   &#x2F;&#x2F;Asset是否准备好加载</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            m_loadings.Add(loader);</span><br><span class="line">            loader.Load();</span><br><span class="line">            loader.Update(dt);</span><br><span class="line">            m_lstRmTemp.Add(i);</span><br><span class="line">            if (m_lstRmTemp.Count &gt;&#x3D; remain)</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (m_lstRmTemp.Count &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            for (int i &#x3D; m_lstRmTemp.Count - 1; i &gt;&#x3D; 0; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.RemoveAt(m_lstRmTemp[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            m_lstRmTemp.Clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UpdateAssetBundleCache();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 更新AssetBundle缓存(主要执行定时清理)</span><br><span class="line">    public void UpdateAssetBundleCache()</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 每5秒回收一次</span><br><span class="line">        if (Time.realtimeSinceStartup - m_lastClear &lt; 5)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_lastClear &#x3D; Time.realtimeSinceStartup;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;&#x2F; 检查无引用的AB节点</span><br><span class="line">        ABCachePool.Instance.ClearNoneRefCache(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        ABCachePool.Instance.ClearNoneRefCache(false);</span><br><span class="line"></span><br><span class="line">        Resources.UnloadUnusedAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #region LoadManifest</span><br><span class="line">    &#x2F;&#x2F; 加载资源清单</span><br><span class="line">    public void LoadManifest()</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_manifest !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            Object.DestroyImmediate(m_manifest, true);</span><br><span class="line">            m_manifest &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_bundleNames.Clear();</span><br><span class="line"></span><br><span class="line">        string manifestName &#x3D; FileHelper.MANIFEST_NAME;&#x2F;&#x2F;manifest文件名</span><br><span class="line">        string strFullPath &#x3D; FileHelper.SearchFilePath(manifestName);&#x2F;&#x2F;获取manifest路径</span><br><span class="line"></span><br><span class="line">        AssetBundleLoader bLoader &#x3D; LoaderPool.Instance.GetLoader&lt;AssetBundleLoader&gt;();</span><br><span class="line">        bLoader.Init(strFullPath, manifestName, null, delegate (object data) &#123;</span><br><span class="line">            AssetBundleCache ab &#x3D; data as AssetBundleCache;</span><br><span class="line">            if (ab !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                m_manifest &#x3D; (AssetBundleManifest)ab.LoadAsset(&quot;AssetBundleManifest&quot;, typeof(AssetBundleManifest));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ABCachePool.Instance.UnReferenceCache(manifestName, true);  &#x2F;&#x2F; 不走统一接口是因为manifest文件没有后缀</span><br><span class="line"></span><br><span class="line">            if (m_manifest !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                string[] bundles &#x3D; m_manifest.GetAllAssetBundles();</span><br><span class="line"></span><br><span class="line">                for (int i &#x3D; 0; i &lt; bundles.Length; ++i)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_bundleNames.Add(bundles[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, false);</span><br><span class="line">        bLoader.Load();</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    public void LoadPrefab(string strPath, string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        LoadAssetFromBundle(strPath, name, typeof(GameObject), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadMusic(string name, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        string path &#x3D; string.Format(&quot;music&#x2F;&#123;0&#125;&quot;, name);</span><br><span class="line">        LoadAssetFromBundle(path, name, typeof(AudioClip), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void LoadFont(string name, LoadedCallback onLoaded, bool async &#x3D; true, bool inBundle &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        string path &#x3D; string.Format(&quot;ui&#x2F;font&#x2F;&#123;0&#125;&quot;, name);</span><br><span class="line">        LoadAssetFromBundle(path, name, typeof(Font), onLoaded, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #region LoadScene</span><br><span class="line">    public void LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded)</span><br><span class="line">    &#123;</span><br><span class="line">        var activeSceneName &#x3D; SceneManager.GetActiveScene().name;</span><br><span class="line">        &#x2F;&#x2F; 如果当前场景是要加载的场景 直接返回</span><br><span class="line">        if (activeSceneName &#x3D;&#x3D; name)</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(null);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (isAdditive)</span><br><span class="line">        &#123;</span><br><span class="line">            RealLoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#x2F;&#x2F;大场景先加载idle过渡</span><br><span class="line">        &#123;</span><br><span class="line">            RealLoadScene(name, scenePath, isAdditive, onLoaded);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void RealLoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded)</span><br><span class="line">    &#123;</span><br><span class="line">        string abPath &#x3D; &quot;scenes&#x2F;&quot; + name;</span><br><span class="line">        LoadAssetBundle(abPath, delegate (object data) &#123;</span><br><span class="line">            if (data &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                CallFunc_LoadedBack(onLoaded, null);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            __LoadScene(name, scenePath, isAdditive, onLoaded);  &#x2F;&#x2F;场景的bundle在SceneLoader中自动卸载</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void __LoadScene(string name, string scenePath, bool isAdditive, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        SceneLoader sLoader &#x3D; LoaderPool.Instance.GetLoader&lt;SceneLoader&gt;();</span><br><span class="line">        sLoader.Init(name, scenePath, isAdditive, onLoaded, async);</span><br><span class="line">        StartLoad(sLoader, true);</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;从Bundle中加载资源</span><br><span class="line">    public void LoadAssetFromBundle(string path, string name, System.Type type, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        LoadAssetBundle(path, (data) &#x3D;&gt; &#123;</span><br><span class="line">            AssetBundleCache abCache &#x3D; data as AssetBundleCache;</span><br><span class="line">            if (abCache &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogWarningFormat(&quot;LoadAssetFromBundle, load ab fail:&#123;0&#125;&quot;, path);</span><br><span class="line">                CallFunc_LoadedBack(onLoaded, null);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 开启任务去做加载</span><br><span class="line">            BundleAssetLoader assetLoader &#x3D; LoaderPool.Instance.GetLoader&lt;BundleAssetLoader&gt;();</span><br><span class="line">            assetLoader.Init(abCache, name, type, onLoaded, async);</span><br><span class="line">            StartLoad(assetLoader, async);</span><br><span class="line">        &#125;, async);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 加载AssetBundle(先从persistentData读,没有找到则从streamingAssets读,带后缀)</span><br><span class="line">    public void LoadAssetBundle(string path, LoadedCallback onLoaded, bool async &#x3D; true)</span><br><span class="line">    &#123;</span><br><span class="line">        string name &#x3D; FileHelper.GenBundlePath(path);</span><br><span class="line">        if (!HasAssetBundle(name))</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(null);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 加载依赖</span><br><span class="line">        LoadDependencies(name, async);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 检查是否有缓存 有缓存说明依赖资源也是加载过了的</span><br><span class="line">        AssetBundleCache abCache &#x3D; ABCachePool.Instance.ReferenceCacheByName(name);</span><br><span class="line">        if (abCache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                onLoaded(abCache);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string fullpath &#x3D; FileHelper.SearchFilePath(name);</span><br><span class="line">        AssetBundleLoader bLoader &#x3D; null;</span><br><span class="line">        m_dicAllLoader.TryGetValue(name, out bLoader);</span><br><span class="line">        if (bLoader &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            string[] dependencies &#x3D; m_manifest.GetDirectDependencies(name);</span><br><span class="line"></span><br><span class="line">            bLoader &#x3D; LoaderPool.Instance.GetLoader&lt;AssetBundleLoader&gt;();</span><br><span class="line">            bLoader.Init(fullpath, name, dependencies, onLoaded, async);</span><br><span class="line">            m_dicAllLoader.Add(name, bLoader);</span><br><span class="line">            StartLoad(bLoader, async);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if (onLoaded !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                bLoader.AddLoadedCallback(onLoaded);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                bLoader.AddReferenced();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 依赖</span><br><span class="line">    &#x2F;&#x2F; 加载依赖</span><br><span class="line">    &#x2F;&#x2F;asyncInFact 实际加载方式，如果依赖bundle是异步加载并且正在加载中，那么整个bundle的加载方式变成异步加载</span><br><span class="line">    void LoadDependencies(string name, bool async)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_manifest &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] dependencies &#x3D; m_manifest.GetDirectDependencies(name);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; dependencies.Length; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            LoadAssetBundle(dependencies[i], null, async);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void StartLoad(Loader loader, bool async, bool toHead &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 异步加载或者加载还未准备好，则当做异步处理，外部控制是否加入队列开头</span><br><span class="line">        &#x2F;&#x2F; 同步加载，并且已经具备加载条件，则直接调用Load进行加载</span><br><span class="line">        if (async || !loader.IsPrepareToLoad())</span><br><span class="line">        &#123;</span><br><span class="line">            if (toHead)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.Insert(0, loader);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_loaderQueue.Add(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            m_loadings.Add(loader);</span><br><span class="line">            loader.Load();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool HasAssetBundle(string path)</span><br><span class="line">    &#123;</span><br><span class="line">        path &#x3D; path.Replace(&quot;&#x2F;&quot;, &quot;_&quot;).ToLower();</span><br><span class="line">        return m_bundleNames.Count &#x3D;&#x3D; 0 || m_bundleNames.Contains(path) || string.Equals(path, FileHelper.MANIFEST_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载关卡场景</span><br><span class="line">    public void UnloadLevelScene(string sceneName, bool immediate)</span><br><span class="line">    &#123;</span><br><span class="line">        SceneManager.UnloadSceneAsync(sceneName);</span><br><span class="line">        UnloadSceneAssetBundle(sceneName, immediate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载场景的AssetBundle</span><br><span class="line">    public void UnloadSceneAssetBundle(string sceneName, bool immediate)</span><br><span class="line">    &#123;</span><br><span class="line">        if (Config.Instance.UseAssetBundle)</span><br><span class="line">        &#123;</span><br><span class="line">            string strABPath &#x3D; &quot;scenes&#x2F;&quot; + sceneName;</span><br><span class="line">            UnloadAssetBundle(strABPath, immediate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载AssetBundle</span><br><span class="line">    public void UnloadAssetBundle(string path, bool immediate &#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        string name &#x3D; FileHelper.GenBundlePath(path);</span><br><span class="line">        AssetBundleCache cache &#x3D; ABCachePool.Instance.UnReferenceCache(name, immediate);</span><br><span class="line">        if (cache !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            UnloadDependencies(name, immediate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 卸载依赖</span><br><span class="line">    void UnloadDependencies(string name, bool immediate)</span><br><span class="line">    &#123;</span><br><span class="line">        if (m_manifest &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string[] dependencies &#x3D; m_manifest.GetDirectDependencies(name);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; dependencies.Length; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            UnloadAssetBundle(dependencies[i], immediate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void CallFunc_LoadedBack(LoadedCallback callback, object data)</span><br><span class="line">    &#123;</span><br><span class="line">        if (callback !&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            callback(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/05/2025-07-05/" data-id="cmcvdrdx0000iccz89xcs7zb2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity/" rel="tag">unity</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2025-07-04" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/07/04/2025-07-04/" class="article-date">
  <time datetime="2025-07-04T00:27:04.000Z" itemprop="datePublished">2025-07-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/07/04/2025-07-04/">框架之资源管理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这篇只涉及基础原理，下篇会讲如何实现一个简单的资源管理框架。</p>
<p>一、Assets和Objects</p>
<p>资源(Asset)是存储在Unity项目的 Assets 文件夹中的磁盘文件。有些资源的数据格式是Unity原生支持的，有些资源则需要转换为原生的数据格式后才能被使用。<br>对象(UnityEngine.Object)，代表序列化数据的集合，表示某个资源的具体实例。它可以是Unity使用的任何类型的资源，所有对象都是UnityEngine.Object基类的子类<br>一个资源可以包含多个对象（一对多）<br>二、文件GUID、fileID(本地ID)、InstanceID(实例ID)<br>Unity文件、文件引用、Meta详解:<a href="https://blog.uwa4d.com/archives/USparkle_inf_UnityEngine.html" target="_blank" rel="noopener">https://blog.uwa4d.com/archives/USparkle_inf_UnityEngine.html</a></p>
<p>meta文件：Unity在首次将Asset导入Unity时会生成meta文件，它与Asset存储在同一个目录中。该文件中记录了资源的GUID和fileID（本地ID），文件GUID(File GUID)标识了资源文件(Asset file)在哪个目标资源(target resource)文件里，fileID（本地ID）用于标识Asset中的每个子Object和组件。资源间的依赖关系通过GUID来确定；资源内部的依赖关系使用fileID来确定，每个fileID对应一组组件信息，该信息记录了其对应组件的类型及初始化信息。例如以下示例m_Script记录脚本的guid，其他参数为m_Script的类初始化时的参数</p>
<p>— !u!114 &amp;114826744576399670<br>MonoBehaviour:<br>  m_ObjectHideFlags: 1<br>  m_PrefabParentObject: {fileID: 0}<br>  m_PrefabInternal: {fileID: 100100000}<br>  m_GameObject: {fileID: 1151505213129540}<br>  m_Enabled: 1<br>  m_EditorHideFlags: 0<br>  m_Script: {fileID: 11500000, guid: 48fb9c66a154844a495af53fc97a7656, type: 3}<br>  m_Name:<br>  m_EditorClassIdentifier:<br>  m_Material: {fileID: 0}<br>  m_Color: {r: 1, g: 1, b: 1, a: 1}<br>  m_RaycastTarget: 0<br>  m_OnCullStateChanged:<br>    m_PersistentCalls:<br>      m_Calls: []<br>    m_TypeName: UnityEngine.UI.MaskableGraphic+CullStateChangedEvent, UnityEngine.UI,<br>      Version=1.0.0.0, Culture=neutral, PublicKeyToken=null<br>  m_Sprite: {fileID: 21300000, guid: 5c7a7d69156d06448833b25308c032cf, type: 3}<br>  m_Type: 0<br>  m_PreserveAspect: 0<br>  m_FillCenter: 1<br>  m_FillMethod: 4<br>  m_FillAmount: 1<br>  m_FillClockwise: 1<br>  m_FillOrigin: 0<br>  m_SpriteName:<br>  m_isNativeSize: 0<br>  m_isGradualMat: 0<br>除了GUID，meta文件还存储了有关资源导入的信息。例如，贴图资源在导入时可以当作标准贴图、法线贴图、GUI贴图、cookie或者光线贴图。这些导入设置都会被存储在meta文件里。</p>
<p>我们以预制体Close作为示例，它包含一个Image的图片子节点，一个BtnClose的按钮节点</p>
<p>.meta文件大概是这样子的：guid是指Asset的id,这个id是唯一的，通过Library\metadata下保存的导入信息可以索引到Asset路径<br>fileFormatVersion: 2<br>guid: 9070bffdf4e7444e190533a128133eb4<br>timeCreated: 1519804963<br>licenseType: Pro<br>NativeFormatImporter:<br>  mainObjectFileID: 100100000<br>  userData:<br>  assetBundleName:<br>  assetBundleVariant:<br>　Library\metadata下的文件和Close.Prefabs大概是这样子的：</p>
<p>如上，Close预制体包含了三个GameObject（Close、Image、BtnClose），在文件导入的时候，unity为每个文件生成一个导出配置，该配置存储在项目的Library\metadata\xx文件夹里，其中xx为.meta记录的guid的前两位，例如70a2579b07749524b8c15f66a4c7216f，对应的xx为70，这个配置保存了GUID和path的对应关系，该ath会指向你的资源目录，只要GUID没变，unity就能索引到资源的目录。该配置还保存了预制体内三个对象的fileID（本地ID）,他与上图右侧的Close.Prefabs文件记录的GameObject是一致的。</p>
<p>我们再来看看Close.Prefabs这个文件，每一个Unity对象都会有一个FileID，然后在需要引用时，使用这些FileID即可。</p>
<p>以Image对象为例子。Image对象拥有三个组件，RectTransform、CanvasRenderer、MonoBehaviour（对应的ImageEx组件，该组件继承自Image），你可以在unity里查看对象的fileID</p>
<p>每一个组件的数据基本上就是这个组件的一堆参数了。那怎么区分这个组件是什么类型的呢？MonoBehaviour的类型参考<a href="https://docs.unity3d.com/Manual/ClassIDReference.html" target="_blank" rel="noopener">https://docs.unity3d.com/Manual/ClassIDReference.html</a> YAML数据，例如— !u!222 &amp;222167935205389516的222对应的是CanvasRenderer这个组件，用户自定义的组件通过m_Script参数的guid定位到对应的c#文件目录，就能识别出这个具体是什么类了</p>
<p>如下，114826744576399670（ImageEx）的组件信息里记录了ImageEx文件的guid，以及ImageEx的初始化信息，实例化这个对象时，unity通过这guid找到imageEx这个类的文件并实例化，再将初始化参数赋值给实例化的对象</p>
<p>所以在实例化一个GameObject时，只要依照次序，依次创建物体，组件，初始化数据并进行引用绑定即可在场景中生成一个实例。</p>
<p>InstanceID：Unity为了在运行时，提升资源管理的效率，会在内部维护一个缓存表，负责将文件的GUID与fileID转换成为整数数值，这个数值在本次会话中是唯一的，称作实例ID(InstanceID)。<br>程序启动时，实例ID缓存与所有工程内建的对象(例如在场景中被引用)，以及Resource文件夹下的所有对象，都会被一起初始化。如果在运行时导入了新的资源，或从AssetBundle中载入了新的对象，缓存会被更新，并为这些对象添加相应条目。实例ID仅在失效时才会被从缓存中移除，当提供了指定文件GUID和fileID的AssetBundle被卸载时会产生移除操作。<br>卸载AssetBundle会使实例ID失效，实例ID与其文件GUID和fileID之间的映射会被删除以便节省内存。重新载入AssetBundle后，载入的每个对象都会获得新的实例ID。<br>三、资源生命周期</p>
<p>加载方式：被动加载和显示加载</p>
<p>Object会在下列时刻被自动加载：<br>1.映射到该Object的Instance ID被反向引用（Dereference）<br>2.Object当前没有被加载到内存中<br>3.Object的源数据可以被定位</p>
<p>例如A对象引用了B对象，当加载A对象时，如果B对象未被加载且B对象资源存在，那么B会被加载</p>
<p>显示加载：在脚本中通过创建或者调用资源加载API（例如AssetBundle.LoadAsset）显式地加载Object</p>
<p>Object会在下列3中情况下被卸载：</p>
<p>1.在无用的Asset被清理时会自动卸载Object。该过程在Scene被破坏性地改变时自动发生（例如，通过SceneManager.LoadScene非增量地加载Scene），或者在脚本调用Resources.UnloadUnusedAssets时被触发。这一过程仅卸载那些没有被引用地Object —— 一个Object只会在没有任何Mono变量或其他的活动Object持有对它的引用的时候才能被卸载。</p>
<p>2.通过调用Resources.UnloadAsset精确地卸载Resources文件夹中的Object。这些Object的Instance ID仍然是有效的，并且含有有效的File GUID和Local ID条目。如果任何Mono变量或者Object持有对这类被卸载的Object的引用，那么在任意引用被反向引用时，这个被卸载的Object都会被立刻重新加载。</p>
<p>3.来自AssetBundle的Object会在调用AssetBundle.Unload(true)时立即被自动卸载。这会使Object的Instance ID的File GUID和Local ID失效，并且所有对已卸载的Object的活动引用都会变为“(Missing)”引用。在C#脚本中，尝试访问已卸载Object的方法或属性将会引发 NullReferenceException。</p>
<p>四、加载耗时</p>
<p>当序列化Unity GameObject的层级结构时，例如序列化预制体，整个层级结构都会被完全序列化。也就是说，这个层级结构中的每个GameObject和Component都会被单独地序列化到数据中。</p>
<p>当创建GameObject层级结构时，会有几种不同的耗费CPU时间的形式：</p>
<p>　　1.读取源数据（从存储设备、AssetBundle、其他GameObject等）</p>
<p>　　2.在新的Transform之间设置父子关系</p>
<p>　　3.实例化新的GameObject和Component</p>
<p>　　4.在主线程中唤醒新的GameObject和Component</p>
<p>后三个时间消耗通常是不变的，无论层级结构是从已有的层级结构克隆的还是从存储设备中加载的。然而，读取源数据消耗的时间会随着序列化的层级结构中的GameObject和Component的数量线性增长，而且受到读取速度的影响。</p>
<p>在现有的所有平台上，从内存中读取数据都比从存储设备中读取数据快很多。另外，在不同平台上的不同存储媒介上性能特征差异很大。因此，在低速存储设备上加载预制体时，读取预制体的序列化数据消耗的时间很容易超过实例化预制体所花费的时间。也就是说，加载操作的开销受到了存储设备I/O时间的限制。</p>
<p>前面提到过，在序列化整个预制体时，其中的每个GameObject和Component的数据都会被单独地序列化，这里面可能含有重复的数据。例如，一个UI屏幕上由30个相同的元素，这些元素就会被序列化30次，产生一大团二进制数据。在加载时，这30个相同的元素上的每个GameObject和Component的数据都要全部从磁盘读取出来，然后才能转换成新的Object实例。实例化预制体的整体开销中，文件读取时间占了占了很大比重。对于大型的层级结构，应该将其分模块进行实例化，然后再在运行时将他们整合到一起。</p>
<p>那么建议就是：将预制体中拥有相同结构的对象单独拎出来做成预制体，采用动态加载的方式加载，例如滑动列表的单Item。</p>
<p>五、资源加载方式对比</p>
<p>1.AssetDatabase:在编辑器内加载卸载资源，并不能在游戏发布时使用，它只能在编辑器内使用。但是，它加载速度快，使用简单。</p>
<p>2.Resources：该文件夹下的资源都会被打进最后的安装包里，类似缺省打进程序包里的AssetBundle。不建议使用该文件夹，因为：</p>
<p>不正确地使用Resources文件夹会导致应用启动时间变长，同时会增大构建出来的应用程序（该文件夹下的文件，不论是否有引用都会打进最终的包里）。随着Resources文件夹的增加，管理工程各处Resources文件夹里的资源也变得很困难。</p>
<p>使用Resources文件夹导致细粒度的内存管理愈发地困难。</p>
<p>使用Resources文件夹无法热更，就这一项就够了～。</p>
<p>在工程构建的时候，所有名字为”Resources”的目录下的所有资源都会被合并为一个序列化文件。像AssetBundle文件一样，这个文件同时也包含了元数据(metadata)和索引信息(indexing information)。索引信息包含了一个序列化的、将对象的名称映射为 文件GUID+本地ID 查找树(lookup tree)。同时这个索引信息也包含了对象在序列化文件中的偏移位置信息。</p>
<p>因为这个查找树的数据结构是（在大部分平台上）一个平衡搜索树(balanced search tree)[注1].它的构建时间复杂度是 O(N log(N))，这里的 N 是树中对象的数量。随着Resources文件夹下资源的增长，索引信息的加载时间也会超过线性的速度增长。</p>
<p>这个操作是发生在应用启动的过程中的Unity闪屏(splash screen)出现的时候，并且是不可跳过的。如果Resources 系统包含了 10000 个资源，那么在低端移动设备上面这个过程将会达到数秒之久，尽管绝大部分的Resources下面的资源在第一个场景当中都是不需要加载的。</p>
<p>3.AssetBundle：支持热更，但是每次资源变化都得重新打ab包（奇慢），所以适合发布模式，但开发模式千万别用。</p>
<p>4.UnityWebRequest：从网络端下载</p>
<p>UnityWebRequest功能分三块：</p>
<p>　　◾上传文件到服务器</p>
<p>　　◾从服务器下载</p>
<p>　　◾http通信控，(例如，重定向和错误处理)</p>
<p>UnityWebRequest  由三个元素组成。</p>
<p>　　◾UploadHandler  将数据发送到服务器的对象</p>
<p>　　◾DownloadHandler   从服务器接收数据的对象</p>
<p>　　◾UnityWebRequest     负责 HTTP 通信流量控制并管理上面两个对象的对象。也是存储错误和重定向信息的地方。</p>
<p>使用：</p>
<p>public class Example : MonoBehaviour<br>{<br>    void Start()<br>    {<br>        // A correct website page.<br>        StartCoroutine(GetRequest(“<a href="https://www.example.com&quot;" target="_blank" rel="noopener">https://www.example.com&quot;</a>));</p>
<pre><code>    // A non-existing page.
    StartCoroutine(GetRequest(&quot;https://error.html&quot;));
}

IEnumerator GetRequest(string uri)
{
    using (UnityWebRequest webRequest = UnityWebRequest.Get(uri))
    {
        // Request and wait for the desired page.
        yield return webRequest.SendWebRequest();

        string[] pages = uri.Split(&apos;/&apos;);
        int page = pages.Length - 1;

        if (webRequest.isNetworkError)
        {
            Debug.Log(pages[page] + &quot;: Error: &quot; + webRequest.error);
        }
        else
        {
            Debug.Log(pages[page] + &quot;:\nReceived: &quot; + webRequest.downloadHandler.text);
        }
    }
}</code></pre><p>}</p>
<p>六、资源管理</p>
<p>资源管理分三部分：</p>
<p>1.项目内文件的放置规范：合理的划分目录才能合理的使用AssetBundle。一般来说，除了场景和模型，其他资源都是一个目录一个ab包，当然这个目录的细分程度视项目而定，但是更新频繁的对象如预制体，建议细分程度高一点即目录文件小一点。如果目录划分混乱，会导致ab包的效率低下（试想英雄模块和副本模块的资源放在一个目录下并打进ab包里，那么加载英雄界面时会把副本也加载进来，这是即浪费内存又影响加载效率的事）</p>
<p>　　1-1.Assets目录中的所有资源文件名均采用大驼峰式命名法 ，即每一个单词的首字母都大写。且使用能够描述其功能或意义的英文单词或词组。</p>
<p>　　1-2.Assets目录中不得出现压缩包、PPT、Word文档等与游戏项目无关的资源文件</p>
<p>　　1-3.相同类型的资源放在同一个目录下，例如ui资源和场景、模型分开放置，一般会有场景、UI（界面预制体、图集）、模型、音效、脚本、特效、Shader等</p>
<p>　　1-4.相同功能的资源放在同一个目录下，例如英雄相关功能可能会有十几个界面的预制体，把这些预制体放在同一个文件夹。</p>
<p>　　1-5.所有插件放在Plugin下。所有的Editor文件放在同一个目录下</p>
<p>　　1-6.Resources谨慎放置资源，因为该文件夹下的资源都会打进包里，不管是否有用到</p>
<p>　　1-7.一个图集一个目录</p>
<p>2.包体大小的控制</p>
<p>　　2-1.删除无用资源。那么如何确定一个资源是否有被引用到呢？</p>
<p>　　首先我们需要使用AssetDatabase.FindAssets接口获取到需要查找依赖的对象，例如我们想知道文件夹“xxx”下是否有文件引用资源a，那么xxx目录下的对象就是我们需要查找依赖的对象。如下的参数searchInFolders</p>
<p>　　我们需要查找依赖的类型，例如sprite是不可能依赖sprite的，那么在查找某sprite是否有被引用（依赖）时，我们在需要查找依赖的对象里可以剔除掉sprite类型。如下的参数filter</p>
<p>　　</p>
<p> 　　获取到了需要查找引用的对象后，使用AssetDatabase.GetDependencies可以获取到这些对象引用到的资源的路径，把这些路径比对你想查找的资源A的路径，如果有相等的，说明A就有被引用，就不能被删除。</p>
<p>　　</p>
<p> 　　终于的实现如下</p>
<p>/// <summary><br>    /// 查找资源依赖<br>    /// </summary><br>    /// <param name="filter"></param> 搜索条件 如”index l:ui t:texture2D” l开头为标签，t开头为类型，以空格隔开，””空字符串查找整个Asset目录<br>    /// <param name="searchInFolders"></param> 要查找的目录<br>    /// <param name="targetPath"></param> 要查找引用的资源，例如Assets/Test/index.png<br>    void FindDependcy(string targetPath, string filter = “”,  string searchInFolders = “”) {<br>        string[] searchObjs;</p>
<pre><code>    if (!string.IsNullOrEmpty(searchInFolders))
    {
        string[] folders = m_TargetPath.Split(&apos;,&apos;);
        searchObjs = AssetDatabase.FindAssets(filter, folders);//获取需要查找引用的对象
    }
    else
    {
        searchObjs = AssetDatabase.FindAssets(filter);//获取需要查找引用的对象
    }

    List&lt;string&gt; resultList = new List&lt;string&gt;();
    for (var i = 0; i &lt; searchObjs.Length; i++)
    {
        var guid = searchObjs[i];
        string assetPath = AssetDatabase.GUIDToAssetPath(guid);
        string[] dependencies = AssetDatabase.GetDependencies(assetPath, m_Recursive);//获取文件依赖项

        foreach (string depend in dependencies)
        {
            if (targetPath == depend)
            {
                //查找到依赖资源targetPath的对象
                resultList.Add(assetPath);
            }
        }
    }

    if (resultList.Count == 0) {
        Debug.Log(string.Format(&quot;资源{0}没有被引用,可以删除&quot;, targetPath));
    }
}　　</code></pre><p>　　2-2.压缩资源包：</p>
<p>　　AssetBundle自带压缩模式，但是lzma使用时需要整包解压缩，所以我当前项目采用的是AssetBundle采用lz4压缩，在对所有的ab包进行lzma压缩，也就是压缩了两层。</p>
<p>　　2-3.上传部分高清资源：有部分资源需要某特定的模块才会用到，那么这部分比较大的文件可以上传到服务器按需下载。例如商城的资源一般引用高清资源，但用户初次进游戏的时候并不会使用到（有些用户甚至很长一段时间都不会打开这些界面）,unity 上传资源到服务器参考UnityWebRequest接口</p>
<p>3.内存的控制，内存占用太高会导致程序崩溃，频繁加载、卸载又会引起卡顿。在内存占用和加载之间取一个平衡点（卸载无用资源）</p>
<p>　　</p>
<p>　　3-1.unity的内存占用如上图所示。CreateFromFile已经被LoadFromMemory替代了。　　</p>
<p>　　Assets加载:用AssetBundle.Load(同Resources.Load) 这才会从AssetBundle的内存镜像里读取并创建一个Asset对象，创建Asset对象同时也会分配相应内存用于存放(反序列化)，异步读取用AssetBundle.LoadAsync。</p>
<p>　　AssetBundle的释放：<br>　　AssetBundle.Unload(flase)是释放AssetBundle文件的内存镜像，不包含Load创建的Asset内存对象。当AssetBundle被再次加载时并不会恢复引用，而是会重新创建引用，容易造成资源冗余。<br>　　AssetBundle.Unload(true)是释放那个AssetBundle文件内存镜像和并销毁所有用Load创建的Asset内存对象。</p>
<p>　　Destroy: 主要用于销毁克隆对象，也可以用于场景内的静态物体，不会自动释放该对象的所有引用。虽然也可以用于Asset,但是概念不一样要小心，如果用于销毁从文 件加载的Asset对象会销毁相应的资源文件！但是如果销毁的Asset是Copy的或者用脚本动态生成的，只会销毁内存对象。</p>
<p>　　一个Prefab从assetBundle里Load出来 里面可能包括：Gameobject transform mesh texture material shader script和各种其他Assets。<br>　　Instaniate一个Prefab，是一个对Assets进行Clone(复制)+引用结合的过程，GameObject transform 是Clone是新生成的。其他mesh / texture / material / shader 等，这其中有些是纯引用的关系的，包括：Texture和TerrainData，还有引用和复制同时存在的，包括：Mesh/material /PhysicMaterial。引用的Asset对象不会被复制，只是一个简单的指针指向已经Load的Asset对象。</p>
<p>　　再次Instaniate一个同样的Prefab,还是这套mesh/texture/material/shader…，这时候会有新的GameObject等，但是不会创建新的引用对象比如Texture.<br>　　所以你Load出来的Assets其实就是个数据源，用于生成新对象或者被引用，生成的过程可能是复制（clone)也可能是引用（指针）<br>　　当你Destroy一个实例时，只是释放那些Clone对象，并不会释放引用对象和Clone的数据源对象，Destroy并不知道是否还有别的object在引用那些对象。<br>　　等到没有任何游戏场景物体在用这些Assets以后，这些assets就成了没有引用的游离数据块了，是UnusedAssets了，这时候就可以通过 Resources.UnloadUnusedAssets来释放,Destroy不能完成这个任 务</p>
<p>　　3-2.资源泄漏、冗余</p>
<p>　　资源泄漏是内存泄露的主要表现形式，其具体原因是用户对加载后的资源进行了储存（比如放到Container中、在脚本中引用），但在场景切换时并没有将其Remove或Clear，从而无论是引擎本身还是手动调用Resources.UnloadUnusedAssets等相关API均无法对其进行卸载，进而造成了资源泄露。只有那些真正没有任何引用指向的资源会被回收，因此请确保在资源不再使用时，将所有对该资源的引用设置为null或者Destroy。</p>
<p>　　当你得到一个类型为“GameObject”的c#对象时，它几乎什么都不包含。这是因为Unity是一个C/ c++引擎。这个GameObject(游戏对象)包含的所有实际信息(它的名称、它拥有的组件列表、它的HideFlags等等)都位于c++端。c#对象只有一个指向本机对象的指针”。也就是说一个对象包含两部分，c++端的实际信息，当你加载一个新场景或者调用object.destroy (myObject)时，这些对象会被销毁。c#端指向c++端的指针， c#对象的生命周期通过垃圾收集器以c#方式进行管理。这意味着可能存在一个c#对象指针指向一个已经被销毁的c++对象。如果您将这个对象与null进行比较将返回“true”，从而就会出现对象的Null判断为true，但实际上还是被引用着，无法被GC释放的问题。</p>
<p>　　举个例子，在名为A的MonoBehaviour中，有个数组来存放名为B的 MonoBehaviour对象的引用。当我们其他的逻辑去Destroy了B对象所在的GameObject后，在A对象中的数组里，遍历打印，它们（B的引用）都为Null，在Inspector面板上看是missing。而这时候进行GC，堆内存其实并未释放这些B对象。只有当A对象中的数组被清空后，再调用GC，才可释放这些对象所占内存。</p>
<p>　　所谓“资源冗余”，是指在某一时刻内存中存在两份甚至多份同样的资源。导致这种情况的出现主要有两种原因：</p>
<p>　　一、AssetBundle打包机制出现问题，同一份资源被打入到多份AssetBundle文件中。例如bundle1和bundle2同时引用了不再任意ab包里的资源材质A，那么bundle1和bundle2都会包含一份材质A的拷贝。当这些AssetBundle先后被加载到内存后，内存中即会出现纹理资源冗余的情况。</p>
<p>　　二、资源的实例化所致，在Unity引擎中，当我们修改了一些特定GameObject的资源属性时，引擎会为该GameObject自动实例化一份资源供其使用，比如Material、Mesh等。</p>
<p>　　3-3.内存分类</p>
<p>　　程序代码包括了所有的Unity引擎，使用的库，以及你所写的所有的游戏代码。想要减少这部分内存的使用，能做的就是减少使用的库　　</p>
<p>　　托管堆(Managed Heap)是被Mono使用的一部分内存。Mono的堆内存一旦分配，就不会返还给系统。这意味着Mono的堆内存是只升不降的。尽量避免托管堆出现峰值　　</p>
<p>　　堆内存的碎片化：回收的堆内存不会和其他未分配的内存合并，它的两边的内存可能仍然在使用，意味着内存中的对象不会被重新定位，去缩小对象之间的内存空隙。例如A,B,C,D四块连续内存，B被回收后，原先B所在的内存只能存放大小小于或者等于B内存（如下图），如果B足够小，那B就是一个无法重复利用的碎片。尽管堆中可用的空间总量可能是巨大的，但有可能很多或者所有的空间都位于已经分配对象之间的小“间隙”中。在这种情况下，尽管总共有足够大的空间来分配，但托管堆找不到足够大的连续空间来分配内存。在下次内存分配的时候就不能找到合适大小的存储单元，这样就会触发GC操作或者堆内存扩展操作。堆内存碎片会造成两个结果，一个是游戏占用的内存会越来越大</p>
<p>　　</p>
<p>　　本机堆(Native Heap)是Unity引擎进行申请和操作的地方，比如贴图，音效，关卡数据等。</p>
<p>　　3-4.对象池。就是将对象存储在一个池子中，当需要时再次使用，而不是每次都实例化一个新的对象。它其实是用内存换加载效率，所以对象池也不能无限地存储对象，避免占用太多的内存，只保存一些需要频繁加载、卸载的对象，例如子弹、通用道具item等。</p>
<p>　　在unity里频繁地创建和销毁对象效率很低，也会造成频繁的资源回收（GC）。</p>
<p>　　最简单例子如下，使用一个数组（list\queue都可以）去存储子弹，但你需要使用子弹时，调用GetObject方法获取，如果池子里有，直接返回，如果池子里并不存在，会实例化一个子弹。当你使用完毕后，调用Recyle回收就好了，业务不需要关心子弹的创建、销毁、缓存。</p>
<p>using UnityEngine;<br>using System.Collections;<br>using System.Collections.Generic;<br>public class BufferPool<br>{<br>    private Queue<GameObject> pool;<br>    private GameObject prefab;<br>    private Transform prefabParent;</p>
<pre><code>//使用构造函数构造对象池
public BufferPool(GameObject obj,Transform parent,int count)
{
    prefab = obj;

    pool = new Queue&lt;GameObject&gt;(count);
    prefabParent = parent;

    for (int i = 0; i &lt; count; i++)
    {
        GameObject objClone = GameObject.Instantiate(prefab) as GameObject;
        objClone.transform.parent = prefabParent;//为克隆出来的子弹指定父物体
        objClone.name = &quot;Clone0&quot; + i.ToString();
        objClone.SetActive(false);
        pool.Enqueue(objClone); 
    }
}


public GameObject GetObject()
{
    GameObject obj = null;

    if (pool.Count &gt; 0)
    {
        obj = pool.Dequeue();  //Dequeue()方法 移除并返回位于 Queue 开始处的对象
        obj.transform.position = prefabParent.position;
    }
    else
    {
        obj = GameObject.Instantiate(prefab) as GameObject;
        obj.transform.SetParent(prefabParent);

    }

    obj.SetActive(true);
    return obj;
}

//回收对象
public void Recycle(GameObject obj)
{
    obj.SetActive(false);
    pool.Enqueue(obj);//加入队列
}</code></pre><p>}
　　</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://droidman.net/2025/07/04/2025-07-04/" data-id="cmcvdrdwz000hccz8gifldteu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity/" rel="tag">unity</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/" rel="tag">AOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Assetbundle/" rel="tag">Assetbundle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IOC/" rel="tag">IOC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Particle-System/" rel="tag">Particle System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shader/" rel="tag">Shader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Slot-%E8%80%81%E8%99%8E%E6%9C%BA%EF%BC%8C%E6%B8%B8%E6%88%8F%E7%A0%94%E7%A9%B6/" rel="tag">Slot, 老虎机，游戏研究</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UGUI/" rel="tag">UGUI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/" rel="tag">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity-C/" rel="tag">Unity, C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity-UI%E6%A1%86%E6%9E%B6-UGUI/" rel="tag">Unity, UI框架, UGUI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity%EF%BC%8CAssetBundle/" rel="tag">Unity，AssetBundle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/game/" rel="tag">game</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gameframework/" rel="tag">gameframework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http-server/" rel="tag">http.server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/keyboard/" rel="tag">keyboard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/slot-%E8%80%81%E8%99%8E%E6%9C%BA-slot-game/" rel="tag">slot, 老虎机, slot game</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unity/" rel="tag">unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unity-python/" rel="tag">unity python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xlua-lua-framework/" rel="tag">xlua, lua, framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%B1%E5%BF%97/" rel="tag">励志</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%89%A9%E7%90%86%E5%BC%95%E6%93%8E/" rel="tag">物理引擎</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/" rel="tag">程序员</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/Assetbundle/" style="font-size: 10px;">Assetbundle</a> <a href="/tags/C/" style="font-size: 15.71px;">C#</a> <a href="/tags/IOC/" style="font-size: 10px;">IOC</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 14.29px;">Java</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Particle-System/" style="font-size: 10px;">Particle System</a> <a href="/tags/Shader/" style="font-size: 10px;">Shader</a> <a href="/tags/Slot-%E8%80%81%E8%99%8E%E6%9C%BA%EF%BC%8C%E6%B8%B8%E6%88%8F%E7%A0%94%E7%A9%B6/" style="font-size: 10px;">Slot, 老虎机，游戏研究</a> <a href="/tags/Spring/" style="font-size: 10px;">Spring</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/UGUI/" style="font-size: 11.43px;">UGUI</a> <a href="/tags/Unity/" style="font-size: 18.57px;">Unity</a> <a href="/tags/Unity-C/" style="font-size: 10px;">Unity, C#</a> <a href="/tags/Unity-UI%E6%A1%86%E6%9E%B6-UGUI/" style="font-size: 10px;">Unity, UI框架, UGUI</a> <a href="/tags/Unity%EF%BC%8CAssetBundle/" style="font-size: 10px;">Unity，AssetBundle</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/flask/" style="font-size: 10px;">flask</a> <a href="/tags/game/" style="font-size: 10px;">game</a> <a href="/tags/gameframework/" style="font-size: 10px;">gameframework</a> <a href="/tags/http-server/" style="font-size: 10px;">http.server</a> <a href="/tags/keyboard/" style="font-size: 10px;">keyboard</a> <a href="/tags/mysql/" style="font-size: 12.86px;">mysql</a> <a href="/tags/python/" style="font-size: 12.86px;">python</a> <a href="/tags/slot-%E8%80%81%E8%99%8E%E6%9C%BA-slot-game/" style="font-size: 10px;">slot, 老虎机, slot game</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/unity/" style="font-size: 17.14px;">unity</a> <a href="/tags/unity-python/" style="font-size: 10px;">unity python</a> <a href="/tags/xlua-lua-framework/" style="font-size: 11.43px;">xlua, lua, framework</a> <a href="/tags/%E5%8A%B1%E5%BF%97/" style="font-size: 10px;">励志</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">性能优化</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正则表达式</a> <a href="/tags/%E7%89%A9%E7%90%86%E5%BC%95%E6%93%8E/" style="font-size: 10px;">物理引擎</a> <a href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/" style="font-size: 10px;">程序员</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 11.43px;">算法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 20px;">设计模式</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 11.43px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">July 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/07/13/2025-07-13/">简单的服务器搭建</a>
          </li>
        
          <li>
            <a href="/2025/07/11/2025-07-11/">框架之日志管理系统</a>
          </li>
        
          <li>
            <a href="/2025/07/10/2025-07-12/">unity 一键打包</a>
          </li>
        
          <li>
            <a href="/2025/07/10/2025-07-10/">Unity UI框架总结</a>
          </li>
        
          <li>
            <a href="/2025/07/09/2025-07-09/">Unity 打android 包报错总结</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2025 OuyangWenyuan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>